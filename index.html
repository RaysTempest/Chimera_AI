<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Project Chimera v7.0 - Asisten AI Canggih</title>

    <!-- Pustaka Eksternal -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <!-- Font dan Ikon -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>
    <!-- DOMPurify for sanitizing rendered HTML and ACE editor for Canva editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.11.2/ace.min.js"></script>

    <style>
    :root { --sidebar-width: 260px; }
        :root {
            /* Spacing and size scale */
            --space-xxs: 4px; --space-xs: 8px; --space-sm: 12px; --space-md: 16px; --space-lg: 24px; --space-xl: 32px;
            --radius-sm: 6px; --radius-md: 10px; --radius-pill: 999px;
            --touch-size: 44px; --control-size: 40px;
            --shadow-soft: 0 6px 18px rgba(2,6,23,0.45); --shadow-medium: 0 10px 30px rgba(2,6,23,0.55);
            --break-mobile: 640px; --break-tablet: 1024px;
            /* Safe-area helper */
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);

            --bg-dark: #020617; --bg-light: #f8fafc;
            --surface-dark: #0f172a; --surface-light: #ffffff;
            --text-dark: #e2e8f0; --text-light: #0f172a;
            --border-dark: #1e293b; --border-light: #e2e8f0;
            --accent: #3b82f6; --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --font-body: 'Inter', sans-serif;
            --font-header: 'Orbitron', sans-serif;
        }
        /* Type scale and visual tokens */
        :root {
            --type-xxl: 1.6rem; /* h1 */
            --type-xl: 1.25rem; /* h2 */
            --type-lg: 1.05rem; /* h3 / section */
            --type-base: 0.95rem; /* body */
            --type-sm: 0.85rem;
            --muted: rgba(226,232,240,0.7);
            --bubble-user-bg: linear-gradient(90deg, rgba(37,99,235,0.12), rgba(59,130,246,0.06));
            --bubble-assistant-bg: rgba(255,255,255,0.02);
        }
        html.dark {
            color-scheme: dark;
            --bg-primary: var(--bg-dark); --surface-primary: var(--surface-dark);
            --text-primary: var(--text-dark); --border-primary: var(--border-dark);
        }
        html.light {
            color-scheme: light;
            --bg-primary: var(--bg-light); --surface-primary: var(--surface-light);
            --text-primary: var(--text-light); --border-primary: var(--border-light);
        }
        html.sunset {
            color-scheme: light;
            --bg-primary: #fff7ed; /* soft warm */
            --surface-primary: #fff1e6;
            --text-primary: #3b2f2f;
            --border-primary: #f1c5a3;
            --accent: #fb923c; --accent-hover: #f97316; --accent-glow: rgba(251,146,60,0.25);
        }
        body {
            font-family: var(--font-body); background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color 0.5s, color 0.5s;
            overflow: auto; font-size: 14px; line-height: 1.35;
        }
        h1, h2, h3 { font-family: var(--font-header); }
    h1 { font-size: var(--type-xxl); margin: 0; }
    h2 { font-size: var(--type-xl); margin: 0; }
    h3 { font-size: var(--type-lg); margin: 0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(128, 128, 128, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box;}
        .glass-effect {
            background: rgba(15, 23, 42, 0.62); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.04);
        }
        html.light .glass-effect { background: rgba(255, 255, 255, 0.7); }

        /* --- Animasi & Transisi --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(15px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInUpRight { from { opacity: 0; transform: translate(20px, 20px); } to { opacity: 1; transform: translate(0, 0); } }
        
        .toast-animation { animation: slideInUpRight 0.5s ease-out forwards; }
        
        @keyframes background-pan {
          0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
        }
        .animated-bg {
            background: linear-gradient(90deg, var(--bg-dark), #0f172a, var(--bg-dark));
            background-size: 200% 200%; animation: background-pan 15s ease infinite;
        }
        html.light .animated-bg {
             background: linear-gradient(90deg, var(--bg-light), #e2e8f0, var(--bg-light));
             background-size: 200% 200%;
        }
        html.sunset .animated-bg {
            background: linear-gradient(90deg, #ff9a8b, #ff6a88, #b06ab3);
            background-size: 200% 200%;
        }

    .markdown-content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .markdown-content th, .markdown-content td { border: 1px solid var(--border-primary); padding: 0.75rem; }
        .markdown-content th { background-color: var(--surface-primary); }
        .markdown-content pre { position: relative; }
        
        .streaming-cursor::after {
            content: '▍'; animation: blink 1s step-end infinite; color: var(--accent);
            margin-left: 6px; font-weight: 700;
        }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 5px rgba(239, 68, 68, 0); } }
        .api-status-pulse { animation: pulse-red 2s infinite; }
        @keyframes mic-pulse { 0%, 100% { color: var(--accent); } 50% { color: #f87171; } }
        .mic-listening { animation: mic-pulse 1.5s ease-in-out infinite; }
    /* Micro-interactions: touch feedback and tuned typing animation */
    .btn, button { transition: transform 120ms cubic-bezier(.2,.9,.2,1), box-shadow 120ms ease, opacity 120ms ease; }
    .btn:active, button:active { transform: scale(0.985); }
    .touch-press { transform: translateY(1px) scale(0.995); }
    .typing-indicator { display: inline-flex; gap: 6px; align-items: center; }
    .typing-indicator span { width: 6px; height: 6px; background: var(--muted); border-radius: 999px; opacity: 0.9; animation: dot 1s infinite ease-in-out; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.12s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.24s; }
    @keyframes dot { 0%, 80%, 100% { transform: translateY(0); opacity: 0.25 } 40% { transform: translateY(-6px); opacity: 1 } }
        /* Fullscreen helper: ensure app container covers full viewport when in fullscreen mode
           and reduce potential layout jumps by forcing width/height 100% */
        .in-fullscreen, :fullscreen #app-container, :-webkit-full-screen #app-container {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }

    /* Floating hamburger tools button */

    /* When sidebar-open class applied, add left margin to main to avoid overlap on wide screens */
    .sidebar-open #app-container main { margin-left: var(--sidebar-width); transition: margin-left 0.25s ease; }
    /* Modern button baseline */
    button { font-family: var(--font-body); cursor: pointer; }
    .btn { padding: calc(var(--space-xs)) calc(var(--space-sm)); border-radius: var(--radius-md); border: 1px solid transparent; background: linear-gradient(180deg,var(--accent),var(--accent-hover)); color: white; box-shadow: var(--shadow-soft); transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; font-size: 0.95rem; }
    .btn:active { transform: translateY(1px) scale(.998); }
    .btn-ghost { background: transparent; border-color: rgba(255,255,255,0.04); color: var(--text-primary); }
    /* Modal content wrapper must accept pointer events to ensure inner controls are interactive */
    #modal-content-wrapper { pointer-events: auto; outline: none; }
    #modal-backdrop { display:flex; align-items:center; justify-content:center; }
        @media (max-width: 768px) { .sidebar-open #app-container main { margin-left: 0; } }
    /* Sidebar inner scroll & segment styling */
    .sidebar-inner { display: flex; flex-direction: column; height: 100%; box-sizing: border-box; }
    aside#sidebar { background: linear-gradient(180deg, rgba(20,10,10,0.6), rgba(20,10,10,0.75)); }
    aside#sidebar .pt-4 { padding-top: 0; }
    .sidebar-top { flex: 0 0 auto; }
    .sidebar-middle { flex: 1 1 auto; overflow-y: auto; padding-right: 4px; }
    /* Conversation list pills */
    #conversation-history { padding: 8px 4px; }
    .conv-pill { display:flex; align-items:center; gap:0.6rem; padding:8px 10px; border-radius:10px; background: transparent; border:0; }
    .conv-pill .conv-radio { width:12px; height:12px; border-radius:50%; border:2px solid rgba(255,255,255,0.35); display:inline-block; flex-shrink:0; margin-right:6px }
    .conv-pill.active { background: rgba(255,255,255,0.02); }
    .conv-pill.active .conv-radio { background: rgba(37,99,235,0.95); border-color: rgba(37,99,235,0.9); }
    /* subtle separators like professional chat apps */
    #conversation-history .conversation-list-item + .conversation-list-item { border-top: 1px solid rgba(255,255,255,0.03); }
    .conv-pill .title { font-weight:600; font-size:0.95rem; color:rgba(255,255,255,0.95); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .conv-pill .subtitle { font-size:0.78rem; color:rgba(255,255,255,0.55); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .conversation-list-item { margin-bottom:6px; }
    /* Slim scrollbar for sidebar */
    aside#sidebar::-webkit-scrollbar, .sidebar-middle::-webkit-scrollbar { width:8px; }
    aside#sidebar::-webkit-scrollbar-thumb, .sidebar-middle::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.05); border-radius:6px; }
    /* polished, extra-compact sidebar visuals (Tailwind-friendly) */
    :root { --sidebar-width: 200px; }
    aside#sidebar { background: linear-gradient(180deg, rgba(12,12,14,0.92), rgba(20,20,24,0.96)); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
    aside#sidebar button { padding-top: 0.18rem; padding-bottom: 0.18rem; padding-left: 0.45rem; padding-right: 0.45rem; font-size: 0.86rem; display: flex; align-items: center; gap: 0.5rem; text-align: left; border-radius: 8px; color: rgba(255,255,255,0.92); }
    aside#sidebar .sidebar-section h3 { font-size: 0.78rem; margin-bottom: 0.16rem; color: rgba(255,255,255,0.62); font-weight:600; text-transform:uppercase; letter-spacing:0.6px; }
    .sidebar-top h2 { font-size: 0.95rem; margin-bottom: 0.18rem; font-weight:700; letter-spacing:0.4px; color: rgba(255,255,255,0.96); }
    aside#sidebar [data-lucide] { width: 24px; height: 24px; flex-shrink: 0; color: rgba(255,255,255,0.95); }
    .tool-label { display: inline-block; line-height: 1.02; color: rgba(255,255,255,0.92); }
    .tool-label .line-1 { display: block; font-weight: 600; font-size: 0.88rem; }
    .tool-label .line-2 { display: block; font-size: 0.72rem; color: rgba(255,255,255,0.64); }
    .sidebar-middle .sidebar-section button { margin-bottom: 0.06rem; padding-top: 0.14rem; padding-bottom: 0.14rem; }
    .sidebar-section { padding: 0.18rem 0; border-top: 1px solid rgba(255,255,255,0.02); }
    aside#sidebar button:hover { background: rgba(255,255,255,0.02); transform: translateX(2px); }
    aside#sidebar button:focus { box-shadow: 0 0 0 3px rgba(37,99,235,0.12); outline: none; }
    .sidebar-bottom { flex: 0 0 auto; }
    /* Keep main content offset consistent with compact sidebar */
    .sidebar-open #app-container main { margin-left: var(--sidebar-width); transition: margin-left 0.2s ease; }
    </style>
    <style>
    /* Mobile safety and precision fixes */
    html, body { overflow-x: hidden; }
    /* Ensure chat container leaves room for floating composer on mobile */
    #chat-container { padding-bottom: 88px; }
    @media (max-width: 640px) {
        #chat-container { padding-left: 8px; padding-right: 8px; padding-bottom: 140px; }
        footer { padding: 8px 10px; left: 8px; right: 8px; bottom: calc(8px + env(safe-area-inset-bottom)); }
        /* keep send and mic inside composer (no fixed floats) */
        #send-button, #mic-btn { position: static !important; right: auto !important; left: auto !important; bottom: auto !important; z-index: auto !important; }
        .chat-bubble { word-break: break-word; }
        aside#sidebar { transition: transform 0.22s cubic-bezier(.4,0,.2,1); }
        .sidebar-open aside#sidebar { box-shadow: 0 8px 32px rgba(0,0,0,0.25); }
        /* composer should expand to full width inside footer */
        footer .composer { width: 100%; display: flex; align-items: center; gap: 8px; }
        footer .composer .flex-1, footer .composer textarea { width: 100%; }
    }
    /* Thinking / appearance animations */
    .typing-indicator { display:inline-flex; gap:6px; align-items:center; }
    .typing-indicator span { display:inline-block; width:8px; height:8px; border-radius:999px; background:var(--accent); opacity:0.3; transform: translateY(0); }
    .typing-indicator span:nth-child(1) { animation: dot 1.05s infinite 0s; }
    .typing-indicator span:nth-child(2) { animation: dot 1.05s infinite 0.18s; }
    .typing-indicator span:nth-child(3) { animation: dot 1.05s infinite 0.36s; }
    @keyframes dot { 0% { opacity:0.18; transform: translateY(0); } 40% { opacity:1; transform: translateY(-6px); } 100% { opacity:0.18; transform: translateY(0); } }

    .message-thinking { opacity: 0.95; filter: blur(0.0px); }
    .message-thinking .markdown-content { opacity: 0.92; }
    .message-thinking .markdown-content::after { content: ''; display:block; height:8px; margin-top:6px; border-radius:4px; background: linear-gradient(90deg, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 75%); background-size:200% 100%; animation: shimmer 1.2s linear infinite; }

    @keyframes shimmer { 0% { background-position: -150% 0; } 100% { background-position: 150% 0; } }

    .message-appear { animation: messageAppear 320ms cubic-bezier(.2,.9,.28,1) both; }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(8px) scale(.995); } to { opacity: 1; transform: translateY(0) scale(1); } }

    /* when streaming, show subtle cursor/glow */
    .streaming-cursor { color: var(--accent); font-weight:700; margin-left:6px; }
    /* Composer specifics */
    .composer { display: flex; align-items: center; gap: 8px; }
    .composer textarea { font-size: 15px; line-height: 1.25; max-height: 160px; }
    .composer button { min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center; }
    @media (max-width: 640px) {
        footer { padding-left: 8px; padding-right: 8px; }
        .composer { padding: 6px; }
    }
    </style>
    <style>
    /* Mobile-compact helper styles activated via JS (class mobile-compact on <html>) */
    html.mobile-compact footer { position: fixed; left: 6px; right: 6px; bottom: calc(6px + env(safe-area-inset-bottom)); border-radius: 999px; padding: 8px; z-index: 60; box-shadow: 0 8px 28px rgba(2,6,23,0.6); }
    html.mobile-compact #chat-container { padding-left: 8px; padding-right: 8px; }
    html.mobile-compact .chat-bubble { max-width: calc(100% - 48px); border-radius: 14px; }
    html.mobile-compact .chat-bubble.user { margin-left: auto; margin-right: 6px; }
    html.mobile-compact .chat-bubble.assistant { margin-left: 6px; margin-right: auto; }
    html.mobile-compact #send-button { position: fixed; right: 18px; bottom: calc(18px + env(safe-area-inset-bottom)); z-index: 70; width: 56px; height: 56px; border-radius: 999px; }
    html.mobile-compact #user-input { padding-right: 84px !important; }
    html.mobile-compact header { padding: 10px 12px; }
    html.mobile-compact .welcome-prompt-btn { padding: 12px; }
    html.mobile-compact .prose { font-size: 0.98rem; }
    </style>
    <style>
    /* Stronger mobile chat styling to mimic modern chat apps (Gemini/ChatGPT-like) */
    @media (max-width: 640px) {
        /* Header: hamburger left, centered title */
        header { display: flex; align-items: center; justify-content: center; position: relative; padding: 10px 12px; }
        #sidebar-toggle { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); display: inline-flex; z-index: 70; }
        #reset-layout-btn, #export-single-chat-btn { display: none !important; }
        header h1#chat-title { margin: 0 auto; text-align: center; font-size: 16px; font-weight: 600; }

        /* Composer card: floating rounded pill with gentle shadow */
        footer { padding: 10px; left: 8px; right: 8px; bottom: calc(8px + env(safe-area-inset-bottom)); position: fixed; z-index: 80; border-radius: 999px; display: flex; align-items: center; box-shadow: 0 10px 30px rgba(2,6,23,0.5); background: linear-gradient(180deg, rgba(6,8,12,0.9), rgba(10,12,16,0.95)); }
        footer .flex-1 { margin: 0 8px; }
        #user-input { background: transparent; color: inherit; border: none; box-shadow: none; padding: 12px 56px 12px 16px; border-radius: 999px; }
        #user-input:focus { outline: none; box-shadow: none; }

        /* Floating send button inside composer */
        #send-button { position: absolute; right: 18px; bottom: calc(14px + env(safe-area-inset-bottom)); z-index: 90; width: 56px; height: 56px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; }

    /* Message bubbles: full width, tighter spacing and visual style like modern chat apps */
    .flex.gap-3 { align-items: flex-end; }
    .flex.gap-3 > .border { max-width: calc(100% - 88px); display: block; padding: 10px 14px; border-radius: 14px; }
    .flex.justify-end .border { margin-left: auto; margin-right: 8px; background: linear-gradient(90deg, rgba(59,130,246,0.15), rgba(37,99,235,0.07)); border: 1px solid rgba(37,99,235,0.12); }
    .flex.justify-start .border { margin-left: 8px; margin-right: auto; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.04); }
    .flex.gap-3 > .markdown-content p { margin: 0.2rem 0; line-height: 1.35; }
    .markdown-content { color: rgba(226,232,240,0.95); font-size: 15px; }

        /* Remove extra margins on chat container */
        #chat-container { padding-left: 8px; padding-right: 8px; }

    /* Timestamps/controls inside bubbles are small and subtle */
    .group .text-xs { display: none !important; }
    .chat-bubble .markdown-content .time { font-size: 11px; color: rgba(255,255,255,0.36); }
    }
    </style>
    <style>
    /* Fine-tune colors and shadows for mobile to match Gemini/ChatGPT aesthetic */
    @media (max-width: 640px) {
        :root { --mobile-accent: #2f6ef7; --mobile-user-bg: linear-gradient(90deg,#2f6ef7,#1f4fe6); }
        .chat-bubble.user { background: var(--mobile-user-bg); color: white; border: none; box-shadow: 0 8px 20px rgba(31,79,230,0.12); }
        .chat-bubble.assistant { background: rgba(255,255,255,0.02); color: #e6eefc; border: 1px solid rgba(255,255,255,0.04); box-shadow: none; }
        header h1#chat-title { font-weight: 700; letter-spacing: 0.2px; }
        #user-input { font-size: 15px; line-height: 1.25; }
        #send-button { background: linear-gradient(180deg,var(--mobile-accent),#175ce6); box-shadow: 0 12px 30px rgba(23,92,230,0.18); }
        /* Slightly reduce spacing between messages */
        #chat-container > div { margin-bottom: 10px; }
    }
    </style>
    <style>
    /* Responsive improvements for mobile, tablet, desktop */
    /* Helper translate class used by JS to hide sidebar on small screens */
    .-translate-x-full { transform: translateX(-110%) !important; }

    /* Modal responsive: ensure modal content fits small screens and becomes nearly fullscreen */
    #modal-content-wrapper > div {
        max-width: 980px;
        width: 100%;
        margin: 0 auto;
    }

    @media (max-width: 1024px) {
        #modal-content-wrapper > div { max-width: 92%; }
    }

    @media (max-width: 640px) {
    /* Off-canvas sidebar for phones */
    aside#sidebar { position: fixed; left: 0; top: 0; bottom: 0; height: 100vh; width: min(86vw, 320px); z-index: 60; transform: translateX(-110%); transition: transform 0.22s ease; box-shadow: 0 12px 40px rgba(2,6,23,0.6); }
    .sidebar-open aside#sidebar { transform: translateX(0) !important; }

        /* Make modal nearly full-screen on mobile */
        #modal-content-wrapper { padding: 8px; }
        #modal-content-wrapper > div { width: 100%; max-width: 98%; height: calc(100vh - 24px); border-radius: 12px; overflow: auto; }

    /* Touch-friendly controls */
    button, .btn { min-height: 48px; padding-left: 12px; padding-right: 12px; }
    textarea#user-input { font-size: 16px; padding: 12px 64px 12px 16px; border-radius: 999px; }
    #send-button { width:56px; height:56px; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); box-shadow: 0 8px 20px rgba(37,99,235,0.2); }
    #mic-btn { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); }

    /* Smaller headers and tighter spacing */
    header { padding: 8px 10px; display:flex; align-items:center; justify-content:center; }
    header .glass-effect { width: 100%; display:flex; align-items:center; justify-content:center; padding: 8px 12px; }
    header h1#chat-title { text-align:center; font-size: 1rem; }
    /* hide some desktop-only controls to reduce clutter */
    #export-single-chat-btn, #sidebar-close, .conv-pill .delete-chat-btn { display: none !important; }
    .sidebar-top .text-2xl { font-size: 1.06rem; }
    .tool-label .line-1 { font-size: 0.94rem; }
    .tool-label .line-2 { font-size: 0.72rem; }
    /* Chat bubbles: full width, compact, no avatars to maximize space */
    .chat-bubble { padding: 10px 12px; max-width: calc(100% - 64px); margin-left: 8px; margin-right: 8px; border-radius: 12px; }
    .chat-bubble.user { margin-left: auto; margin-right: 8px; border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
    .chat-bubble.assistant { margin-right: auto; margin-left: 8px; border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
    .w-8.h-8, .avatar, .conv-radio { display: none !important; }
    /* Welcome prompt buttons full-width */
    .welcome-prompt-btn { display:block; width:100%; }
    .welcome-prompt-btn strong { display:block; font-size:1rem; }
    .welcome-prompt-btn p { margin:0; }
    /* Ensure timestamps small and unobtrusive */
    .chat-bubble .text-xs { display:none; }
    }

    /* Medium screens (tablets) tweaks */
    @media (min-width: 641px) and (max-width: 1024px) {
        aside#sidebar { width: 220px; }
        :root { --sidebar-width: 220px; }
        #modal-content-wrapper > div { max-width: 820px; }
    }
    </style>
    <style>
    /* Mobile-specific layout tweaks to keep input visible and footer fixed */
    @media (max-width: 640px) {
    footer { position: fixed; left: 0; right: 0; bottom: 0; z-index: 40; background: linear-gradient(180deg, rgba(8,10,14,0.9), rgba(8,10,14,0.95)); padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        #chat-container { padding-bottom: 88px; /* leave space for fixed footer */ }
        #app-container { padding-bottom: env(safe-area-inset-bottom); }
        /* Ensure Ace editor and preview stack vertically on mobile */
        #ace-wrapper { height: 240px; }
        .w-1\/2 { width: 100% !important; }
        .h-full { height: auto !important; }
        #canva-preview { min-height: 220px; }
        /* Reduce heavy shadows on mobile for performance */
        .shadow-2xl { box-shadow: 0 6px 18px rgba(2,6,23,0.45) !important; }
        footer .flex-1 { line-height: 1.15; }
    }
    </style>
    <style>
    /* Strong mobile composer overrides to avoid float/overlap issues on phones */
    @media (max-width: 640px) {
        /* Target our mobile composer container explicitly */
    #mobile-composer { display: flex !important; align-items: center !important; gap: var(--space-xs) !important; width: calc(100% - (var(--space-sm) * 1)) !important; margin: 0 auto; box-sizing: border-box; border-radius: var(--radius-pill); padding-left: var(--space-sm); padding-right: var(--space-sm); }

        /* Ensure controls are inline and not absolutely positioned */
    #mobile-composer label[for="image-upload-input"],
    #mobile-composer #mic-btn,
    #mobile-composer #send-button { position: static !important; right: auto !important; left: auto !important; bottom: auto !important; transform: none !important; z-index: auto !important; }

        /* Increase touch targets and equalize sizes */
    #mobile-composer label[for="image-upload-input"],
    #mobile-composer #mic-btn,
    #mobile-composer #send-button { min-width:var(--touch-size); min-height:var(--touch-size); width:var(--touch-size); height:var(--touch-size); display:inline-flex; align-items:center; justify-content:center; border-radius: var(--radius-pill); }

        /* Make textarea take remaining space and keep proper padding */
        #mobile-composer .flex-1 { flex: 1 1 auto; min-width:0; }
    #mobile-composer #user-input { width:100%; padding: calc(var(--space-xs)) calc(var(--space-sm)); margin:0; font-size:15px; line-height:1.2; border-radius: calc(var(--radius-pill)); }

        /* Increase chat bottom padding to avoid overlap when keyboard open */
    #chat-container { padding-bottom: calc(110px + var(--safe-area-bottom)) !important; }

        /* Soften shadows and ensure composer background blends with footer */
        footer { padding-left: 10px; padding-right: 10px; }
    }
    </style>
    <style>
    /* Overall professional polish */
    :root { --ui-surface: #0b1220; --ui-muted: #9aa4b2; --ui-accent: #2563eb; --card-bg: rgba(255,255,255,0.03); }
    body { font-size: 14px; }
    header .glass-effect { padding: 12px 16px; }
    /* Chat container & bubbles */
    #chat-container { padding: 18px; }
    .markdown-content p { margin: 0.45rem 0; color: var(--ui-muted); }
    .group .border { border-color: rgba(255,255,255,0.04) !important; }
    /* fallback: target elements marked as surface-primary */
    .group .surface-primary, .group .bg-surface-primary { background-color: rgba(8,10,14,0.6) !important; }
        .chat-bubble { padding: calc(var(--space-sm)) calc(var(--space-md)); border-radius: var(--radius-md); line-height:1.35; color: var(--text-primary); }
        .chat-bubble.user { background: var(--bubble-user-bg); border: 1px solid rgba(59,130,246,0.06); box-shadow: none; }
        .chat-bubble.assistant { background: var(--bubble-assistant-bg); border: 1px solid rgba(255,255,255,0.03); }
    /* Reduce footers & input size for compact look */
    footer { padding: 10px; }
    textarea#user-input { padding: 8px 40px 8px 12px; border-radius: 999px; font-size: 0.94rem; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03); }
    #send-button { padding: 8px; width: 40px; height: 40px; border-radius: 999px; }
    /* Buttons and focus-visible states */
    :focus:not(:focus-visible) { outline: none; }
    :focus-visible { outline: 2px solid rgba(37,99,235,0.22); outline-offset: 3px; border-radius: 6px; }
    button:focus { outline: none; }
    aside#sidebar button { transition: background-color 0.12s ease, transform 0.12s ease; }
    /* Tidy icons alignment */
    aside#sidebar i[data-lucide] { display: inline-flex; align-items: center; justify-content: center; }
    /* Muted meta text */
    .text-gray-400, .text-gray-300 { color: var(--ui-muted) !important; }
    /* header minimal like ChatGPT/Gemini */
    header h1#chat-title { font-size: 15px; font-weight:600; color: #e6eefc; }
    header { padding: 10px 12px; }
    /* Slightly reduce shadow for a flatter, modern look */
    .shadow-2xl { box-shadow: 0 10px 30px rgba(2,6,23,0.55) !important; }
    /* Chat bubble polish */
    .chat-bubble { font-size: 0.95rem; color: var(--text-primary); }
    .chat-bubble.user { background: linear-gradient(90deg, rgba(37,99,235,0.12), rgba(59,130,246,0.05)); border: 1px solid rgba(59,130,246,0.08); }
    .chat-bubble.assistant { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.03); }
    .chat-bubble .markdown-content p { color: rgba(226,232,240,0.9); }
    .chat-bubble .markdown-content a { color: var(--accent); text-decoration: underline; }
    .avatar { width:36px; height:36px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; }
    .user .avatar { background: linear-gradient(180deg,#1e40af,#3b82f6); }
    .assistant .avatar { background: rgba(255,255,255,0.04); }
    </style>
</head>
<body class="antialiased">

    

    <div id="app-container" class="h-screen w-screen flex flex-col md:flex-row animated-bg">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden md:hidden transition-opacity duration-300" style="opacity:0; pointer-events:none;"></div>
        
        <aside id="sidebar" class="bg-black/30 h-full flex flex-col" style="width:var(--sidebar-width); transition: transform 0.25s ease;" role="navigation" aria-label="Sidebar tools">
            <div class="sidebar-inner h-full flex flex-col p-4">
                <div class="sidebar-top">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex flex-col">
                            <span class="text-2xl font-extrabold tracking-tight" style="letter-spacing:1px">CHIMERA</span>
                            <span class="text-sm text-gray-400 mt-1">v1</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="multi-select-toggle" class="px-2 py-1 rounded-md bg-transparent hover:bg-white/10 text-sm">Select</button>
                            <button id="sidebar-close" class="p-1 rounded-full hover:bg-white/10 transition-colors"><i data-lucide="x"></i></button>
                        </div>
                    </div>
                    <button id="new-chat-btn" class="flex items-center justify-center gap-3 w-full px-4 py-2 rounded-xl bg-[var(--accent)] text-white font-semibold hover:bg-[var(--accent-hover)] transition-all duration-150">
                        <i data-lucide="plus" class="w-5 h-5"></i><span class="text-sm">Obrolan Baru</span>
                    </button>
                    <div id="bulk-action-bar" class="mt-3 hidden items-center gap-2">
                        <button id="bulk-delete-btn" class="px-2 py-1 rounded-md bg-red-600 text-white">Hapus</button>
                        <button id="bulk-export-btn" class="px-2 py-1 rounded-md bg-gray-600 text-white">Ekspor</button>
                        <button id="bulk-pin-btn" class="px-2 py-1 rounded-md bg-yellow-500 text-black">Pin/Unpin</button>
                        <button id="bulk-cancel-btn" class="px-2 py-1 rounded-md bg-transparent border border-[var(--border-primary)]">Batal</button>
                    </div>
                </div>

                <div class="sidebar-middle mt-3 flex-1 overflow-y-auto">
                    <div id="conversation-history" class="space-y-2"></div>
                    <div class="mt-4 p-2">
                        <input id="search-input" placeholder="Cari percakapan..." class="w-full p-2 rounded-md bg-transparent border border-[var(--border-primary)] focus:outline-none" />
                    </div>

                    <div class="mt-2 space-y-2 sidebar-section px-2">
                        <button id="fullscreen-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="maximize"></i> Layar Penuh</button>
                        <button id="api-key-button" class="flex items-center justify-between w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><span class="flex items-center gap-3"><i data-lucide="key-round"></i> API Key</span><span id="api-key-status" class="w-2.5 h-2.5 rounded-full transition-colors"></span></button>
                        <button id="settings-button" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="settings"></i> Pengaturan</button>
                    </div>

                    <div class="mt-3 space-y-2 sidebar-section px-2">
                        <h3 class="text-sm text-gray-400">Alat Tambahan</h3>
                        <button id="deep-research-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="search"></i><span class="tool-label"><span class="line-1">Deep Research</span></span></button>
                        <button id="learning-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="book-open"></i><span class="tool-label"><span class="line-1">Pembelajaran</span><span class="line-2">Terpadu</span></span></button>
                        <button id="canva-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="edit-3"></i><span class="tool-label"><span class="line-1">Canva</span><span class="line-2">Editor & Preview</span></span></button>
                        <button id="plugin-store-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="box" ></i><span class="tool-label"><span class="line-1">Plugin Store</span></span></button>
                        <button id="collab-share-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="share-2"></i><span class="tool-label"><span class="line-1">Share /</span><span class="line-2">Kolaborasi</span></span></button>
                        <button id="dashboard-switch-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="layout-dashboard"></i><span class="tool-label"><span class="line-1">Switch to</span><span class="line-2">Dashboard</span></span></button>
                        <button id="workflow-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="layers"></i><span class="tool-label"><span class="line-1">Workflow</span><span class="line-2">Builder</span></span></button>
                        <button id="templates-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="grid"></i><span class="tool-label"><span class="line-1">Template</span><span class="line-2">Library</span></span></button>
                        <button id="badges-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="award"></i><span class="tool-label"><span class="line-1">Badges</span></span> <span id="badge-count" class="ml-auto text-xs text-yellow-300"></span></button>
                    </div>
                </div>

                <div class="sidebar-bottom pt-4 border-t border-[var(--border-primary)]">
                    <div class="p-2">
                        <label class="flex items-center gap-2 text-sm"> <input type="checkbox" id="memory-toggle-input" class="h-4 w-4"> <span>Aktifkan Memori AI</span></label>
                    </div>
                    <div class="p-2">
                        <button id="theme-toggle" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="sun"></i> <span id="theme-text">Mode Terang</span></button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative overflow-hidden">
             <header class="flex items-center justify-between p-4 glass-effect m-2 md:m-4 mb-0 rounded-t-2xl rounded-b-none border-b border-[var(--border-primary)] shrink-0">
                <h1 id="chat-title" class="text-lg font-semibold truncate pr-4">Percakapan Baru</h1>
                <div class="flex items-center gap-2">
                    <button id="export-single-chat-btn" class="px-3 py-1 rounded-md hover:bg-white/10">Ekspor Chat</button>
                    <button id="reset-layout-btn" title="Reset Tata Letak" class="px-3 py-1 rounded-md hover:bg-white/10">Reset Layout</button>
                </div>
                <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-white/20 transition-all md:hidden"><i data-lucide="menu"></i></button>
             </header>
            <div class="flex-1 flex flex-col glass-effect m-2 md:m-4 mt-0 rounded-b-2xl overflow-hidden shadow-2xl">
                <div id="chat-container" class="flex-1 p-4 sm:p-6 space-y-6 overflow-y-auto"></div>
                <footer class="p-3 border-t border-[var(--border-primary)] shrink-0">
                    <div id="stop-generation-container" class="text-center hidden mb-2">
                         <button id="stop-generation-btn" class="w-full px-4 py-1.5 text-sm border border-yellow-500/50 text-yellow-300 rounded-lg hover:bg-yellow-500/20 transition-colors flex items-center gap-2">
                            <i data-lucide="square" class="w-4 h-4"></i> Hentikan Generasi
                         </button>
                    </div>
                    <div id="image-preview-container" class="flex gap-2 items-center mb-2"></div>

                    <!-- Mobile-friendly composer: file | mic | input | send -->
                        <div id="mobile-composer" class="relative flex items-center gap-2 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-full px-2 py-2 shadow-sm" style="align-items:center">
                        <label for="image-upload-input" class="flex items-center justify-center p-2 rounded-full hover:bg-white/5 cursor-pointer transition-colors text-gray-300" title="Unggah gambar">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </label>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">

                        <button id="mic-btn" class="p-2 rounded-full text-gray-300 hover:text-white hover:bg-white/5 transition-colors" title="Input suara" aria-label="microphone">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>

                        <div class="flex-1 mx-1">
                            <textarea id="user-input" placeholder="Ketik pesan..." class="w-full p-2 pl-3 pr-3 border-none bg-transparent focus:outline-none resize-none" rows="1" aria-label="Pesan pengguna"></textarea>
                        </div>

                        <button type="submit" id="send-button" class="ml-1 flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-600 text-white p-3 rounded-full shadow-lg transition-transform transform hover:scale-105" aria-label="Kirim pesan">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </footer>
            </div>
        </main>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none z-50 p-4 transition-opacity duration-300"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>
    
    <script>
    // Smoke-check + icons refresh helper
    (function(){
        function showToast(msg, timeout=3000){
            try{
                const tc = document.getElementById('toast-container');
                if(!tc) return;
                const el = document.createElement('div');
                el.className = 'px-3 py-2 rounded-md bg-black/80 text-white text-sm shadow-md';
                el.textContent = msg;
                tc.appendChild(el);
                setTimeout(()=> el.remove(), timeout);
            }catch(e){ console.warn('toast failed', e); }
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            const required = ['chat-container','user-input','send-button','mic-btn','image-upload-input','mobile-composer'];
            const missing = required.filter(id => !document.getElementById(id));
            if(missing.length) {
                console.warn('Smoke-check: missing DOM elements', missing);
                showToast('Warning: missing elements: ' + missing.join(', '), 6000);
            } else {
                console.log('Smoke-check: all core elements present.');
                showToast('UI ready — basic checks OK', 2200);
            }

            // Safe lucide icon re-init (if lucide is loaded from CDN)
            try{
                if(window.lucide && typeof window.lucide.replace === 'function'){
                    window.lucide.replace();
                    console.log('Lucide icons re-initialized');
                }
            }catch(e){ console.warn('Lucide init failed', e); }
        });
    })();
    // ===================================================================================
    // Project Chimera v7.0 - Ultimate AI Assistant
    // Perbaikan: Tombol Salin Kode, Judul Chat Dinamis, UI Polish, Persona Baru
    // ===================================================================================
    document.addEventListener('DOMContentLoaded', () => {

        const dom = {};
        const state = {
            audioContext: null,
            currentPlayingAudio: null,
        };

        const personas = {
            default: "Anda adalah Asisten AI canggih dan ramah bernama Chimera. Jawaban Anda harus dalam Bahasa Indonesia yang jelas dan informatif. Anda terhubung ke internet untuk data real-time via Google Search. Manfaatkan format markdown secara ekstensif (tabel, list, blok kode, dll). Anda adalah ahli di berbagai bidang: matematika, fisika, biologi, sejarah, dan pengetahuan umum. Selalu tampilkan rumus matematika yang kompleks menggunakan sintaks LaTeX (`$$...$$` untuk block atau `$...$` untuk inline). Jika diminta membuat diagram, gunakan sintaks mermaid. Anda juga bisa menganalisis gambar.",
            coder: "Anda adalah programmer ahli dan arsitek perangkat lunak senior. Berikan jawaban yang jelas, efisien, dengan contoh kode yang bersih dan best-practice. Jelaskan konsep kompleks secara sederhana. Selalu gunakan pencarian untuk dokumentasi dan versi library terbaru. Format kode dengan benar menggunakan markdown dan sebutkan bahasanya.",
            writer: "Anda adalah penulis kreatif dan editor sastra. Gunakan bahasa yang kaya, kiasan, dan imajinatif. Ciptakan narasi yang menarik dan puisi yang menggugah. Gunakan pencarian untuk riset mendalam dan mencari inspirasi.",
            scientist: "Anda adalah seorang ilmuwan dan peneliti. Jelaskan topik ilmiah dengan akurasi, objektivitas, dan menggunakan analogi yang mudah dipahami. Prioritaskan data dari sumber terpercaya melalui pencarian. Gunakan LaTeX untuk semua formula.",
            academic: "Anda adalah seorang akademisi dan peneliti. Berikan penjelasan yang mendalam, terstruktur, dan berbasis bukti. Sertakan referensi jika memungkinkan dari hasil pencarian. Analisis topik dari berbagai sudut pandang dan jelaskan konsep-konsep yang rumit dengan presisi.",
            historian: "Anda adalah seorang sejarawan dan pakar sejarah dunia. Berikan jawaban yang detail, kronologis, dan berbasis fakta dari sumber-sumber yang terverifikasi melalui pencarian. Jelaskan konteks historis dan hubungan sebab-akibat dari setiap peristiwa."
        };

        // --- SETUP & INITIALIZATION ---

        function setupDOM() {
            const ids = ['app-container', 'sidebar', 'sidebar-toggle', 'sidebar-close', 'sidebar-overlay', 'chat-container', 'user-input', 'send-button', 'mic-btn', 'new-chat-btn', 'conversation-history', 'fullscreen-btn', 'api-key-button', 'api-key-status', 'settings-button', 'theme-toggle', 'theme-text', 'image-upload-input', 'image-preview-container', 'stop-generation-container', 'stop-generation-btn', 'modal-backdrop', 'toast-container', 'chat-title', 'search-input', 'deep-research-btn', 'learning-btn', 'canva-btn', 'plugin-store-btn', 'collab-share-btn', 'dashboard-switch-btn', 'workflow-btn', 'templates-btn', 'badges-btn', 'badge-count', 'multi-select-toggle', 'bulk-action-bar', 'bulk-delete-btn', 'bulk-export-btn', 'bulk-pin-btn', 'bulk-cancel-btn', 'export-single-chat-btn'];
            ids.forEach(id => {
                const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                dom[camelCaseId] = document.getElementById(id);
            });
            // accessibility: ensure fullscreen button has ARIA attributes
            try {
                if (dom.fullscreenBtn) {
                    dom.fullscreenBtn.setAttribute('role', 'button');
                    dom.fullscreenBtn.setAttribute('aria-pressed', 'false');
                    dom.fullscreenBtn.setAttribute('aria-label', 'Toggle fullscreen');
                }
            } catch(e) { /* ignore */ }
            // ...existing code...
        }

        // close sidebar on Escape key for accessibility (kept)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                try { if (!dom.sidebar.classList.contains('-translate-x-full')) { closeSidebar(); document.documentElement.classList.remove('sidebar-open'); } } catch(e){}
            }
        });

        function initState() {
            try {
                state.apiKey = localStorage.getItem('chimera_apiKey') || null;
                state.conversations = JSON.parse(localStorage.getItem('chimera_conversations') || '{}');
                state.activeConversationId = localStorage.getItem('chimera_activeConversationId') || null;
                state.currentTheme = localStorage.getItem('chimera_theme') || 'dark';
                
                const savedSettings = JSON.parse(localStorage.getItem('chimera_settings'));
                state.settings = { persona: 'default', customSystemPrompt: '', ...savedSettings };
            } catch (e) {
                console.error("Failed to initialize state from localStorage:", e);
                // Reset to defaults if localStorage is corrupt
                state.apiKey = null; state.conversations = {}; state.activeConversationId = null; 
                state.currentTheme = 'dark'; state.settings = { persona: 'default', customSystemPrompt: '' };
            }
            
            state.isGenerating = false;
            state.abortController = null;
            state.uploadedImage = null;
            state.multiSelectActive = false;
            state.selectedConversations = {};

            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (window.SpeechRecognition) {
                state.recognition = new SpeechRecognition();
                state.recognition.continuous = false;
                state.recognition.lang = 'id-ID';
                state.recognition.interimResults = false;
            } else {
                state.recognition = null;
                if(dom.micBtn) dom.micBtn.style.display = 'none';
            }
        }
        
        function init() {
            setupDOM();
            initState();
            lucide.createIcons();
            setupEventListeners();
            updateThemeUI();
            updateApiKeyUI();
            loadConversations();
            
            if (!state.activeConversationId || !state.conversations[state.activeConversationId]) {
                createNewConversation();
            } else {
                renderConversation(state.activeConversationId);
            }
            
            mermaid.initialize({ startOnLoad: false, theme: state.currentTheme, securityLevel: 'loose' });
            
            if (!state.apiKey) {
                setTimeout(() => {
                    showApiKeyModal();
                    showToast('Selamat datang! Masukkan API Key Anda untuk memulai.', 'warning');
                }, 1000);
            }
            // Defensive: ensure no overlays/blockers remain from earlier sessions or partial fullscreen toggles
            try { sanitizeOverlays(); } catch(e) { /* ignore */ }
            try { applyMobileLayout(); } catch(e) { /* ignore */ }
        }

            // Apply mobile-specific layout adjustments (compact chat composer, full-width bubbles)
            function applyMobileLayout() {
                try {
                    const isMobile = window.innerWidth <= 640;
                    // Floating composer: move footer out of normal flow on mobile
                    if (isMobile) {
                        document.documentElement.classList.add('mobile-compact');
                        // ensure chat has bottom padding so messages aren't hidden
                        const chat = document.getElementById('chat-container'); if (chat) chat.style.paddingBottom = '120px';
                        // ensure sidebar hidden by default
                        if (dom.sidebar) dom.sidebar.classList.add('-translate-x-full');
                        if (dom.sidebarOverlay) { dom.sidebarOverlay.classList.add('hidden'); dom.sidebarOverlay.style.pointerEvents = 'none'; }
                    } else {
                        document.documentElement.classList.remove('mobile-compact');
                        const chat = document.getElementById('chat-container'); if (chat) chat.style.paddingBottom = '';
                        if (dom.sidebar && !document.documentElement.classList.contains('sidebar-open')) dom.sidebar.classList.remove('-translate-x-full');
                        if (dom.sidebarOverlay) { dom.sidebarOverlay.classList.add('hidden'); dom.sidebarOverlay.style.pointerEvents = 'none'; }
                    }
                } catch(e) { console.warn('applyMobileLayout failed', e); }
            }
        
        // --- CONVERSATION MANAGEMENT ---

        // Defensive helper: force-hide overlays and clear pointer-events that may block input on mobile
        function sanitizeOverlays() {
            try {
                // ensure DOM refs exist
                if (dom.sidebarOverlay) {
                    dom.sidebarOverlay.classList.add('hidden');
                    dom.sidebarOverlay.style.pointerEvents = 'none';
                    // also clear any inline opacity/manipulation
                    dom.sidebarOverlay.style.opacity = '';
                }
                if (dom.modalBackdrop) {
                    // if a modal is not expected to be open, force-backdrop hidden
                    if (!dom.modalBackdrop.dataset.modalOpen) {
                        dom.modalBackdrop.classList.add('opacity-0', 'pointer-events-none');
                        try { dom.modalBackdrop.style.pointerEvents = 'none'; } catch(e){}
                        try { dom.modalBackdrop.style.opacity = ''; } catch(e){}
                    } else {
                        // make sure modal wrapper receives pointer events
                        const wrapper = dom.modalBackdrop.querySelector('#modal-content-wrapper');
                        if (wrapper) { wrapper.style.pointerEvents = 'auto'; wrapper.setAttribute('tabindex','-1'); }
                        try { dom.modalBackdrop.style.pointerEvents = 'auto'; } catch(e){}
                    }
                }
                // Ensure sidebar is off-canvas on small devices
                try { if (window.innerWidth <= 640 && dom.sidebar) dom.sidebar.classList.add('-translate-x-full'); } catch(e){}

                // One-time mobile UI polish injection (keeps changes minimal and safe)
                if (!document.documentElement.dataset.mobilePolishApplied) {
                    const s = document.createElement('style');
                    s.id = 'mobile-polish-styles';
                    s.textContent = `
                        @media (max-width: 640px) {
                            footer { position: fixed; bottom: env(safe-area-inset-bottom); left: 0; right: 0; z-index: 40; background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.45)); }
                            #chat-container { padding-bottom: 120px; }
                            #user-input { padding-right: 4.25rem !important; }
                            #send-button { position: absolute; right: 0.75rem; bottom: 0.75rem; transform: none; }
                            .prose { word-break: break-word; }
                            .glass-effect { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
                        }
                    `;
                    document.head.appendChild(s);
                    document.documentElement.dataset.mobilePolishApplied = '1';
                }
            } catch(e) { console.warn('sanitizeOverlays failed', e); }
        }

        // Restore default layout: clear mobile classes, remove inline styles that may break layout,
        // move sidebar back to left, hide overlays, and re-render icons.
        function restoreDefaultLayout() {
            try {
                // clear applied mobile compact class
                document.documentElement.classList.remove('mobile-compact');
                // restore sidebar state
                if (dom.sidebar) {
                    dom.sidebar.classList.remove('-translate-x-full');
                    dom.sidebar.style.transform = '';
                }
                // hide sidebar overlay
                if (dom.sidebarOverlay) { dom.sidebarOverlay.classList.add('hidden'); dom.sidebarOverlay.style.pointerEvents = 'none'; dom.sidebarOverlay.style.opacity = ''; }
                // ensure modal backdrop is not blocking
                if (dom.modalBackdrop) { dom.modalBackdrop.classList.add('opacity-0','pointer-events-none'); dom.modalBackdrop.style.pointerEvents = 'none'; dom.modalBackdrop.style.opacity = ''; delete dom.modalBackdrop.dataset.modalOpen; }
                // clear inline styles on chat and footer
                const chat = document.getElementById('chat-container'); if (chat) chat.style.paddingBottom = '';
                const footer = document.querySelector('footer'); if (footer) { footer.style.position = ''; footer.style.bottom = ''; footer.style.left = ''; footer.style.right = ''; footer.style.zIndex = ''; }
                // reset any floating send-button positioning
                const send = document.getElementById('send-button'); if (send) { send.style.position = ''; send.style.right = ''; send.style.bottom = ''; send.style.zIndex = ''; }
                // update UI
                lucide.createIcons();
                applyMobileLayout(); // will set correct state for current viewport
                // focus input where appropriate
                try { setTimeout(() => { dom.userInput?.focus(); }, 80); } catch(e){}
                showToast('Tata letak dipulihkan ke default', 'success');
            } catch(e) { console.warn('restoreDefaultLayout failed', e); showToast('Gagal mereset tata letak', 'error'); }
        }

        function createNewConversation() {
            const newId = `chat_${Date.now()}`;
            state.conversations[newId] = { id: newId, title: 'Percakapan Baru', history: [], date: new Date() };
            setActiveConversation(newId);
        }

        function setActiveConversation(id) {
            state.activeConversationId = id;
            localStorage.setItem('chimera_activeConversationId', id);
            renderConversation(id);
            loadConversations();
            if(window.innerWidth < 768) closeSidebar();
        }

        function saveAllData() {
            try {
                localStorage.setItem('chimera_apiKey', state.apiKey || '');
                localStorage.setItem('chimera_conversations', JSON.stringify(state.conversations));
                localStorage.setItem('chimera_activeConversationId', state.activeConversationId);
                localStorage.setItem('chimera_settings', JSON.stringify(state.settings));
            } catch (e) {
                console.error("Failed to save data to localStorage:", e);
                showToast('Gagal menyimpan data. Penyimpanan mungkin penuh.', 'error');
            }
        }

        // --- UI RENDERING ---

        function renderConversation(id) {
            dom.chatContainer.innerHTML = '';
            const conversation = state.conversations[id];
            if (!conversation) return createNewConversation();

            dom.chatTitle.textContent = conversation.title;

            if (conversation.history.length === 0) {
                 renderWelcomeScreen();
            } else {
                conversation.history.forEach((msg, idx) => addMessage(msg.role, msg.parts, false, idx));
            }
            // restore draft if present
            dom.userInput.value = loadDraft(id) || '';
            autoResizeTextarea();
            scrollToBottom(true);
        }
        
        function loadConversations() {
            dom.conversationHistory.innerHTML = '';
            const filter = dom.searchInput?.value?.toLowerCase?.() || '';
            const sortedConversations = Object.values(state.conversations).filter(c => {
                if (!filter) return true;
                return c.title.toLowerCase().includes(filter) || (c.history||[]).some(m=> (m.parts||[]).some(p=> (p.text||'').toLowerCase().includes(filter)));
            }).sort((a, b) => {
                // pinned first, then date
                if ((b.pinned?1:0) - (a.pinned?1:0) !== 0) return (b.pinned?1:0) - (a.pinned?1:0);
                return new Date(b.date) - new Date(a.date);
            });
            sortedConversations.forEach(conv => {
                const isActive = conv.id === state.activeConversationId;
                const wrapper = document.createElement('div'); wrapper.className = 'conversation-list-item';
                const pill = document.createElement('div');
                pill.className = `conv-pill cursor-pointer transition-all duration-150 ${isActive ? 'active' : ''}`;
                pill.dataset.id = conv.id;
                // left radio and title
                const radio = document.createElement('span'); radio.className = 'conv-radio';
                const titleWrap = document.createElement('div'); titleWrap.style.flex = '1';
                const titleEl = document.createElement('div'); titleEl.className = 'title truncate'; titleEl.textContent = conv.title || 'Percakapan';
                const subEl = document.createElement('div'); subEl.className = 'subtitle'; subEl.textContent = (conv.history && conv.history[conv.history.length-1] && (conv.history[conv.history.length-1].parts||[])[0]?.text?.slice(0,40)) || '';
                titleWrap.appendChild(titleEl); if (subEl.textContent) titleWrap.appendChild(subEl);
                const actions = document.createElement('div'); actions.className = 'flex items-center gap-2';
                const del = document.createElement('button'); del.className = 'delete-chat-btn text-gray-400 hover:text-white p-1'; del.title='Hapus percakapan'; del.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                const pin = document.createElement('button'); pin.className = 'pin-chat-btn text-gray-400 hover:text-white p-1'; pin.title='Pin percakapan'; pin.innerHTML = conv.pinned?'<i data-lucide="pin" class="w-4 h-4 text-yellow-300"></i>':'<i data-lucide="circle" class="w-3 h-3"></i>';
                actions.appendChild(pin); actions.appendChild(del);

                pill.appendChild(radio); pill.appendChild(titleWrap); pill.appendChild(actions);

                // event handling
                pill.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-chat-btn')) { e.stopPropagation(); showCustomConfirm('Hapus percakapan?', `Anda yakin ingin menghapus "${conv.title}"?`, () => { delete state.conversations[conv.id]; saveAllData(); loadConversations(); }); return; }
                    if (e.target.closest('.pin-chat-btn')) { e.stopPropagation(); togglePinConversation(conv.id); return; }
                    if (!state.multiSelectActive) setActiveConversation(conv.id);
                });

                wrapper.appendChild(pill);
                dom.conversationHistory.appendChild(wrapper);
            });
            lucide.createIcons();
        }

        function renderWelcomeScreen() {
            dom.chatContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-4 fade-in">
                    <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Project Chimera 7.0</h1>
                    <p class="mt-4 text-gray-400 max-w-2xl mx-auto">Asisten AI canggih dengan pemahaman materi, input suara, dan TTS. Bagaimana saya bisa membantu Anda hari ini?</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-10 w-full max-w-2xl">
                        <button data-prompt="Jelaskan konsep relativitas umum Einstein dengan analogi sederhana." class="welcome-prompt-btn">
                            <i data-lucide="atom"></i> <strong>Rumus Fisika</strong> <p>Jelaskan relativitas umum</p>
                        </button>
                         <button data-prompt="Buatkan saya contoh kode python untuk web scraping menggunakan BeautifulSoup." class="welcome-prompt-btn">
                            <i data-lucide="code"></i> <strong>Analisis Kode</strong> <p>Contoh web scraping Python</p>
                        </button>
                         <button data-prompt="Buatkan puisi tentang senja di tepi pantai." class="welcome-prompt-btn">
                            <i data-lucide="feather"></i> <strong>Buat Puisi</strong> <p>Puisi tentang senja</p>
                        </button>
                         <button data-prompt="Rencanakan perjalanan 3 hari di Yogyakarta, fokus pada wisata budaya dan kuliner." class="welcome-prompt-btn">
                            <i data-lucide="map"></i> <strong>Rencana Perjalanan</strong> <p>Itinerary 3 hari di Jogja</p>
                        </button>
                    </div>
                </div>`;
                
            const style = document.createElement('style');
            style.textContent = `
                .welcome-prompt-btn {
                    background-color: var(--surface-primary); border: 1px solid var(--border-primary);
                    padding: 1rem; border-radius: 0.75rem; text-align: left;
                    transition: all 0.2s ease-in-out;
                }
                .welcome-prompt-btn:hover {
                    transform: translateY(-5px); border-color: var(--accent);
                    box-shadow: 0 10px 15px -3px var(--accent-glow);
                }
                .welcome-prompt-btn i {
                    margin-bottom: 0.5rem; color: var(--accent);
                }
                 .welcome-prompt-btn p { font-size: 0.875rem; color: #9ca3af; }
            `;
            dom.chatContainer.appendChild(style);
            lucide.createIcons();
        }

        function addMessage(sender, parts, animate = true, index = null) {
            const isUser = sender === 'user';
            const wrapper = document.createElement('div');
            const animationClass = isUser ? 'slideInRight' : 'slideInLeft';
            wrapper.style.animation = animate ? `${animationClass} 0.4s ease-out forwards` : 'none';
            wrapper.className = `flex gap-3 ${isUser ? 'justify-end' : 'justify-start'}`;
            
            let contentHTML = '';
            if (isUser) {
                 parts.forEach(part => {
                    if (part.text) contentHTML += `<p>${part.text.replace(/\n/g, '<br>')}</p>`;
                    if (part.inlineData) contentHTML += `<img src="data:${part.inlineData.mimeType};base64,${part.inlineData.data}" class="max-w-xs rounded-lg mt-2" alt="Uploaded content">`;
                 });
            } else {
                contentHTML = marked.parse(parts[0]?.text || "");
            }

            wrapper.innerHTML = `
                <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center border ${isUser ? 'bg-blue-500/20 border-blue-500/30 order-2' : 'bg-gray-500/20 border-gray-500/30 order-1'}"><i data-lucide="${isUser ? 'user' : 'bot'}" class="w-5 h-5"></i></div>
                <div class="border p-4 rounded-xl max-w-3xl ${isUser ? 'rounded-br-none bg-blue-600/10 order-1' : 'rounded-bl-none bg-[var(--surface-primary)] order-2'} relative group">
                    <div class="flex items-start justify-between gap-2">
                        <div class="markdown-content prose dark:prose-invert prose-p:my-2 prose-headings:my-3">${contentHTML}</div>
                        <div class="text-xs text-gray-400 ml-2">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    </div>
                    ${!isUser ? `<div class="absolute -bottom-5 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <button class="copy-response-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" title="Salin"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        <button class="tts-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" title="Dengarkan"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
                        <button class="regenerate-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" title="Regenerate"><i data-lucide="refresh-ccw" class="w-4 h-4"></i></button>
                        <button class="edit-message-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" data-index="${index}" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button class="history-message-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" data-index="${index}" title="Riwayat"><i data-lucide="clock" class="w-4 h-4"></i></button>
                        <button class="delete-message-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" data-index="${index}" title="Hapus"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>` : ''}
                </div>
            `;
            dom.chatContainer.appendChild(wrapper);
            const bubble = wrapper.querySelector('.group');
            if (!isUser && parts[0]?.text && !parts[0].text.includes('typing-indicator')) {
                 postProcessMessage(bubble);
            }
            scrollToBottom();
            lucide.createIcons();
            return bubble;
        }

        function postProcessMessage(bubble) {
            // If the bubble is animated on appear, defer heavy processing very slightly
            const run = () => {
                renderMathInElement(bubble);
                highlightCodeInElement(bubble);
                renderMermaidDiagrams(bubble);
                addCopyToCodeBlocks(bubble);
            };
            if (bubble.classList.contains('message-appear')) setTimeout(run, 140); else run();
            // sanitize HTML to prevent XSS (marked output)
            if (window.DOMPurify) {
                const md = bubble.querySelector('.markdown-content');
                if (md) {
                    // use default DOMPurify sanitize (no invalid config)
                    md.innerHTML = DOMPurify.sanitize(md.innerHTML);
                }
            }
        }
        
        function updateThemeUI() {
            // apply theme class to <html>
            document.documentElement.className = state.currentTheme;

            // readable label and icon mapping
            const themeLabels = { dark: 'Mode Gelap', light: 'Mode Terang', sunset: 'Sunset' };
            const themeIcons = { dark: 'sun', light: 'moon', sunset: 'sunset' };
            dom.themeText.textContent = themeLabels[state.currentTheme] || 'Tema';

            const iconContainer = dom.themeToggle;
            const oldIcon = iconContainer.querySelector('i') || iconContainer.querySelector('svg');
            if (oldIcon) oldIcon.remove();
            const newIcon = document.createElement('i');
            newIcon.setAttribute('data-lucide', themeIcons[state.currentTheme] || 'sun');
            iconContainer.prepend(newIcon);

            lucide.createIcons();

            mermaid.initialize({ startOnLoad: false, theme: state.currentTheme, securityLevel: 'loose' });
            document.querySelectorAll('.mermaid').forEach(el => {
                el.removeAttribute('data-processed');
                mermaid.run({ nodes: [el] });
            });
        }

        // show lightweight onboarding modal once
        function maybeShowOnboarding(){
            try{
                const seen = localStorage.getItem('chimera_seen_onboarding');
                if (seen) return;
                const content = `
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-2">Selamat datang di Chimera v7</h2>
                        <p class="text-sm text-gray-400 mb-4">Beberapa fitur baru: export PDF, multi-select, dan tema 'Sunset'. Gunakan tombol tema untuk mengganti tampilan.</p>
                        <div class="flex gap-2">
                            <button id="onboard-gotit" class="px-3 py-2 rounded-md bg-blue-600 text-white">Mengerti</button>
                            <button id="onboard-dismiss" class="px-3 py-2 rounded-md bg-transparent border border-[var(--border-primary)]">Jangan tampil lagi</button>
                        </div>
                    </div>
                `;
                showModal(content, 'max-w-md');
                document.getElementById('onboard-gotit').addEventListener('click', () => { hideModal(); localStorage.setItem('chimera_seen_onboarding', '1'); });
                document.getElementById('onboard-dismiss').addEventListener('click', () => { hideModal(); localStorage.setItem('chimera_seen_onboarding', '1'); });
            }catch(e){ /* ignore */ }
        }

        function updateApiKeyUI() {
            let cls = 'bg-red-500 api-status-pulse';
            if (state.apiKey) {
                // detect if value looks like our encrypted payload (base64 JSON)
                try {
                    const decoded = atob(state.apiKey);
                    const parsed = JSON.parse(decoded);
                    if (parsed && parsed.salt && parsed.iv && parsed.ct) cls = 'bg-yellow-400';
                    else cls = 'bg-green-500';
                } catch(e) { cls = 'bg-green-500'; }
            }
            dom.apiKeyStatus.className = `w-2.5 h-2.5 rounded-full transition-colors ${cls}`;
        }
        
        function updateUIForGeneration(isGenerating) {
            dom.sendButton.disabled = isGenerating;
            dom.stopGenerationContainer.classList.toggle('hidden', !isGenerating);
        }

        // --- MODALS & TOASTS ---

        function showModal(contentHTML, size = 'max-w-md') {
            // create a wrapper inside the backdrop so clicks on the backdrop element (dom.modalBackdrop)
            // are distinguishable from clicks inside the modal content.
            dom.modalBackdrop.innerHTML = `
                <div id="modal-content-wrapper" class="w-full flex items-center justify-center p-4">
                    <div class="bg-[var(--surface-primary)] border border-[var(--border-primary)] w-full ${size} rounded-2xl shadow-2xl scale-in flex flex-col max-h-[90vh] overflow-auto">${contentHTML}</div>
                </div>`;
            dom.modalBackdrop.classList.remove('opacity-0', 'pointer-events-none');
            // Ensure the wrapper receives focus and pointer events so inner controls are interactive
            try {
                const wrapper = dom.modalBackdrop.querySelector('#modal-content-wrapper');
                if (wrapper) {
                    wrapper.addEventListener('click', (ev) => { ev.stopPropagation(); });
                    wrapper.setAttribute('tabindex', '-1');
                    wrapper.style.pointerEvents = 'auto';
                    // focus after a tick to ensure rendering
                    setTimeout(() => { try { wrapper.focus(); } catch(e){} }, 30);
                }
            } catch(e){ console.warn('showModal focus failed', e); }
            // clear any inline pointer-events on the backdrop (some routines set this to 'none')
            try { dom.modalBackdrop.style.pointerEvents = 'auto'; } catch(e){}
            // mark backdrop as having a modal (useful for other logic)
            dom.modalBackdrop.dataset.modalOpen = '1';
            // setup a lightweight focus-trap: keep tabbable focus within the modal
            try {
                const trap = (ev) => {
                    const wrapper = dom.modalBackdrop.querySelector('#modal-content-wrapper');
                    if (!wrapper) return;
                    const focusable = wrapper.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
                    if (!focusable.length) return;
                    const first = focusable[0]; const last = focusable[focusable.length -1];
                    if (ev.key === 'Tab') {
                        if (ev.shiftKey && document.activeElement === first) { ev.preventDefault(); last.focus(); }
                        else if (!ev.shiftKey && document.activeElement === last) { ev.preventDefault(); first.focus(); }
                    }
                };
                // store for later removal
                dom._modalTrapHandler = trap;
                document.addEventListener('keydown', trap);
            } catch(e) { console.warn('modal focus-trap failed', e); }
        }

        function hideModal() {
            const wrapper = dom.modalBackdrop.querySelector('#modal-content-wrapper');
            if (wrapper) {
                const inner = wrapper.querySelector('div[class*="max-w-"]'); if (inner) inner.classList.remove('scale-in');
                try { dom.modalBackdrop.removeChild(wrapper); } catch(e) { dom.modalBackdrop.innerHTML = ''; }
            }
            dom.modalBackdrop.classList.add('opacity-0', 'pointer-events-none');
            try { dom.modalBackdrop.style.pointerEvents = 'none'; } catch(e){}
            // remove focus trap if present
            try { document.removeEventListener('keydown', dom._modalTrapHandler); delete dom._modalTrapHandler; } catch(e){}
            delete dom.modalBackdrop.dataset.modalOpen;
            try { scrollToBottom(true); } catch(e){}
        }
        
        function showApiKeyModal() {
            let extra = '';
            // if stored key looks encrypted, offer unlock
            try {
                const decoded = state.apiKey ? atob(state.apiKey) : null;
                const parsed = decoded ? JSON.parse(decoded) : null;
                if (parsed && parsed.salt && parsed.iv && parsed.ct) {
                    extra = `<div class="mb-3 text-sm text-yellow-300">API Key saat ini tersimpan dalam bentuk terenkripsi. Klik "Buka" untuk memasukkan password dan mendekripsi ke sesi ini.</div><div class="flex gap-2"><button id="unlock-api-key-btn" class="px-3 py-1 rounded-md bg-yellow-500 text-black">Buka (Masukkan Password)</button></div>`;
                }
            } catch(e) { extra = ''; }
            const content = `
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-2">Masukkan API Key</h2>
                    <p class="text-sm text-gray-400 mb-4">Dapatkan API Key gratis Anda dari Google AI Studio untuk menggunakan aplikasi ini. Kode API hanya disimpan di browser Anda.</p>
                    <input type="password" id="api-key-input" placeholder="AIza..." value="${state.apiKey || ''}" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <div class="mt-3 flex items-center gap-2">
                        <input type="checkbox" id="encrypt-api-key" /> <label for="encrypt-api-key" class="text-sm text-gray-400">Simpan API Key terenkripsi (dengan password)</label>
                    </div>
                    ${extra}
                </div>
                <div class="flex justify-end gap-3 px-6 py-4 bg-black/20 rounded-b-2xl">
                    <button id="close-modal-button" class="px-4 py-2 rounded-lg hover:bg-white/10">Batal</button>
                    <button id="save-api-key-button" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 font-semibold">Simpan</button>
                </div>
            `;
            showModal(content);
        }

        function showSettingsModal() {
            const content = `
                <div class="p-6 overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-6">Pengaturan</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="persona-select" class="block text-sm font-medium text-gray-400 mb-1">Persona AI</label>
                            <select id="persona-select" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="default">Asisten Standar</option>
                                <option value="coder">Programmer Ahli</option>
                                <option value="writer">Penulis Kreatif</option>
                                <option value="scientist">Ilmuwan</option>
                                <option value="academic">Akademisi</option>
                                <option value="historian">Pakar Sejarah</option>
                                <option value="custom">Kustom</option>
                            </select>
                        </div>
                        <div id="custom-prompt-container" class="${state.settings.persona !== 'custom' ? 'hidden' : ''}">
                            <label for="system-prompt-input" class="block text-sm font-medium text-gray-400 mb-1">System Prompt (Kustom)</label>
                            <textarea id="system-prompt-input" rows="4" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500">${state.settings.customSystemPrompt}</textarea>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Manajemen Data</h3>
                            <div class="flex flex-col sm:flex-row gap-2">
                               <button id="export-chat-btn" class="w-full py-2 bg-gray-500/20 border border-gray-500 text-gray-300 rounded-lg hover:bg-gray-500/40 transition-colors">Ekspor Semua Chat</button>
                               <button id="reset-all-settings-btn" class="w-full py-2 bg-red-600/20 border border-red-500 text-red-300 rounded-lg hover:bg-red-600/40 transition-colors">Reset Semua Data</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-auto space-x-3 p-4 border-t border-[var(--border-primary)] bg-black/10 rounded-b-2xl">
                     <button id="close-settings-button" class="px-4 py-2 rounded-lg hover:bg-white/10 transition-colors">Tutup</button>
                     <button id="save-settings-button" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors font-semibold">Simpan & Tutup</button>
                </div>
            `;
            showModal(content, 'max-w-2xl');
            document.getElementById('persona-select').value = state.settings.persona;
        }

        function showCustomConfirm(title, message, onConfirm) {
            const content = `
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">${title}</h2>
                    <p class="text-gray-400 mb-6">${message}</p>
                </div>
                <div class="flex justify-end gap-3 px-6 py-4 bg-black/20 rounded-b-2xl">
                    <button id="confirm-cancel" class="px-4 py-2 rounded-lg hover:bg-white/10">Batal</button>
                    <button id="confirm-ok" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">Konfirmasi</button>
                </div>
            `;
            showModal(content);
            document.getElementById('confirm-ok').onclick = () => { onConfirm(); hideModal(); };
            document.getElementById('confirm-cancel').onclick = hideModal;
        }

        // --- New Tooling: Deep Research, Integrated Learning, Canva Editor ---
        function openDeepResearch() {
            // If we're in fullscreen, open as a new conversation with a prefilled prompt instead
            if (document.fullscreenElement) {
                unblockOverlaysFullScreen();
                createNewConversation();
                dom.userInput.value = 'Deep Research: [Masukkan topik riset di sini]';
                autoResizeTextarea();
                dom.userInput.focus();
                return;
            }
            const content = `
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-2">Deep Research</h2>
                    <p class="text-sm text-gray-400 mb-4">Tool ini membantu membuat ringkasan riset mendalam. Pilih sumber, tingkat kedalaman, lalu jalankan. (Prototype — sambungkan API pencarian/academic untuk hasil nyata.)</p>
                    <input id="deep-query" class="w-full p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)]" placeholder="Masukkan topik riset..." />
                    <div class="mt-3 flex gap-2 items-center">
                        <div class="flex gap-2 items-center">
                            <label class="text-sm"><input type="checkbox" id="src-web" checked /> Web</label>
                            <label class="text-sm"><input type="checkbox" id="src-scholarly" /> Scholarly</label>
                            <label class="text-sm"><input type="checkbox" id="src-pdf" /> PDF</label>
                        </div>
                        <div class="ml-auto flex items-center gap-2">
                            <label class="text-sm">Kedalaman</label>
                            <select id="deep-scope" class="p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)]">
                                <option value="overview">Sekilas</option>
                                <option value="detailed">Detail</option>
                                <option value="citations">Dengan Kutipan</option>
                            </select>
                            <button id="deep-run" class="px-3 py-2 bg-blue-600 text-white rounded-md">Jalankan</button>
                        </div>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button id="deep-insert-chat" class="px-3 py-2 bg-green-600 text-white rounded-md">Masukkan ke Chat</button>
                        <button id="deep-new-conv" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Buat Percakapan Baru</button>
                        <button id="deep-export" class="px-3 py-2 bg-gray-600 text-white rounded-md ml-auto">Ekspor Hasil</button>
                    </div>
                    <div id="deep-progress" class="mt-3 w-full bg-white/5 rounded-full h-2 overflow-hidden"><div id="deep-progress-bar" style="width:0%" class="h-full bg-[var(--accent)]"></div></div>
                    <div id="deep-results" class="mt-4 max-h-64 overflow-auto"></div>
                </div>
            `;
            showModal(content, 'max-w-3xl');
            lucide.createIcons();

            // streaming simulation and basic source list shape
            let streamTimer = null;
            document.getElementById('deep-run').addEventListener('click', async () => {
                const q = document.getElementById('deep-query').value.trim();
                const scope = document.getElementById('deep-scope').value;
                const useWeb = document.getElementById('src-web').checked;
                const useSch = document.getElementById('src-scholarly').checked;
                const usePdf = document.getElementById('src-pdf').checked;
                if (!q) return showToast('Masukkan query riset terlebih dahulu', 'warning');
                const resEl = document.getElementById('deep-results'); resEl.innerHTML = '';
                const progressBar = document.getElementById('deep-progress-bar'); progressBar.style.width = '0%';

                // Simulate streaming chunks like Gemini: show interim snippets, then finalize
                const simulatedSources = [];
                if (useWeb) simulatedSources.push({ source: 'Example News', url: 'https://example.com/article', snippet: `Ringkasan cepat tentang ${q} dari web...` });
                if (useSch) simulatedSources.push({ source: 'Journal X', url: 'https://doi.org/10.0000/example', snippet: `Ringkasan singkat dari artikel ilmiah tentang ${q}...` });
                if (usePdf) simulatedSources.push({ source: 'PDF Reference', url: 'file.pdf', snippet: `Kutipan dari PDF yang relevan tentang ${q}...` });

                // progressive reveal
                let step = 0; const steps = 5 + simulatedSources.length;
                streamTimer && clearInterval(streamTimer);
                streamTimer = setInterval(() => {
                    step++;
                    const pct = Math.min(100, Math.round((step / steps) * 100)); progressBar.style.width = pct + '%';
                    if (step <= 3) {
                        const p = document.createElement('div'); p.className = 'p-3 bg-[var(--surface-primary)] rounded-md mb-2'; p.innerHTML = `<strong>Streaming:</strong> <div class="text-sm text-gray-300">Mengumpulkan bukti untuk <em>${escapeHtml(q)}</em>...</div>`;
                        resEl.appendChild(p);
                    } else if (step - 3 <= simulatedSources.length) {
                        const src = simulatedSources[step - 4];
                        const item = document.createElement('div'); item.className = 'p-3 bg-[var(--surface-primary)] rounded-md mb-2';
                        item.innerHTML = `<div class="text-sm text-gray-300"><strong>${escapeHtml(src.source)}</strong> — <a href="${escapeHtml(src.url)}" target="_blank" rel="noreferrer" class="text-blue-300 underline">${escapeHtml(src.url)}</a><div class="mt-1">${escapeHtml(src.snippet)}</div></div>`;
                        resEl.appendChild(item);
                    } else {
                        // final summary
                        const final = document.createElement('div'); final.className = 'p-3 bg-[var(--surface-primary)] rounded-md mb-2';
                        final.innerHTML = `<strong>Ringkasan (${escapeHtml(scope)}):</strong><p class="mt-2 text-sm text-gray-300">Hasil ringkasan gabungan untuk <em>${escapeHtml(q)}</em>. (Ini adalah prototipe; sambungkan real search API untuk hasil nyata.)</p>`;
                        resEl.appendChild(final);
                        clearInterval(streamTimer);
                    }
                    resEl.scrollTop = resEl.scrollHeight;
                }, 350);
            });

            document.getElementById('deep-export').addEventListener('click', () => {
                const res = document.getElementById('deep-results').innerText || '';
                const blob = new Blob([res], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `deep-research-${Date.now()}.txt`; a.click(); URL.revokeObjectURL(url); showToast('Hasil diekspor');
            });

            document.getElementById('deep-insert-chat').addEventListener('click', () => {
                const text = document.getElementById('deep-results').innerText || '';
                if (!text) return showToast('Jalankan penelitian terlebih dahulu', 'warning');
                // append as assistant response into current conversation
                const conv = state.conversations[state.activeConversationId];
                conv.history.push({ role: 'model', parts: [{ text: `Deep Research Results:\n\n${text}` }] });
                saveAllData(); hideModal(); renderConversation(state.activeConversationId); showToast('Hasil dimasukkan ke percakapan');
            });

            document.getElementById('deep-new-conv').addEventListener('click', () => {
                const text = document.getElementById('deep-results').innerText || '';
                if (!text) return showToast('Jalankan penelitian terlebih dahulu', 'warning');
                createNewConversation(); const conv = state.conversations[state.activeConversationId];
                conv.history.push({ role: 'model', parts: [{ text: `Deep Research Results:\n\n${text}` }] });
                saveAllData(); hideModal(); renderConversation(state.activeConversationId); showToast('Percakapan baru dibuat dengan hasil riset');
            });
        }

        function openLearning() {
            if (document.fullscreenElement) {
                unblockOverlaysFullScreen();
                createNewConversation();
                dom.userInput.value = 'Pembelajaran Terpadu: [Topik] - Tujuan belajar: ...';
                autoResizeTextarea(); dom.userInput.focus(); return;
            }
            const content = `
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-2">Pembelajaran Terpadu</h2>
                    <p class="text-sm text-gray-400 mb-4">Buat modul pembelajaran interaktif: masukkan topik, tujuan belajar, dan tingkat kesulitan. Sistem akan membuat ringkasan, kuis singkat, dan bahan latihan.</p>
                    <input id="learn-topic" class="w-full p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)]" placeholder="Topik (contoh: Persamaan Maxwell)" />
                    <div class="mt-3 flex gap-2">
                        <select id="learn-level" class="p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)]">
                            <option value="pemula">Pemula</option>
                            <option value="menengah">Menengah</option>
                            <option value="lanjutan">Lanjutan</option>
                        </select>
                        <button id="learn-run" class="px-3 py-2 bg-blue-600 text-white rounded-md">Buat Modul</button>
                        <button id="learn-quiz" class="px-3 py-2 bg-green-600 text-white rounded-md">Buat Kuis</button>
                        <button id="learn-insert" class="px-3 py-2 bg-indigo-600 text-white rounded-md ml-auto">Masukkan ke Chat</button>
                    </div>
                    <div id="learn-results" class="mt-4 max-h-64 overflow-auto"></div>
                </div>
            `;
            showModal(content, 'max-w-3xl');
            lucide.createIcons();

            document.getElementById('learn-run').addEventListener('click', () => {
                const topic = document.getElementById('learn-topic').value.trim();
                const level = document.getElementById('learn-level').value;
                if (!topic) return showToast('Masukkan topik pembelajaran', 'warning');
                const out = document.getElementById('learn-results'); out.innerHTML = '<em>Menghasilkan modul pembelajaran...</em>';
                setTimeout(() => {
                    const moduleHtml = `
                        <div class="p-3 bg-[var(--surface-primary)] rounded-md">
                            <h3 class="font-semibold">Modul: ${escapeHtml(topic)}</h3>
                            <div class="text-sm text-gray-300">Tingkat: ${escapeHtml(level)}</div>
                            <h4 class="mt-3 font-semibold">Tujuan Pembelajaran</h4>
                            <ul class="list-decimal ml-5 mt-2 text-sm"><li>Memahami konsep dasar ${escapeHtml(topic)}</li><li>Mampu menerapkan konsep pada contoh sederhana</li></ul>
                            <h4 class="mt-3 font-semibold">Materi Inti</h4>
                            <ol class="mt-2 list-decimal ml-5 text-sm"><li>Pengenalan dan konteks</li><li>Prinsip dasar dan rumus penting</li><li>Contoh dan latihan</li></ol>
                            <h4 class="mt-3 font-semibold">Latihan</h4>
                            <ol class="mt-2 list-decimal ml-5 text-sm"><li>Soal latihan 1 (jawaban: ...)</li><li>Soal latihan 2 (jawaban: ...)</li></ol>
                        </div>`;
                    out.innerHTML = moduleHtml;
                }, 700);
            });

            document.getElementById('learn-quiz').addEventListener('click', () => {
                const topic = document.getElementById('learn-topic').value.trim();
                if (!topic) return showToast('Masukkan topik terlebih dahulu', 'warning');
                const out = document.getElementById('learn-results');
                const quizHtml = `<div class="p-3 bg-[var(--surface-primary)] rounded-md"><h4 class="font-semibold">Kuis Singkat untuk ${escapeHtml(topic)}</h4><ol class="mt-2 list-decimal ml-5 text-sm"><li>Apa definisi utama dari ${escapeHtml(topic)}? (Jawaban singkat)</li><li>Sebutkan satu aplikasi nyata dari ${escapeHtml(topic)}.</li><li>Soal pilihan ganda: Pilih pernyataan yang benar tentang ${escapeHtml(topic)}.</li></ol></div>`;
                out.innerHTML = quizHtml;
            });

            document.getElementById('learn-insert').addEventListener('click', () => {
                const text = document.getElementById('learn-results').innerText || '';
                if (!text) return showToast('Buat modul dulu sebelum memasukkan', 'warning');
                const conv = state.conversations[state.activeConversationId];
                conv.history.push({ role: 'model', parts: [{ text: `Pembelajaran Terpadu:\n\n${text}` }] });
                saveAllData(); hideModal(); renderConversation(state.activeConversationId); showToast('Modul dimasukkan ke percakapan');
            });
        }

        // Canva-like code editor + preview (using ACE)
        function openCanvaEditor() {
            if (document.fullscreenElement) {
                // open a new conversation and prefill with a canva template
                unblockOverlaysFullScreen();
                createNewConversation();
                dom.userInput.value = '<Canva Template>\nJudul: ...\nDeskripsi: ...';
                autoResizeTextarea(); dom.userInput.focus(); return;
            }
            const content = `
                <div class="p-4 flex flex-col gap-3 h-[70vh]">
                    <h2 class="text-xl font-bold">Canva - Editor & Preview</h2>
                    <div class="flex gap-2 h-full">
                        <div class="w-1/2 h-full border border-[var(--border-primary)] rounded-md p-1 bg-[var(--bg-primary)] flex flex-col">
                            <div class="flex items-center gap-2 mb-2">
                                <select id="canva-templates" class="p-2 border border-[var(--border-primary)] rounded-md bg-[var(--bg-primary)]">
                                    <option value="tpl_hero">Template - Hero Banner</option>
                                    <option value="tpl_card">Template - Card</option>
                                    <option value="tpl_poster">Template - Poster</option>
                                </select>
                                <input id="canva-image-input" type="file" accept="image/*" class="text-sm" />
                                <button id="canva-insert-image" class="px-2 py-1 bg-green-600 text-white rounded-md">Masukkan Gambar</button>
                            </div>
                            <div class="flex-1" id="ace-wrapper"><div id="ace-editor" style="height:100%; width:100%;"></div></div>
                        </div>
                        <div class="w-1/2 h-full border border-[var(--border-primary)] rounded-md p-3 bg-[var(--surface-primary)] overflow-auto" id="canva-preview"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button id="canva-run" class="px-3 py-2 bg-blue-600 text-white rounded-md">Render Preview</button>
                        <button id="canva-export-pdf" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Export PDF</button>
                        <button id="canva-close" class="px-3 py-2 bg-transparent border border-[var(--border-primary)] rounded-md">Tutup</button>
                    </div>
                </div>
            `;
            showModal(content, 'max-w-5xl');
            lucide.createIcons();
            // initialize ACE and wire template + upload handlers
            setTimeout(() => {
                try {
                    if (typeof ace === 'undefined') { showToast('Editor ACE belum dimuat. Pastikan koneksi internet atau muat ulang halaman.', 'error'); return; }
                    const editor = ace.edit('ace-editor');
                    editor.setTheme('ace/theme/monokai');
                    editor.session.setMode('ace/mode/html');
                    // simple templates
                    const templates = {
                        tpl_hero: `<div style="padding:40px;background:#0f172a;color:#fff"><h1 style="font-size:36px">Judul Besar</h1><p>Subjudul ringkas di sini.</p></div>`,
                        tpl_card: `<div style="padding:16px;border-radius:8px;background:#fff;color:#0f172a;width:300px"><h3>Judul Kartu</h3><p>Deskripsi singkat.</p></div>`,
                        tpl_poster: `<div style="padding:30px;background:#1f2937;color:#fff"><h2>Poster Event</h2><p>Detail acara dan tanggal.</p></div>`
                    };
                    const tplSel = document.getElementById('canva-templates');
                    tplSel.addEventListener('change', () => { editor.setValue(templates[tplSel.value] || '', -1); });
                    // set initial template
                    editor.setValue(templates[tplSel.value] || '', -1);
                    // ensure editor resizes properly on mobile
                    setTimeout(() => { try { editor.resize(); ace.edit('ace-editor').focus(); } catch(e){} }, 180);

                    // reflow editor on window resize (helpful when keyboard appears)
                    const _aceResize = () => { try { editor.resize(); } catch(e){} };
                    window.addEventListener('resize', _aceResize);
                    // also re-apply mobile layout heuristics and sanitize overlays on resize
                    window.addEventListener('resize', () => { try { applyMobileLayout(); sanitizeOverlays(); } catch(e){} });

                    document.getElementById('canva-run').addEventListener('click', () => {
                        const html = editor.getValue();
                        let sanitized = html;
                        try { sanitized = window.DOMPurify ? DOMPurify.sanitize(html) : html; } catch(e) { console.warn('DOMPurify sanitize failed', e); }
                        document.getElementById('canva-preview').innerHTML = sanitized;
                        lucide.createIcons();
                    });

                    document.getElementById('canva-close').addEventListener('click', () => { hideModal(); });

                    document.getElementById('canva-export-pdf').addEventListener('click', () => {
                        const preview = document.getElementById('canva-preview');
                        if (!preview || preview.innerHTML.trim() === '') return showToast('Render preview terlebih dahulu', 'warning');
                        const container = document.createElement('div'); container.style.padding = '20px'; container.innerHTML = preview.innerHTML;
                        const opt = { margin:10, filename: sanitizeFilename('canva-export') + '.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} };
                        showToast('Membuat PDF...','warning'); hideModal(); setTimeout(()=> html2pdf().set(opt).from(container).save().then(()=> showToast('PDF dibuat')) ,50);
                    });

                    // image insert (reads file and inserts an <img> tag into editor)
                    const imgInput = document.getElementById('canva-image-input');
                    document.getElementById('canva-insert-image').addEventListener('click', async () => {
                        const file = imgInput.files && imgInput.files[0];
                        if (!file) return showToast('Pilih gambar terlebih dahulu', 'warning');
                        try {
                            const b64 = await fileToBase64(file);
                            const imgTag = `<img src="data:${file.type};base64,${b64}" style="max-width:100%;height:auto"/>`;
                            editor.session.insert({row: editor.session.getLength(), column:0}, '\n' + imgTag + '\n');
                            showToast('Gambar dimasukkan ke editor');
                        } catch(e) { console.error('insert image', e); showToast('Gagal memasukkan gambar', 'error'); }
                    });
                } catch(e) { console.error('ACE init error', e); showToast('Gagal inisialisasi editor', 'error'); }
            }, 150);
        }

        // --- PLUGIN SYSTEM ---
        const plugins = { active: {}, registry: {} };

        function openPluginStore() {
            let list = '';
            // show registered plugins (local registry)
            Object.keys(plugins.registry).forEach(key => {
                const p = plugins.registry[key];
                list += `<div class="p-3 border rounded-md mb-2 flex items-center justify-between"><div><strong>${escapeHtml(p.name)}</strong><div class="text-sm text-gray-400">${escapeHtml(p.description||'')}</div></div><div><button data-id="${key}" class="plugin-toggle px-3 py-1 rounded-md ${plugins.active[key] ? 'bg-red-600' : 'bg-green-600'} text-white">${plugins.active[key] ? 'Nonaktifkan' : 'Aktifkan'}</button></div></div>`;
            });
            showModal(`<div class="p-4 max-h-[60vh] overflow-auto"><h3 class="text-lg font-semibold mb-3">Plugin Store</h3>${list || '<div class="text-sm text-gray-400">Belum ada plugin terdaftar.</div>'}</div>`,'max-w-lg');
            // delegate toggle
            document.querySelectorAll('.plugin-toggle').forEach(btn => btn.addEventListener('click', async (e) => {
                const id = e.currentTarget.dataset.id; if (plugins.active[id]) { deactivatePlugin(id); } else { await activatePlugin(id); }
                hideModal(); openPluginStore();
            }));
        }

        async function activatePlugin(id) {
            const p = plugins.registry[id]; if (!p) return showToast('Plugin tidak ditemukan', 'error');
            try {
                if (p.url) {
                    // dynamic script load
                    await loadScript(p.url);
                }
                plugins.active[id] = true;
                localStorage.setItem('chimera_plugins', JSON.stringify(plugins.active));
                showToast(`${p.name} diaktifkan`,'success');
            } catch(e) { console.error('activatePlugin', e); showToast('Gagal mengaktifkan plugin','error'); }
        }

        function deactivatePlugin(id) { delete plugins.active[id]; localStorage.setItem('chimera_plugins', JSON.stringify(plugins.active)); showToast('Plugin dinonaktifkan'); }

        function registerPlugin(id, meta) { plugins.registry[id] = meta; }

    // loadScript is defined later near render helpers (deduplicated)

        // Example: register some placeholder plugins (could be remote URLs)
        registerPlugin('translator', { name: 'Translator', description: 'Terjemahkan teks antar bahasa', url: '' });
        registerPlugin('pdfqa', { name: 'PDF Q&A', description: 'Tanya jawab berdasarkan PDF', url: '' });

        // restore active plugins
        try { const saved = JSON.parse(localStorage.getItem('chimera_plugins')||'{}'); plugins.active = saved || {}; } catch(e) {}

        // --- COLLABORATION (basic peer-to-peer scaffold) ---
        // NOTE: This is a client-side scaffold. For production, a signaling server is required.
        const collab = { peer: null, conn: null };

        async function openCollabShare() {
            const content = `<div class="p-4"><h3 class="text-lg font-semibold">Share Percakapan</h3><p class="text-sm text-gray-400">Bagikan link atau token kepada rekan untuk bergabung (Prototype P2P). Untuk koneksi real-time yang stabil, gunakan signaling server.</p><div class="mt-3"><button id="create-offer" class="px-3 py-2 bg-blue-600 text-white rounded-md">Buat Link (Offer)</button><button id="join-offer" class="px-3 py-2 ml-2 bg-gray-600 text-white rounded-md">Gabung dengan Offer</button></div><div id="collab-output" class="mt-3 text-sm text-gray-400"></div></div>`;
            showModal(content,'max-w-lg');
            document.getElementById('create-offer').addEventListener('click', async () => {
                showToast('Membuat offer P2P (prototype)...');
                // create simple datachannel via RTCPeerConnection; user copies base64 offer to peer.
                const pc = new RTCPeerConnection(); const dc = pc.createDataChannel('chimera-collab');
                dc.onmessage = (ev)=> handleCollabMessage(ev.data, true);
                pc.onicecandidate = (e) => { if (e.candidate) return; document.getElementById('collab-output').textContent = btoa(JSON.stringify(pc.localDescription)); };
                const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
                collab.peer = pc; collab.conn = dc;
            });
            document.getElementById('join-offer').addEventListener('click', async () => {
                const text = prompt('Paste offer (base64) dari host:'); if (!text) return;
                try {
                    const pc = new RTCPeerConnection();
                    pc.ondatachannel = (e) => { const dc = e.channel; dc.onmessage = ev => handleCollabMessage(ev.data, false); collab.conn = dc; };
                    const desc = JSON.parse(atob(text)); await pc.setRemoteDescription(desc);
                    const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
                    document.getElementById('collab-output').textContent = btoa(JSON.stringify(pc.localDescription));
                    collab.peer = pc;
                } catch(e) { console.error('join offer error', e); showToast('Gagal bergabung dengan offer', 'error'); }
            });
        }

        function handleCollabMessage(data, fromHost) {
            try { const msg = JSON.parse(data); if (msg.type === 'sync-chat') { /* merge remote edits (simplified) */ state.conversations[msg.convId] = msg.conversation; saveAllData(); loadConversations(); if (state.activeConversationId === msg.convId) renderConversation(msg.convId); showToast('Percakapan disinkronkan (remote).'); }
            } catch(e){ console.warn('collab msg parse', e); }
        }

        function broadcastCollabUpdate(convId) {
            try { if (!collab.conn) return; const payload = { type: 'sync-chat', convId, conversation: state.conversations[convId] }; collab.conn.send(JSON.stringify(payload)); } catch(e){ console.warn('broadcastCollabUpdate', e); }
        }

        // hook: after saving conversation, broadcast if collab active
        const _origSaveAllData = saveAllData; saveAllData = function() { _origSaveAllData(); if (state.activeConversationId) broadcastCollabUpdate(state.activeConversationId); };

        // --- AI MEMORY / CONTEXT MANAGER ---
        const memory = { enabled: false, profile: {} };
        function loadMemory() { try { const m = JSON.parse(localStorage.getItem('chimera_memory')||'{}'); memory.enabled = !!m.enabled; memory.profile = m.profile || {}; document.getElementById('memory-toggle-input').checked = memory.enabled; renderMemorySummary(); } catch(e){} }
        function saveMemory() { localStorage.setItem('chimera_memory', JSON.stringify({ enabled: memory.enabled, profile: memory.profile })); }
        function renderMemorySummary() {
            const container = document.getElementById('memory-summary');
            if (!container) return;
            container.innerHTML = memory.enabled ? `<div class="p-2 text-sm">Nama: ${escapeHtml(memory.profile.name||'-')}<br/>Gaya: ${escapeHtml(memory.profile.style||'-')}<br/>Minat: ${escapeHtml((memory.profile.interests||[]).join(', ')||'-')}</div><div class="text-right"><button id="memory-reset" class="px-2 py-1 rounded-md bg-red-600 text-white">Reset Memory</button></div>` : '<div class="p-2 text-sm text-gray-400">Memori nonaktif</div>';
            const resetBtn = document.getElementById('memory-reset'); if (resetBtn) resetBtn.addEventListener('click', () => { memory.profile = {}; saveMemory(); renderMemorySummary(); showToast('Memori direset', 'warning'); });
        }

        // --- DASHBOARD MODE ---
        let dashboardMode = false;
        function toggleDashboardMode() {
            dashboardMode = !dashboardMode;
            if (!dashboardMode) { // restore chat
                dom.chatContainer.style.display = ''; dom.chatTitle.textContent = state.conversations[state.activeConversationId]?.title || 'Percakapan'; dom.sendButton.style.display = ''; dom.userInput.style.display = '';
            } else {
                // build a simple card grid from last conversation
                dom.chatContainer.innerHTML = '';
                const conv = state.conversations[state.activeConversationId] || { history: [] };
                const grid = document.createElement('div'); grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 p-4';
                conv.history.forEach((m, idx) => {
                    const card = document.createElement('div'); card.className = 'p-4 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-lg';
                    const role = m.role === 'user' ? 'User' : 'Assistant';
                    card.innerHTML = `<div class="text-sm text-gray-400">${role} • ${new Date(m.date || Date.now()).toLocaleString()}</div><div class="mt-2">${escapeHtml((m.parts||[]).map(p=>p.text||'').join('\n'))}</div>`;
                    grid.appendChild(card);
                });
                dom.chatContainer.appendChild(grid);
                dom.sendButton.style.display = 'none'; dom.userInput.style.display = 'none';
            }
        }

        // --- VOICE FULL-DUPLEX (simple auto-mic mode) ---
        let fullDuplexActive = false;
        function toggleFullDuplex() {
            fullDuplexActive = !fullDuplexActive;
            if (fullDuplexActive) startContinuousRecognition(); else stopContinuousRecognition();
        }
        async function startContinuousRecognition() {
            if (!state.recognition) return showToast('SpeechRecognition tidak tersedia di browser ini', 'error');
            try {
                state.recognition.continuous = true; state.recognition.start(); showToast('Full-duplex mic aktif');
                state.recognition.onresult = (e) => { const t = e.results[e.results.length-1][0].transcript; dom.userInput.value = t; autoResizeTextarea(); sendMessageToAI(); };
            } catch(e) { console.error('startContinuousRecognition', e); }
        }
        function stopContinuousRecognition() { try { if (state.recognition) state.recognition.stop(); showToast('Full-duplex mic dimatikan'); } catch(e){} }

        // --- WORKFLOW BUILDER (basic modal + node list stub) ---
        function openWorkflowBuilder() {
            const content = `<div class="p-4 h-[60vh] overflow-auto"><h3 class="text-lg font-semibold">Workflow Builder (Prototype)</h3><p class="text-sm text-gray-400">Drag & drop node editor placeholder. Simpan workflow untuk digunakan ulang.</p><div id="workflow-canvas" class="mt-3 p-3 bg-[var(--surface-primary)] rounded-md min-h-[300px]">(Canvas placeholder)</div><div class="flex justify-end mt-3"><button id="save-workflow" class="px-3 py-2 bg-blue-600 text-white rounded-md">Simpan</button></div></div>`;
            showModal(content,'max-w-4xl');
            document.getElementById('save-workflow').addEventListener('click', () => { const wf = { name: `wf_${Date.now()}`, nodes: [] }; const arr = JSON.parse(localStorage.getItem('chimera_workflows')||'[]'); arr.push(wf); localStorage.setItem('chimera_workflows', JSON.stringify(arr)); hideModal(); showToast('Workflow disimpan'); });
        }

        // --- TEMPLATE LIBRARY ---
        function openTemplateLibrary() {
            const arr = JSON.parse(localStorage.getItem('chimera_templates')||'[]');
            let html = '<div class="p-4"><h3 class="text-lg font-semibold">Template Library</h3><div class="grid grid-cols-1 gap-3 mt-3">';
            arr.forEach(t => html += `<div class="p-3 border rounded-md flex items-center justify-between"><div><strong>${escapeHtml(t.title)}</strong><div class="text-sm text-gray-400">${escapeHtml(t.desc||'')}</div></div><div><button data-id="${t.id}" class="use-template px-3 py-1 rounded-md bg-blue-600 text-white">Gunakan</button></div></div>`);
            html += '</div><div class="mt-3 flex gap-2"><button id="add-template" class="px-3 py-2 bg-green-600 text-white rounded-md">Tambah Template</button><button id="close-templates" class="px-3 py-2 bg-transparent border rounded-md">Tutup</button></div></div>';
            showModal(html,'max-w-2xl');
            document.getElementById('add-template').addEventListener('click', () => { const title = prompt('Judul template'); const desc = prompt('Deskripsi singkat'); if (!title) return; const id = `tpl_${Date.now()}`; const arr = JSON.parse(localStorage.getItem('chimera_templates')||'[]'); arr.push({ id, title, desc, owner: 'me' }); localStorage.setItem('chimera_templates', JSON.stringify(arr)); hideModal(); openTemplateLibrary(); });
            document.querySelectorAll('.use-template').forEach(btn => btn.addEventListener('click', (e)=>{ const id = e.currentTarget.dataset.id; const t = (JSON.parse(localStorage.getItem('chimera_templates')||'[]')).find(x=>x.id===id); if (t) { dom.userInput.value = t.title; autoResizeTextarea(); hideModal(); showToast('Template diterapkan'); } }));
        }

        // --- OFFLINE / LOCAL AI (stub) ---
        let localAImode = false;
        async function toggleLocalAImode() {
            localAImode = !localAImode; localStorage.setItem('chimera_localai', JSON.stringify({ enabled: localAImode }));
            if (localAImode) {
                showToast('Local AI mode aktif (prototype). Model ringan akan dimuat jika tersedia.', 'warning');
                // placeholder: load transformers.js or wasm model loader
            } else showToast('Local AI mode nonaktif');
        }

        // --- GAMIFICATION / BADGES ---
        const badges = { unlocked: JSON.parse(localStorage.getItem('chimera_badges')||'{}') };
        function unlockBadge(key) { badges.unlocked[key] = true; localStorage.setItem('chimera_badges', JSON.stringify(badges.unlocked)); renderBadgeCount(); }
        function renderBadgeCount() { const n = Object.keys(badges.unlocked||{}).length; const el = document.getElementById('badge-count'); if (el) el.textContent = n ? `+${n}` : ''; }
        renderBadgeCount();


        function showToast(message, type = 'success') {
            // prevent duplicate toasts with same message within short window
            if (!showToast.lastMessages) showToast.lastMessages = {};
            const now = Date.now();
            if (showToast.lastMessages[message] && now - showToast.lastMessages[message] < 1500) return;
            showToast.lastMessages[message] = now;
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-600' };
            toast.className = `flex items-center gap-3 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg toast-animation`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i><span>${message}</span>`;
            dom.toastContainer.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 1100);
        }

        // --- CORE FUNCTIONALITY & API ---

        async function sendMessageToAI() {
            if (!state.apiKey) {
                showToast('Silakan masukkan API Key Anda terlebih dahulu.', 'warning');
                showApiKeyModal();
                return;
            }
            let userMessage = dom.userInput.value.trim();
            if (!userMessage && !state.uploadedImage) return;

            if (state.uploadedImage && !userMessage) {
                userMessage = "Jelaskan gambar ini secara detail.";
            }

            state.isGenerating = true; state.abortController = new AbortController(); updateUIForGeneration(true);
            if (state.conversations[state.activeConversationId]?.history.length === 0) dom.chatContainer.innerHTML = '';

            let userParts = [];
            if (userMessage) userParts.push({ text: userMessage });
            if (state.uploadedImage) userParts.push({ inlineData: { mimeType: 'image/jpeg', data: state.uploadedImage } });
            
            addMessage('user', userParts);
            
            const currentConv = state.conversations[state.activeConversationId];
            currentConv.history.push({ role: 'user', parts: userParts });
            if (currentConv.history.length === 1 && userMessage) { 
                currentConv.title = userMessage.split(' ').slice(0, 5).join(' '); 
                dom.chatTitle.textContent = currentConv.title;
                loadConversations(); 
            }
            
            dom.userInput.value = ''; state.uploadedImage = null; dom.imagePreviewContainer.innerHTML = ''; autoResizeTextarea();
            const loadingBubble = addMessage('model', [{ text: `<div class="typing-indicator"><span></span><span></span><span></span></div>` }]);
            loadingBubble.classList.add('message-thinking');
            const markdownContainer = loadingBubble.querySelector('.markdown-content');

            try {
                const model = "gemini-2.5-flash-preview-05-20";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?alt=sse&key=${state.apiKey}`;
                const systemPromptText = state.settings.persona === 'custom' ? state.settings.customSystemPrompt : (personas[state.settings.persona] || personas.default);
                const payload = { contents: currentConv.history, systemInstruction: { parts: [{ text: systemPromptText }] }, tools: [{ "google_search": {} }] };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: state.abortController.signal });
                if (!response.ok) throw new Error(`API Error: ${response.status}. ${await response.text()}`);

                const reader = response.body.getReader(); const decoder = new TextDecoder();
                let accumulatedResponse = ""; let firstChunk = true; let buffer = '';
                // inactivity timer to finalize partial streams
                let inactivityTimer = null;
                const resetInactivity = () => { if (inactivityTimer) clearTimeout(inactivityTimer); inactivityTimer = setTimeout(() => { /* finalize if no new data */ }, 900); };

                // stream-stall detection: show a small hint if no data for STALL_MS
                const STALL_MS = 4000; let stallTimer = null;
                function resetStallTimer(){ if (stallTimer) clearTimeout(stallTimer); stallTimer = setTimeout(() => {
                    try {
                        if (loadingBubble && !loadingBubble.querySelector('.stream-stall')) {
                            const hint = document.createElement('div'); hint.className = 'stream-stall text-sm text-yellow-300 mt-2';
                            hint.innerHTML = `Terhenti — <button class="regenerate-btn inline px-2 py-1 ml-2 rounded bg-yellow-500 text-black">Regenerate</button>`;
                            loadingBubble.appendChild(hint);
                        }
                    } catch(e){ /* ignore */ }
                }, STALL_MS); }

                // start stall timer
                resetStallTimer();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    resetInactivity();
                    if (firstChunk) { markdownContainer.innerHTML = ''; firstChunk = false; }
                    const chunk = decoder.decode(value, {stream: true});
                    buffer += chunk;
                    // split into lines, but keep partial last line in buffer
                    const rawLines = buffer.split('\n');
                    buffer = rawLines.pop();
                    for (const line of rawLines) {
                        const trimmed = line.trim();
                        if (!trimmed) continue;
                        const payload = trimmed.startsWith('data: ') ? trimmed.substring(6) : trimmed;
                        try {
                            const parsed = JSON.parse(payload);
                            const text = parsed?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                            if (text) accumulatedResponse += text;
                        } catch (e) {
                            // not JSON? append raw text heuristically
                            try { accumulatedResponse += payload.replace(/^\s*\[|\]\s*$/g,''); } catch(e){}
                        }
                    }
                    // data arrived: reset stall hint if present and restart timer
                    try { const s = loadingBubble && loadingBubble.querySelector('.stream-stall'); if (s) s.remove(); } catch(e){}
                    resetStallTimer();
                    markdownContainer.innerHTML = marked.parse(accumulatedResponse + '<span class="streaming-cursor"></span>');
                    scrollToBottom();
                }
                // finalize
                markdownContainer.innerHTML = marked.parse(accumulatedResponse);
                if (stallTimer) { clearTimeout(stallTimer); stallTimer = null; }
                // rudimentary truncated-response heuristic: if very short or does not end with typical punctuation
                const lastChar = accumulatedResponse.trim().slice(-1) || '';
                const truncated = (accumulatedResponse.trim().length < 40) || !['.','!','?', '\n'].includes(lastChar);
                if (truncated) {
                    const hint = document.createElement('div');
                    hint.className = 'mt-2 text-xs text-yellow-300';
                    hint.innerHTML = `Respons tampak belum lengkap. <button class="regenerate-btn inline px-2 py-1 ml-2 rounded bg-yellow-500 text-black">Regenerate</button>`;
                    markdownContainer.appendChild(hint);
                }
                currentConv.history.push({ role: 'model', parts: [{ text: accumulatedResponse }] });
                // swap animation state
                loadingBubble.classList.remove('message-thinking');
                loadingBubble.classList.add('message-appear');
                postProcessMessage(loadingBubble);
                saveAllData();

            } catch (error) {
                let errorMessage;
                if (error.name === 'AbortError') errorMessage = "*(Generasi dihentikan)*";
                else if (error.message.includes("400") || error.message.includes("API key not valid")) {
                    errorMessage = `**API Key Tidak Valid.**\n\nPastikan Anda telah memasukkan API Key yang benar. Dapatkan dari [Google AI Studio](https://aistudio.google.com/app/apikey).`;
                    showToast('API Key tidak valid!', 'error');
                } else {
                    errorMessage = `**Terjadi Kesalahan:**\n\`\`\`\n${error.message}\n\`\`\`\n`; console.error("API Error:", error);
                }
                markdownContainer.innerHTML = marked.parse(errorMessage);
                loadingBubble.classList.remove('message-thinking');
                loadingBubble.classList.add('message-appear');
            } finally {
                state.isGenerating = false; updateUIForGeneration(false);
            }
        }
        
        async function playTextToSpeech(textToSpeak, buttonElement) {
            if (!state.apiKey) return showApiKeyModal(showToast('API Key diperlukan untuk fitur TTS.', 'warning'));
            if (state.currentPlayingAudio) {
                state.currentPlayingAudio.pause();
                state.currentPlayingAudio = null;
                document.querySelectorAll('.tts-btn').forEach(btn => {
                     btn.innerHTML = `<i data-lucide="volume-2" class="w-4 h-4"></i>`;
                });
                 lucide.createIcons();
                if(buttonElement.dataset.playing === "true") {
                    buttonElement.dataset.playing = "false";
                    return;
                }
            }

            buttonElement.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
            buttonElement.dataset.playing = "true";
            lucide.createIcons();

            try {
                const cacheKey = btoa(textToSpeak).slice(0, 50);
                let audioDataB64 = ttsCacheGet(cacheKey);
                if (!audioDataB64) {
                    const model = "gemini-2.5-flash-preview-tts";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
                    const payload = { contents: [{ parts: [{ text: textToSpeak }] }], generationConfig: { responseModalities: ["AUDIO"] }};
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`TTS API Error: ${response.statusText}`);
                    const result = await response.json();
                    audioDataB64 = result.candidates[0].content.parts[0].inlineData.data;
                    ttsCacheSet(cacheKey, audioDataB64);
                }
                const pcmData = base64ToArrayBuffer(audioDataB64);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, 24000);
                const audioUrl = URL.createObjectURL(wavBlob);
                const audio = new Audio(audioUrl);
                state.currentPlayingAudio = audio;
                audio.play();
                buttonElement.innerHTML = `<i data-lucide="stop-circle" class="w-4 h-4"></i>`;
                lucide.createIcons();
                audio.onended = () => {
                    buttonElement.innerHTML = `<i data-lucide="volume-2" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                    state.currentPlayingAudio = null;
                     buttonElement.dataset.playing = "false";
                };
            } catch (error) {
                console.error("TTS Error:", error);
                showToast("Gagal memutar audio.", "error");
                buttonElement.innerHTML = `<i data-lucide="volume-x" class="w-4 h-4"></i>`;
                lucide.createIcons();
                 buttonElement.dataset.playing = "false";
            }
        }
        
        // --- HELPERS & UTILITIES ---
        // small utilities
        function debounce(fn, wait=300){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=> fn(...args), wait); }; }

        // Draft autosave per conversation
        function saveDraft(id, text){ try { const drafts = JSON.parse(localStorage.getItem('chimera_drafts')||'{}'); drafts[id]=text; localStorage.setItem('chimera_drafts', JSON.stringify(drafts)); } catch(e) { console.warn('draft save failed', e);} }
        function loadDraft(id){ try{ return JSON.parse(localStorage.getItem('chimera_drafts')||'{}')[id] || ''; }catch(e){ return ''; } }

        // pin conversations
        function togglePinConversation(id){ const conv = state.conversations[id]; if(!conv) return; conv.pinned = !conv.pinned; saveAllData(); loadConversations(); }

        // message versioning helpers
        function saveMessageVersion(convId, msgIndex, text){
            try{
                const conv = state.conversations[convId];
                if (!conv) return;
                conv.versions = conv.versions || {};
                conv.versions[msgIndex] = conv.versions[msgIndex] || [];
                conv.versions[msgIndex].push({ text, date: new Date().toISOString() });
                // keep last 10 versions
                if (conv.versions[msgIndex].length > 10) conv.versions[msgIndex].shift();
                saveAllData();
            }catch(e){ console.warn('save message version failed', e); }
        }

        function getMessageVersions(convId, msgIndex){ const conv = state.conversations[convId]; return (conv && conv.versions && conv.versions[msgIndex]) ? conv.versions[msgIndex] : []; }

        function showMessageHistoryModal(convId, msgIndex){
            const versions = getMessageVersions(convId, msgIndex);
            if (!versions.length) return showToast('Tidak ada riwayat untuk pesan ini.', 'warning');
            let listHTML = '<div class="p-4 space-y-2 max-h-64 overflow-auto">';
            versions.slice().reverse().forEach((v, i) => {
                listHTML += `<div class="p-3 border rounded-md bg-[var(--surface-primary)]"><div class="text-xs text-gray-400">${new Date(v.date).toLocaleString()}</div><pre class="whitespace-pre-wrap mt-2 text-sm">${escapeHtml(v.text)}</pre><div class="mt-2 text-right"><button data-rev="${versions.length-1-i}" data-idx="${msgIndex}" class="revert-version-btn px-3 py-1 rounded-md bg-blue-600 text-white">Revert</button></div></div>`;
            });
            listHTML += '</div>';
            showModal(`<div class="p-4"><h3 class="text-lg font-semibold mb-2">Riwayat Pesan</h3>${listHTML}</div>`, 'max-w-xl');
        }

        function revertMessageVersion(convId, msgIndex, versionIndex){
            const conv = state.conversations[convId];
            const versions = getMessageVersions(convId, msgIndex);
            if (!conv || !versions[versionIndex]) return showToast('Versi tidak ditemukan', 'error');
            // push current to versions before revert
            const current = conv.history[msgIndex]?.parts?.[0]?.text || '';
            saveMessageVersion(convId, msgIndex, current);
            conv.history[msgIndex].parts[0].text = versions[versionIndex].text;
            saveAllData();
            hideModal();
            renderConversation(convId);
            showToast('Pesan berhasil dikembalikan ke versi sebelumnya.');
        }

        function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function conversationToMarkdown(conv){
            let out = `# ${conv.title || 'Percakapan'}\n\n`;
            (conv.history || []).forEach(msg => {
                const role = msg.role === 'user' ? 'User' : 'Assistant';
                const text = (msg.parts||[]).map(p=> p.text || '').join('\n');
                out += `**${role}:**\n\n${text.replace(/\n/g,'\n\n')}\n\n---\n\n`;
            });
            return out;
        }

        function conversationToHTML(conv){
            const title = escapeHtml(conv.title || 'Percakapan');
            let body = `<h1>${title}</h1>`;
            (conv.history || []).forEach(msg => {
                const role = msg.role === 'user' ? 'User' : 'Assistant';
                const text = (msg.parts||[]).map(p=> escapeHtml(p.text || '')).join('\n');
                body += `<div style="margin-bottom:1rem"><strong>${role}:</strong><div style="white-space:pre-wrap;margin-top:0.5rem">${text}</div></div>`;
            });
            return `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title></head><body>${body}</body></html>`;
        }

        // sanitize filenames for downloads
        function sanitizeFilename(name){ return String(name).replace(/[^a-z0-9_\-\. ]/gi,'').replace(/\s+/g,'_').slice(0,200); }

        // simple encryption helpers for API key using WebCrypto (password-based)
        async function deriveKeyFromPassword(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
            return window.crypto.subtle.deriveKey({name:'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256'}, keyMaterial, {name:'AES-GCM', length: 256}, true, ['encrypt','decrypt']);
        }
        async function encryptWithPassword(password, data){ try{
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const key = await deriveKeyFromPassword(password, salt);
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const ct = await window.crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(data));
            const payload = {salt: Array.from(salt), iv: Array.from(iv), ct: Array.from(new Uint8Array(ct))};
            return btoa(JSON.stringify(payload));
        } catch(e){ console.warn('encrypt failed', e); return null; } }
        async function decryptWithPassword(password, b64){ try{ const raw = JSON.parse(atob(b64)); const salt = new Uint8Array(raw.salt); const iv = new Uint8Array(raw.iv); const ct = new Uint8Array(raw.ct); const key = await deriveKeyFromPassword(password, salt); const pt = await window.crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct); return new TextDecoder().decode(pt); } catch(e){ console.warn('decrypt failed', e); return null; } }

        // lazy-load Tesseract for OCR when needed
        let tesseractLoaded = false;
        async function ensureTesseract(){ if(tesseractLoaded) return; tesseractLoaded = true; const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js'; document.head.appendChild(s); await new Promise(r => s.onload = r); }

        // small TTS cache using sessionStorage
        function ttsCacheGet(key){ try{ return sessionStorage.getItem('tts_'+key); }catch(e){return null;} }
        function ttsCacheSet(key, data){ try{ sessionStorage.setItem('tts_'+key, data); }catch(e){} }

        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
        async function toggleFullscreen() {
            const el = dom.appContainer || document.documentElement;
            // If not in fullscreen, request it; otherwise exit. Update button only after success.
            if (!document.fullscreenElement) {
                try {
                    // vendor fallbacks for older browsers
                    if (el.requestFullscreen) await el.requestFullscreen();
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                    else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
                    else if (el.msRequestFullscreen) el.msRequestFullscreen();
                    dom.fullscreenBtn.innerHTML = `<i data-lucide="minimize"></i> Keluar Layar Penuh`;
                } catch (err) {
                    showToast(`Error memasuki layar penuh: ${err.message}`, 'error');
                }
            } else {
                try {
                    if (document.exitFullscreen) await document.exitFullscreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                    else if (document.msExitFullscreen) document.msExitFullscreen();
                    dom.fullscreenBtn.innerHTML = `<i data-lucide="maximize"></i> Layar Penuh`;
                } catch (err) {
                    showToast(`Error keluar layar penuh: ${err.message}`, 'error');
                }
            }
            lucide.createIcons();
        }
        function autoResizeTextarea() { const ta = dom.userInput; ta.style.height = 'auto'; ta.style.height = `${Math.min(ta.scrollHeight, 200)}px`; }
        function scrollToBottom(instant = false) { dom.chatContainer.scrollTo({ top: dom.chatContainer.scrollHeight, behavior: instant ? 'instant' : 'smooth' }); }
    function openSidebar() {
        dom.sidebar.classList.remove('-translate-x-full');
        dom.sidebarOverlay.classList.remove('hidden');
        try { dom.sidebarOverlay.style.pointerEvents = 'auto'; dom.sidebarOverlay.style.opacity = '0.6'; } catch(e){}
        try { document.documentElement.classList.add('sidebar-open'); } catch(e){}
        try { if (dom.sidebarToggle) dom.sidebarToggle.setAttribute('aria-expanded','true'); dom.sidebar.focus(); } catch(e){}
    }
    function closeSidebar() {
        dom.sidebar.classList.add('-translate-x-full');
        dom.sidebarOverlay.classList.add('hidden');
        try { dom.sidebarOverlay.style.pointerEvents = 'none'; dom.sidebarOverlay.style.opacity = '0'; } catch(e){}
        try { document.documentElement.classList.remove('sidebar-open'); } catch(e){}
        try { if (dom.sidebarToggle) dom.sidebarToggle.setAttribute('aria-expanded','false'); dom.sidebarToggle.focus(); } catch(e){}
    }

    // Toggle sidebar (open if closed, close if open) — bound to hamburger button
    function toggleSidebar() {
        try {
            if (!dom.sidebar) return;
            if (dom.sidebar.classList.contains('-translate-x-full')) openSidebar(); else closeSidebar();
        } catch(e) { console.warn('toggleSidebar failed', e); }
    }

    // Ensure initial translate state for mobile devices
    try { if (window.innerWidth <= 640) { dom.sidebar.classList.add('-translate-x-full'); } } catch(e){}

        // Lazy-load helper
        function loadScript(src){ return new Promise((resolve, reject) => { const s = document.createElement('script'); s.src = src; s.async = true; s.onload = () => resolve(); s.onerror = () => reject(new Error('Failed to load ' + src)); document.head.appendChild(s); }); }
        function loadCss(href){ return new Promise((resolve, reject) => { const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = href; l.onload = () => resolve(); l.onerror = () => reject(new Error('Failed to load ' + href)); document.head.appendChild(l); }); }

        async function highlightCodeInElement(el) {
            const blocks = el.querySelectorAll('pre code:not(.language-mermaid)');
            if (!blocks.length) return;
            if (typeof hljs === 'undefined') {
                try { await loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js'); } catch(e){ console.warn('Failed to load highlight.js', e); }
            }
            try { blocks.forEach(b => { try { hljs.highlightElement(b); } catch(e){} }); } catch(e){}
        }

        async function renderMathInElement(el) {
            // load KaTeX auto-render if needed
            if (typeof window.renderMathInElement === 'undefined') {
                try {
                    await loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js');
                } catch(e){ console.warn('Failed to load KaTeX auto-render', e); }
            }
            if (typeof window.renderMathInElement === 'function') {
                try {
                    window.renderMathInElement(el, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                } catch(e){ console.warn('KaTeX render failed', e); }
            }
        }

        async function renderMermaidDiagrams(el) {
            const mermaidElements = el.querySelectorAll('pre code.language-mermaid');
            if (!mermaidElements.length) return;
            if (typeof mermaid === 'undefined') {
                try { await loadScript('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js'); } catch(e){ console.warn('Failed to load mermaid', e); }
            }
            for (const codeElement of mermaidElements) {
                const pre = codeElement.parentElement;
                const container = document.createElement('div');
                container.className = 'mermaid my-4 p-4 flex justify-center items-center bg-white dark:bg-gray-800 rounded-lg';
                container.textContent = codeElement.textContent;
                pre.replaceWith(container);
                try { if (mermaid && mermaid.run) await mermaid.run({ nodes: [container] }); }
                catch(e) { container.innerHTML = `<p class="text-red-400">Error rendering diagram: ${e.message}</p>`; }
            }
        }
        
        function addCopyToCodeBlocks(bubble) {
            const codeBlocks = bubble.querySelectorAll('pre');
            codeBlocks.forEach(block => {
                if (block.querySelector('.language-mermaid')) return;
                block.classList.add('group/pre');
                const copyButton = document.createElement('button');
                copyButton.className = 'absolute top-2 right-2 p-1.5 bg-gray-700/50 rounded-md text-gray-300 hover:text-white hover:bg-gray-600/70 transition-all opacity-0 group-hover/pre:opacity-100';
                copyButton.title = 'Salin kode';
                copyButton.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
                
                block.appendChild(copyButton);

                copyButton.addEventListener('click', () => {
                    const code = block.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        showToast('Kode disalin ke clipboard!');
                        copyButton.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>';
                        setTimeout(() => {
                            copyButton.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
                            lucide.createIcons();
                        }, 2000);
                    }).catch(err => {
                        showToast('Gagal menyalin kode.', 'error');
                    });
                    lucide.createIcons();
                });
            });
            lucide.createIcons();
        }

        function base64ToArrayBuffer(base64) { const binary_string = window.atob(base64); const len = binary_string.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) { bytes[i] = binary_string.charCodeAt(i); } return bytes.buffer; }
        function pcmToWav(pcmData, sampleRate) { const numChannels = 1; const bitsPerSample = 16; const byteRate = sampleRate * numChannels * bitsPerSample / 8; const blockAlign = numChannels * bitsPerSample / 8; const dataSize = pcmData.length * pcmData.BYTES_PER_ELEMENT; const buffer = new ArrayBuffer(44 + dataSize); const view = new DataView(buffer); writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); writeString(view, 36, 'data'); view.setUint32(40, dataSize, true); const pcm16 = new Int16Array(buffer, 44); pcm16.set(pcmData); return new Blob([view], { type: 'audio/wav' }); }
        function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } }


        // --- EVENT LISTENERS ---

        function setupEventListeners() {
            if (dom.newChatBtn) dom.newChatBtn.addEventListener('click', createNewConversation);
            if (dom.sendButton) dom.sendButton.addEventListener('click', sendMessageToAI);
            if (dom.userInput) {
                dom.userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessageToAI(); } });
                dom.userInput.addEventListener('input', autoResizeTextarea);
            }
            // On mobile, when input is focused, ensure chat scrolls so input and recent messages are visible
            if (dom.userInput) dom.userInput.addEventListener('focus', () => {
                setTimeout(() => { try { if (dom.chatContainer) dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight; } catch(e){} }, 300);
            });
            // autosave draft (debounced)
            const saveDraftDebounced = debounce(() => { if (state.activeConversationId && dom.userInput) saveDraft(state.activeConversationId, dom.userInput.value); }, 700);
            if (dom.userInput) dom.userInput.addEventListener('input', saveDraftDebounced);
            // keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); dom.searchInput?.focus(); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendMessageToAI(); }
                if (e.key === 'Escape') { hideModal(); }
            });
            if (dom.sidebarToggle) dom.sidebarToggle.addEventListener('click', toggleSidebar);
            if (dom.sidebarClose) dom.sidebarClose.addEventListener('click', closeSidebar);
            if (dom.sidebarOverlay) dom.sidebarOverlay.addEventListener('click', closeSidebar);
            // Reset layout control (helpful when mobile layout gets stuck)
            const resetBtn = document.getElementById('reset-layout-btn'); if (resetBtn) resetBtn.addEventListener('click', restoreDefaultLayout);
            // ...existing code...
            if (dom.fullscreenBtn) dom.fullscreenBtn.addEventListener('click', toggleFullscreen);
            if (dom.apiKeyButton) dom.apiKeyButton.addEventListener('click', showApiKeyModal);
            if (dom.settingsButton) dom.settingsButton.addEventListener('click', showSettingsModal); else console.warn('settingsButton not found');
            // Sidebar delegated handler: use a single listener on the sidebar to ensure clicks
            // work even when inner SVGs/icons or dynamic elements intercept the event.
            if (dom.sidebar) {
                dom.sidebar.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn || !dom.sidebar.contains(btn)) return;
                    const id = btn.id;
                    // ensure overlays don't block when opening tools
                    const openAndUnblock = (fn) => { try { unblockOverlaysFullScreen(); } catch(e){} fn(); };
                    switch(id) {
                        case 'deep-research-btn': openAndUnblock(openDeepResearch); break;
                        case 'learning-btn': openAndUnblock(openLearning); break;
                        case 'canva-btn': openAndUnblock(openCanvaEditor); break;
                        case 'plugin-store-btn': openPluginStore(); break;
                        case 'collab-share-btn': openCollabShare(); break;
                        case 'dashboard-switch-btn': toggleDashboardMode(); break;
                        case 'workflow-btn': openWorkflowBuilder(); break;
                        case 'templates-btn': openTemplateLibrary(); break;
                        case 'badges-btn': showModal(`<div class="p-4"><h3 class="text-lg font-semibold">Badges</h3><pre>${JSON.stringify(badges.unlocked, null, 2)}</pre></div>`,'max-w-md'); break;
                        // leave other buttons to their direct listeners (if present)
                        default: break;
                    }
                    // close sidebar automatically on small screens after action
                    try { if (window.innerWidth < 768) closeSidebar(); } catch(e){}
                });
            } else {
                console.warn('Sidebar element not found for delegated tool handling');
            }

            // memory toggle
            const memToggle = document.getElementById('memory-toggle-input'); if (memToggle) memToggle.addEventListener('change', (e) => { memory.enabled = e.target.checked; saveMemory(); renderMemorySummary(); showToast(memory.enabled ? 'Memori AI diaktifkan' : 'Memori AI dinonaktifkan'); });
            // load memory on setup
            loadMemory();
            if (dom.themeToggle) dom.themeToggle.addEventListener('click', () => {
                const themes = ['dark','light','sunset'];
                const idx = themes.indexOf(state.currentTheme);
                state.currentTheme = themes[(idx + 1) % themes.length];
                localStorage.setItem('chimera_theme', state.currentTheme);
                updateThemeUI();
            });
            if (dom.stopGenerationBtn) dom.stopGenerationBtn.addEventListener('click', () => { if (state.abortController) state.abortController.abort(); });

            // multi-select toggle
            if (dom.multiSelectToggle) dom.multiSelectToggle.addEventListener('click', () => {
                state.multiSelectActive = !state.multiSelectActive;
                state.selectedConversations = {};
                dom.bulkActionBar.classList.toggle('hidden', !state.multiSelectActive);
                loadConversations();
            });

            if (dom.bulkCancelBtn) dom.bulkCancelBtn.addEventListener('click', () => {
                state.multiSelectActive = false; state.selectedConversations = {}; dom.bulkActionBar.classList.add('hidden'); loadConversations();
            });

            if (dom.bulkDeleteBtn) dom.bulkDeleteBtn.addEventListener('click', () => {
                const ids = Object.keys(state.selectedConversations).filter(id=> state.selectedConversations[id]);
                if (!ids.length) return showToast('Pilih percakapan terlebih dahulu', 'warning');
                showCustomConfirm('Hapus percakapan terpilih?', `Hapus ${ids.length} percakapan?`, () => {
                    ids.forEach(id => delete state.conversations[id]);
                    state.multiSelectActive = false; state.selectedConversations = {}; dom.bulkActionBar.classList.add('hidden'); saveAllData(); loadConversations(); showToast('Percakapan terhapus', 'warning');
                });
            });

            if (dom.bulkExportBtn) dom.bulkExportBtn.addEventListener('click', () => {
                const ids = Object.keys(state.selectedConversations).filter(id=> state.selectedConversations[id]);
                if (!ids.length) return showToast('Pilih percakapan terlebih dahulu', 'warning');
                ids.forEach(id => { const conv = state.conversations[id]; const blob = new Blob([JSON.stringify(conv, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${conv.title || id}.json`; a.click(); URL.revokeObjectURL(url); });
                showToast('Ekspor selesai');
            });

            if (dom.bulkPinBtn) dom.bulkPinBtn.addEventListener('click', () => {
                const ids = Object.keys(state.selectedConversations).filter(id=> state.selectedConversations[id]);
                if (!ids.length) return showToast('Pilih percakapan terlebih dahulu', 'warning');
                ids.forEach(id => { const c = state.conversations[id]; if (c) c.pinned = !c.pinned; });
                state.multiSelectActive = false; state.selectedConversations = {}; dom.bulkActionBar.classList.add('hidden'); saveAllData(); loadConversations(); showToast('Toggle pin diterapkan');
            });

            // delegated checkbox changes
            if (dom.conversationHistory) dom.conversationHistory.addEventListener('change', (e) => {
                const cb = e.target.closest('.conv-select-checkbox');
                if (!cb) return;
                const id = cb.dataset.id;
                state.selectedConversations[id] = cb.checked;
            });
            
            if (dom.imageUploadInput) dom.imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    state.uploadedImage = await fileToBase64(file);
                    dom.imagePreviewContainer.innerHTML = `
                        <div class="relative inline-block">
                            <img src="${URL.createObjectURL(file)}" class="h-14 w-14 object-cover rounded-md">
                            <div class="absolute right-0 top-0 flex gap-1">
                                <button id="remove-image-btn" class="bg-red-500 text-white rounded-full p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                            </div>
                            <button id="ocr-image-btn" class="mt-1 w-full text-xs bg-blue-600 text-white rounded-md px-2 py-1">OCR</button>
                        </div>`;
                    lucide.createIcons();
                }
            });

            if (state.recognition && dom.micBtn) {
                dom.micBtn.addEventListener('click', () => { dom.micBtn.classList.add('mic-listening'); state.recognition.start(); });
                state.recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; dom.userInput.value = transcript; autoResizeTextarea(); };
                state.recognition.onerror = (event) => { showToast(`Error pengenalan suara: ${event.error}`, 'error'); };
                state.recognition.onend = () => { dom.micBtn.classList.remove('mic-listening'); };
            }

            document.body.addEventListener('click', (e) => {
                // close modal when clicking on the backdrop itself (not when clicking inside modal content)
                // (use strict equality to avoid treating clicks inside modal as backdrop clicks)
                if (e.target === dom.modalBackdrop) { hideModal(); return; }
                // if a modal is currently visible, avoid the generic "click outside" fallback which
                // can mistakenly close the modal when clicking interactive elements inside it.
                const modalOpen = dom.modalBackdrop && !dom.modalBackdrop.classList.contains('opacity-0');
                if (!modalOpen) {
                    // only apply the old outside-click fallback when no modal is open
                    if (!e.target.closest('div[class*="max-w-"]') && !e.target.closest('#api-key-button') && !e.target.closest('#settings-button') && !e.target.closest('#modal-backdrop')) { hideModal(); }
                }
                if (e.target.id === 'close-modal-button' || e.target.id === 'close-settings-button') hideModal();

                // delegated fallback for new tools (in case direct binding failed)
                const dr = e.target.closest('#deep-research-btn');
                if (dr) { try { unblockOverlaysFullScreen(); } catch(e){} openDeepResearch(); }
                const lrn = e.target.closest('#learning-btn');
                if (lrn) { try { unblockOverlaysFullScreen(); } catch(e){} openLearning(); }
                const cnv = e.target.closest('#canva-btn');
                if (cnv) { try { unblockOverlaysFullScreen(); } catch(e){} openCanvaEditor(); }
                
                if (e.target.id === 'save-api-key-button') {
                    (async () => {
                        const newKey = document.getElementById('api-key-input').value.trim();
                        if (!newKey) return showToast('API Key tidak boleh kosong.', 'error');
                        const shouldEncrypt = document.getElementById('encrypt-api-key')?.checked;
                        if (shouldEncrypt) {
                            const pw = prompt('Masukkan password untuk mengenkripsi API Key (ingat password ini):');
                            if (!pw) return showToast('Enkripsi dibatalkan. Password tidak boleh kosong.', 'error');
                            const blob = await encryptWithPassword(pw, newKey);
                            if (!blob) return showToast('Gagal mengenkripsi API Key.', 'error');
                            state.apiKey = blob;
                            saveAllData();
                            updateApiKeyUI();
                            hideModal();
                            showToast('API Key tersimpan (terenkripsi). Ingat password untuk membuka.');
                        } else {
                            state.apiKey = newKey;
                            saveAllData();
                            updateApiKeyUI();
                            hideModal();
                            showToast('API Key berhasil disimpan!');
                        }
                    })();
                }
                if (e.target.id === 'save-settings-button') { state.settings.persona = document.getElementById('persona-select').value; state.settings.customSystemPrompt = document.getElementById('system-prompt-input').value; saveAllData(); hideModal(); showToast('Pengaturan disimpan!'); }
                if (e.target.closest('#persona-select')) { document.getElementById('custom-prompt-container').classList.toggle('hidden', e.target.value !== 'custom'); }

                if (e.target.id === 'unlock-api-key-btn') {
                    (async () => {
                        const pw = prompt('Masukkan password untuk membuka API Key terenkripsi:');
                        if (!pw) return showToast('Password dibatalkan.', 'error');
                        const decrypted = await decryptWithPassword(pw, state.apiKey);
                        if (!decrypted) return showToast('Password salah atau dekripsi gagal.', 'error');
                        state.apiKey = decrypted; // keep decrypted in session
                        updateApiKeyUI();
                        hideModal();
                        showToast('API Key berhasil didekripsi untuk sesi ini.');
                    })();
                }

                if (e.target.id === 'reset-all-settings-btn') { showCustomConfirm('Reset Semua Data?', 'Ini akan menghapus semua riwayat percakapan dan pengaturan, termasuk API Key Anda. Aksi ini tidak bisa dibatalkan.', () => { localStorage.clear(); initState(); updateApiKeyUI(); loadConversations(); createNewConversation(); showToast('Semua data telah direset.', 'warning'); }); }
                if (e.target.id === 'export-chat-btn') { const data = JSON.stringify(state.conversations, null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `chimera-v7-all-chats.json`; a.click(); URL.revokeObjectURL(url); showToast('Semua percakapan diekspor!'); }
                if (e.target.id === 'export-single-chat-btn') {
                    const conv = state.conversations[state.activeConversationId]; if (!conv) return showToast('Tidak ada percakapan aktif', 'error');
                    const content = `
                        <div class="p-6">
                            <h2 class="text-xl font-bold mb-2">Ekspor Percakapan</h2>
                            <p class="text-sm text-gray-400 mb-4">Pilih format ekspor untuk percakapan: Markdown (.md), HTML (.html), atau Cetak ke PDF.</p>
                            <div class="flex gap-2">
                                <button id="export-md-btn" class="px-3 py-2 rounded-md bg-gray-700 text-white">Export Markdown</button>
                                <button id="export-html-btn" class="px-3 py-2 rounded-md bg-gray-600 text-white">Export HTML</button>
                                <button id="export-pdf-btn" class="px-3 py-2 rounded-md bg-blue-600 text-white">Cetak / Save as PDF</button>
                            </div>
                        </div>
                    `;
                    showModal(content, 'max-w-md');
                }
                if (e.target.id === 'export-md-btn') {
                    const conv = state.conversations[state.activeConversationId]; if (!conv) return showToast('Tidak ada percakapan aktif', 'error');
                    const md = conversationToMarkdown(conv);
                    const blob = new Blob([md], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${conv.title || 'chat'}.md`; a.click(); URL.revokeObjectURL(url); showToast('Markdown diekspor!'); hideModal();
                }
                if (e.target.id === 'export-html-btn') {
                    const conv = state.conversations[state.activeConversationId]; if (!conv) return showToast('Tidak ada percakapan aktif', 'error');
                    const html = conversationToHTML(conv);
                    const blob = new Blob([html], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${conv.title || 'chat'}.html`; a.click(); URL.revokeObjectURL(url); showToast('HTML diekspor!'); hideModal();
                }
                if (e.target.id === 'export-pdf-btn') {
                    const conv = state.conversations[state.activeConversationId]; if (!conv) return showToast('Tidak ada percakapan aktif', 'error');
                    try {
                        const rawHtml = conversationToHTML(conv);
                        // create container
                        const container = document.createElement('div');
                        container.style.padding = '20px';
                        container.style.fontFamily = 'Inter, Arial, sans-serif';
                        container.innerHTML = rawHtml;

                        // basic print styles
                        const style = document.createElement('style');
                        style.textContent = `body { color: #0f172a; } h1 { font-size: 20px; margin-bottom: 8px; } pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }`;
                        container.prepend(style);

                        const opt = {
                            margin:       10,
                            filename:     sanitizeFilename(`${conv.title || 'chat'}.pdf`),
                            image:        { type: 'jpeg', quality: 0.98 },
                            html2canvas:  { scale: 2, useCORS: true },
                            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };
                        hideModal();
                        showToast('Menghasilkan PDF — tunggu sebentar...', 'warning');
                        (async () => {
                            await html2pdf().set(opt).from(container).save();
                            showToast('PDF berhasil dibuat dan diunduh!');
                        })();
                    } catch(err) {
                        console.error('PDF export error', err);
                        showToast('Gagal membuat PDF.', 'error');
                    }
                }
                if (e.target.id === 'search-input') { /* handled by input event */ }
                
                const copyBtn = e.target.closest('.copy-response-btn');
                if (copyBtn) { const text = copyBtn.closest('.group').querySelector('.markdown-content').innerText; navigator.clipboard.writeText(text).then(() => showToast('Respons disalin!')).catch(() => showToast('Gagal menyalin', 'error')); }
                
                const ttsBtn = e.target.closest('.tts-btn');
                if (ttsBtn) { const text = ttsBtn.closest('.group').querySelector('.markdown-content').innerText; playTextToSpeech(text, ttsBtn); }

                const regenBtn = e.target.closest('.regenerate-btn');
                if (regenBtn) {
                    // find last user message in active conversation
                    const conv = state.conversations[state.activeConversationId];
                    if (!conv || !conv.history) return showToast('Tidak ada percakapan aktif', 'error');
                    // search backwards for last user role
                    for (let i = conv.history.length -1; i >=0; i--) {
                        if (conv.history[i].role === 'user') {
                            const text = (conv.history[i].parts||[]).map(p=>p.text||'').join('\n');
                            if (text) {
                                dom.userInput.value = text; autoResizeTextarea(); sendMessageToAI();
                                showToast('Regenerating respons untuk pesan terakhir...','warning');
                            }
                            break;
                        }
                    }
                }

                const editBtn = e.target.closest('.edit-message-btn');
                if (editBtn) {
                    const idx = Number(editBtn.dataset.index);
                    const conv = state.conversations[state.activeConversationId];
                    if (!conv || !conv.history[idx]) return showToast('Pesan tidak ditemukan.', 'error');
                    const current = conv.history[idx].parts[0].text || '';
                    const newText = prompt('Edit pesan:', current);
                    if (newText !== null) {
                        // save previous version
                        saveMessageVersion(state.activeConversationId, idx, current);
                        conv.history[idx].parts[0].text = newText;
                        saveAllData();
                        renderConversation(state.activeConversationId);
                        showToast('Pesan diperbarui. Versi lama disimpan.');
                    }
                }

                const delMsgBtn = e.target.closest('.delete-message-btn');
                if (delMsgBtn) {
                    const idx = Number(delMsgBtn.dataset.index);
                    const conv = state.conversations[state.activeConversationId];
                    if (!conv || !conv.history[idx]) return showToast('Pesan tidak ditemukan.', 'error');
                    showCustomConfirm('Hapus pesan?', 'Anda yakin ingin menghapus pesan ini?', () => {
                        conv.history.splice(idx, 1);
                        saveAllData();
                        renderConversation(state.activeConversationId);
                        showToast('Pesan dihapus.', 'warning');
                    });
                }
                const historyBtn = e.target.closest('.history-message-btn');
                if (historyBtn) {
                    const idx = Number(historyBtn.dataset.index);
                    showMessageHistoryModal(state.activeConversationId, idx);
                }

                const revertBtn = e.target.closest('.revert-version-btn');
                if (revertBtn) {
                    const idx = Number(revertBtn.dataset.idx);
                    const rev = Number(revertBtn.dataset.rev);
                    revertMessageVersion(state.activeConversationId, idx, rev);
                }
                const welcomeBtn = e.target.closest('.welcome-prompt-btn');
                if(welcomeBtn) { dom.userInput.value = welcomeBtn.dataset.prompt; sendMessageToAI(); }

                // OCR button
                if (e.target.closest('#ocr-image-btn')) {
                    (async () => {
                        const ocrBtn = e.target.closest('#ocr-image-btn');
                        try {
                            await ensureTesseract();
                            showToast('Memproses OCR...');
                            const img = ocrBtn.closest('div').querySelector('img');
                            const worker = Tesseract.createWorker();
                            await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
                            const { data: { text } } = await worker.recognize(img.src);
                            await worker.terminate();
                            dom.userInput.value = (dom.userInput.value ? dom.userInput.value + '\n' : '') + text;
                            autoResizeTextarea();
                            showToast('OCR selesai, teks ditambahkan ke input');
                        } catch(e) { console.error('OCR error', e); showToast('Gagal melakukan OCR', 'error'); }
                    })();
                }

                if (e.target.closest('#remove-image-btn')) { state.uploadedImage = null; dom.imagePreviewContainer.innerHTML = ''; dom.imageUploadInput.value = ''; }
            });

            // Refresh UI when entering/exiting fullscreen to avoid broken icons/editor
            function onFullScreenChange() {
                try { lucide.createIcons(); mermaid.initialize({ startOnLoad: false, theme: state.currentTheme }); }
                catch(e){ console.warn('refresh after fullscreen failed', e); }
                // if Canva modal open, try to re-render preview
                const canvaPreview = document.getElementById('canva-preview');
                if (canvaPreview && window.DOMPurify) {
                    try { canvaPreview.innerHTML = DOMPurify.sanitize(canvaPreview.innerHTML); } catch(e) { /* ignore */ }
                }
                // attempt to re-init ACE if present
                try { if (typeof ace !== 'undefined' && document.getElementById('ace-editor')) ace.edit('ace-editor').resize(); } catch(e) { /* ignore */ }
                // ensure overlays do not block clicks in fullscreen if no modal is visible
                try {
                    const modalVisible = !dom.modalBackdrop.classList.contains('opacity-0');
                    if (!modalVisible) {
                        dom.sidebarOverlay.classList.add('hidden');
                        // only set pointer-events none on backdrop when no modal present
                        dom.modalBackdrop.classList.add('pointer-events-none');
                    } else {
                        dom.modalBackdrop.classList.remove('pointer-events-none');
                        try { dom.modalBackdrop.style.pointerEvents = 'auto'; } catch(e){}
                    }
                } catch(e) { /* ignore */ }
                // aggressive disable of large blocking elements when entering fullscreen
                try {
                    const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
                    // toggle a class on the root to allow CSS rules to adjust layout
                    document.documentElement.classList.toggle('in-fullscreen', isFs);
                    // sync aria and button text/icon if available
                    if (dom.fullscreenBtn) {
                        dom.fullscreenBtn.setAttribute('aria-pressed', String(isFs));
                        dom.fullscreenBtn.innerHTML = isFs ? `<i data-lucide="minimize"></i> Keluar Layar Penuh` : `<i data-lucide="maximize"></i> Layar Penuh`;
                        lucide.createIcons();
                    }
                    if (isFs) {
                        aggressiveDisableBlockingOverlays();
                    } else {
                        aggressiveRestoreBlockingOverlays();
                    }
                } catch(e) { console.warn('aggressive overlay toggle failed', e); }
            }

            // Register standard and vendor-prefixed fullscreenchange events for broader compatibility
            try {
                document.addEventListener('fullscreenchange', onFullScreenChange);
                document.addEventListener('webkitfullscreenchange', onFullScreenChange);
                document.addEventListener('mozfullscreenchange', onFullScreenChange);
                document.addEventListener('MSFullscreenChange', onFullScreenChange);
            } catch(e) { /* ignore if not supported */ }

                    // helper to force-hide overlays that may block clicks in fullscreen
                    function unblockOverlaysFullScreen() {
                        try {
                            if (dom.sidebarOverlay) {
                                dom.sidebarOverlay.classList.add('hidden');
                                dom.sidebarOverlay.style.pointerEvents = 'none';
                            }
                            if (dom.modalBackdrop) {
                                // only hide backdrop if no modal is currently open
                                if (!dom.modalBackdrop.dataset.modalOpen) {
                                    dom.modalBackdrop.classList.add('opacity-0');
                                    dom.modalBackdrop.classList.add('pointer-events-none');
                                    dom.modalBackdrop.style.pointerEvents = 'none';
                                }
                            }
                        } catch(e) { console.warn('unblock overlays failed', e); }
                    }

                    // --- aggressive fullscreen overlay handler ---
                    // Track overlays we hide when entering fullscreen so we can restore them later.
                    // Use a Map instead of WeakMap to allow iteration and clearing.
                    let _fsDisabled = new Map();
                    function aggressiveDisableBlockingOverlays() {
                        try {
                            const vw = window.innerWidth, vh = window.innerHeight;
                            const els = Array.from(document.body.querySelectorAll('*'));
                            for (const el of els) {
                                if (!el.offsetParent && getComputedStyle(el).position === 'fixed') {
                                    // continue - maybe small hidden fixed elements
                                }
                                const rect = el.getBoundingClientRect();
                                if (rect.width <= 0 || rect.height <= 0) continue;
                                const area = rect.width * rect.height; const viewArea = vw * vh;
                                // if element covers more than half viewport and is not the app container or sidebar
                                if (area / viewArea > 0.5 && !el.closest('#app-container') && !el.closest('#sidebar')) {
                                    // store original inline styles
                                    const orig = { display: el.style.display || '', visibility: el.style.visibility || '', pointerEvents: el.style.pointerEvents || '' };
                                    _fsDisabled.set(el, orig);
                                    el.style.display = 'none';
                                    el.style.pointerEvents = 'none';
                                    el.style.visibility = 'hidden';
                                    // aggressive disabled overlay (hidden in fullscreen)
                                }
                            }
                        } catch(e) { console.warn('aggressiveDisable error', e); }
                    }

                    function aggressiveRestoreBlockingOverlays() {
                        try {
                            _fsDisabled.forEach((orig, el) => {
                                try { el.style.display = orig.display; el.style.visibility = orig.visibility; el.style.pointerEvents = orig.pointerEvents; } catch(e){}
                            });
                            // clear map by creating a fresh Map
                            _fsDisabled = new Map();
                        } catch(e) { console.warn('aggressiveRestore error', e); }
                    }

                    // --- click inspector (debugging) ---
                    let clickInspectorActive = false;
                    let inspectorOverlay = null;
                    function toggleClickInspector() {
                        clickInspectorActive = !clickInspectorActive;
                        if (!clickInspectorActive) {
                            if (inspectorOverlay) { inspectorOverlay.remove(); inspectorOverlay = null; }
                            document.removeEventListener('click', clickInspectorHandler, true);
                            showToast('Inspector klik dimatikan', 'success');
                            return;
                        }
                        inspectorOverlay = document.createElement('div');
                        inspectorOverlay.style.position = 'fixed'; inspectorOverlay.style.left = 0; inspectorOverlay.style.top = 0; inspectorOverlay.style.right = 0; inspectorOverlay.style.bottom = 0; inspectorOverlay.style.pointerEvents = 'none'; inspectorOverlay.style.zIndex = 9999999;
                        document.body.appendChild(inspectorOverlay);
                        document.addEventListener('click', clickInspectorHandler, true);
                        showToast('Inspector klik aktif: klik elemen untuk melihat info (ESC untuk tutup)', 'success');
                    }

            // -----------------------------------------------------------------
            // Accessibility: sr-only helper and aria-live region for screen readers
            // -----------------------------------------------------------------
            (function addA11yHelpers(){
                try {
                    const style = document.createElement('style');
                    style.id = 'sr-only-style';
                    style.textContent = `.sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.aria-live-region{position:fixed;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}`;
                    document.head.appendChild(style);
                    const live = document.createElement('div');
                    live.className = 'aria-live-region';
                    live.setAttribute('aria-live','polite');
                    live.setAttribute('id','aria-live');
                    live.setAttribute('aria-atomic','true');
                    document.body.appendChild(live);
                } catch(e){ console.warn('a11y helper init failed', e); }
            })();

            // -----------------------------------------------------------------
            // Smoke-check & lucide icons refresh (runs once on DOMContentLoaded)
            // -----------------------------------------------------------------
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const requiredIds = ['chat-container','user-input','send-button','mic-btn','image-upload-input','toast-container'];
                    const missing = requiredIds.filter(id => !document.getElementById(id));
                    if (missing.length) {
                        console.warn('Smoke-check: missing required DOM ids:', missing);
                        showToast('Beberapa elemen UI mungkin hilang: ' + missing.join(', '), 'warning');
                    } else {
                        console.log('Smoke-check: all required UI ids present.');
                        showToast('UI smoke-check OK', 'success');
                    }

                    // Re-init lucide icons if loaded (robust call)
                    try {
                        if (window.lucide && typeof window.lucide.replace === 'function') {
                            window.lucide.replace();
                            console.log('lucide icons re-initialized via replace().');
                        } else if (window.lucide && typeof window.lucide.createIcons === 'function') {
                            window.lucide.createIcons();
                            console.log('lucide.createIcons() called.');
                        }
                    } catch(e){ console.warn('lucide reinit failed', e); }

                    // Ensure critical control icons have inline SVG fallbacks for reliability
                    try {
                        const svgs = {
                            send: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                            mic: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="9" y="2" width="6" height="11" rx="3" stroke="currentColor" stroke-width="2"/><path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19v3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                            paperclip: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21.44 11.05l-8.49 8.49a5 5 0 0 1-7.07-7.07L12 6.88a3.5 3.5 0 0 1 4.95 4.95L10.5 18.28a2 2 0 1 1-2.83-2.83L15 8.22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                        };
                        function ensureInlineIcon(el, key){ if(!el) return; if (el.querySelector && el.querySelector('svg')) return; const container = document.createElement('span'); container.innerHTML = svgs[key] || ''; el.prepend(container.firstChild); }
                        ensureInlineIcon(document.querySelector('#send-button'), 'send');
                        ensureInlineIcon(document.querySelector('#mic-btn'), 'mic');
                        ensureInlineIcon(document.querySelector('label[for="image-upload-input"]'), 'paperclip');
                    } catch(e){ console.warn('inline SVG fallback failed', e); }

                    // simple console-level smoke check for errors during init
                    setTimeout(() => {
                        if (window.__recentConsoleErrors && window.__recentConsoleErrors.length) {
                            console.warn('Detected recent console errors during init', window.__recentConsoleErrors.slice(-10));
                            showToast('Terjadi beberapa error JavaScript (lihat console)', 'error');
                        }
                    }, 800);
                } catch(e) { console.error('Smoke-check failed', e); }
            });

            // capture console.error for short window for smoke diagnostics
            (function captureConsoleErrors(){
                try {
                    window.__recentConsoleErrors = window.__recentConsoleErrors || [];
                    const origErr = console.error.bind(console);
                    console.error = function(){ window.__recentConsoleErrors.push({args: Array.from(arguments), ts: Date.now()}); origErr.apply(null, arguments); };
                } catch(e) { /* ignore */ }
            })();

            // -----------------------------------------------------------------
            // Reduced motion: respect user preference and tone-down animations
            // -----------------------------------------------------------------
            (function applyReducedMotion(){
                try {
                    const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
                    function setReduced(reduced){
                        if (reduced) document.documentElement.classList.add('reduced-motion');
                        else document.documentElement.classList.remove('reduced-motion');
                    }
                    setReduced(mq.matches);
                    if (mq.addEventListener) mq.addEventListener('change', e => setReduced(e.matches));
                    else if (mq.addListener) mq.addListener(e => setReduced(e.matches));
                    // add CSS rule to reduce animation durations when class is present
                    const rmStyle = document.createElement('style');
                    rmStyle.id = 'reduced-motion-style';
                    rmStyle.textContent = `.reduced-motion * { animation-duration: 150ms !important; transition-duration: 120ms !important; }
                        .reduced-motion .message-appear { animation-duration: 100ms !important; }
                        .reduced-motion .typing-indicator { display:none !important; }`;
                    document.head.appendChild(rmStyle);
                } catch(e) { /* ignore */ }
            })();

            // Haptic / press feedback helper
            (function addHaptics(){
                try {
                    function vibrateIfSupported(ms){ if ('vibrate' in navigator) { try { navigator.vibrate(ms); } catch(e){} } }
                    document.addEventListener('pointerdown', (e) => {
                        const btn = e.target.closest('button, .btn, #send-button, #mic-btn');
                        if (!btn) return;
                        btn.classList.add('touch-press');
                        vibrateIfSupported(10);
                    }, {passive:true});
                    document.addEventListener('pointerup', (e) => {
                        const btn = e.target.closest('button, .btn, #send-button, #mic-btn');
                        if (btn) btn.classList.remove('touch-press');
                    });
                } catch(e) { console.warn('haptics helper init failed', e); }
            })();
                    function clickInspectorHandler(e) {
                        e.stopPropagation(); e.preventDefault();
                        const el = e.target;
                        const rect = el.getBoundingClientRect();
                        if (inspectorOverlay) inspectorOverlay.innerHTML = '';
                        const box = document.createElement('div');
                        box.style.position = 'absolute'; box.style.left = `${rect.left}px`; box.style.top = `${rect.top}px`;
                        box.style.width = `${rect.width}px`; box.style.height = `${rect.height}px`;
                        box.style.border = '3px solid rgba(255,0,0,0.9)'; box.style.background = 'rgba(255,0,0,0.08)'; box.style.pointerEvents = 'none';
                        inspectorOverlay.appendChild(box);
                        console.log('Inspector clicked element', el, 'rect', rect, 'computedStyle', getComputedStyle(el));
                        showToast(`Element: ${el.tagName.toLowerCase()} id=${el.id || '-'} class=${el.className || '-'} top=${Math.round(rect.top)}`, 'success');
                    }

                    // toggle inspector with Ctrl+Shift+D
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.shiftKey && e.code === 'KeyD') { toggleClickInspector(); }
                        if (e.key === 'Escape' && clickInspectorActive) { toggleClickInspector(); }
                    });

            // search input listener (debounced)
            if (dom.searchInput) dom.searchInput.addEventListener('input', debounce(() => loadConversations(), 250));

            // register service worker if available
            if ('serviceWorker' in navigator) {
                try { navigator.serviceWorker.register('sw.js'); console.info('Service worker registered'); } catch(e) { console.warn('SW registration failed', e); }
            }
        }
        
        init();
    });
    </script>
</body>
</html>
