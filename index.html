<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Chimera v2.2 - Asisten AI Canggih</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.min.js"></script>

    <style>
        :root {
            --bg-dark: #020617; --bg-light: #f8fafc;
            --surface-dark: #0f172a; --surface-light: #ffffff;
            --text-dark: #e2e8f0; --text-light: #0f172a;
            --border-dark: #1e293b; --border-light: #cbd5e1;
            --accent: #3b82f6; --accent-hover: #2563eb;
            --font-body: 'Inter', sans-serif;
            --font-header: 'Orbitron', sans-serif;
        }
        html.dark {
            color-scheme: dark;
            --bg-primary: var(--bg-dark); --surface-primary: var(--surface-dark);
            --text-primary: var(--text-dark); --border-primary: var(--border-dark);
        }
        html.light {
            color-scheme: light;
            --bg-primary: var(--bg-light); --surface-primary: var(--surface-light);
            --text-primary: var(--text-light); --border-primary: var(--border-light);
        }
        body {
            font-family: var(--font-body); background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color 0.5s, color 0.5s;
            overflow: hidden;
        }
        h1, h2, h3 { font-family: var(--font-header); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(128, 128, 128, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box;}
        .glass-effect {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px); border: 1px solid var(--border-primary);
        }
        html.light .glass-effect { background: rgba(255, 255, 255, 0.6); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes background-pan {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animated-bg {
            background: linear-gradient(90deg, var(--bg-dark), #0f172a, var(--bg-dark));
            background-size: 200% 200%;
            animation: background-pan 15s ease infinite;
        }
        html.light .animated-bg {
             background: linear-gradient(90deg, var(--bg-light), #e2e8f0, var(--bg-light));
             background-size: 200% 200%;
        }
        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1.2em;
            background-color: var(--text-primary);
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .markdown-content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .markdown-content th, .markdown-content td { border: 1px solid var(--border-primary); padding: 0.75rem; }
        .markdown-content th { background-color: var(--surface-primary); }
        
        @keyframes typing-dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .thinking-indicator::after {
            content: '.';
            animation: typing-dots 1.4s linear infinite;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app-container" class="h-screen w-screen flex animated-bg">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-black/30 h-full flex flex-col w-72 p-4 transition-all duration-300 ease-in-out -translate-x-full md:translate-x-0 md:relative absolute z-30">
            <div class="flex items-center justify-between mb-4">
                 <h2 class="text-xl font-bold tracking-wider">CHIMERA</h2>
                 <button id="sidebar-close" class="md:hidden p-1 rounded-full hover:bg-white/10"><i data-lucide="x"></i></button>
            </div>
            <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full p-2.5 rounded-lg bg-[var(--accent)] text-white font-semibold hover:bg-[var(--accent-hover)] transition-all duration-200 transform hover:scale-105 active:scale-100">
                <i data-lucide="plus"></i> Obrolan Baru
            </button>
            <div id="conversation-history" class="mt-4 flex-1 overflow-y-auto pr-2 space-y-2"></div>
            <div class="pt-4 border-t border-[var(--border-primary)] space-y-1">
                <button id="fullscreen-btn" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="maximize"></i> Layar Penuh</button>
                <button id="settings-button" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="settings"></i> Pengaturan</button>
                <button id="theme-toggle" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="sun"></i> <span id="theme-text">Mode Terang</span></button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full relative">
             <button id="sidebar-toggle" class="md:hidden absolute top-4 left-4 z-20 p-2 bg-black/40 backdrop-blur-sm rounded-md hover:bg-white/20 transition-all"><i data-lucide="menu"></i></button>
            <main class="flex-1 flex flex-col glass-effect m-2 md:m-4 rounded-2xl overflow-hidden shadow-2xl">
                <!-- Chat Area -->
                <div id="chat-container" class="flex-1 p-4 sm:p-6 space-y-6 overflow-y-auto">
                    <!-- Welcome or Chat Messages will be rendered here -->
                </div>

                <!-- Input Footer -->
                <footer class="p-4 border-t border-[var(--border-primary)] shrink-0 space-y-3">
                    <div id="stop-generation-container" class="text-center hidden">
                         <button id="stop-generation-btn" class="px-4 py-1.5 text-sm border border-yellow-500/50 text-yellow-300 rounded-lg hover:bg-yellow-500/20 transition-colors flex items-center gap-2 mx-auto">
                            <i data-lucide="square" class="w-4 h-4"></i> Hentikan Generasi
                         </button>
                    </div>
                    <div id="image-preview-container" class="flex gap-2 items-center"></div>
                    <div class="flex items-end gap-2 sm:gap-3">
                        <label for="image-upload-input" class="p-3 rounded-full hover:bg-white/10 cursor-pointer transition-colors" title="Unggah gambar">
                            <i data-lucide="paperclip"></i>
                        </label>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                        
                        <div class="flex-1 relative">
                            <textarea id="user-input" placeholder="Ketik pesan atau unggah gambar..." class="w-full p-3 pl-4 pr-12 border border-[var(--border-primary)] rounded-2xl bg-transparent focus:outline-none focus:ring-2 focus:ring-[var(--accent)] transition-all resize-none" rows="1"></textarea>
                            <button id="mic-btn" class="absolute right-4 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-white transition-colors" title="Input suara">
                                <i data-lucide="mic"></i>
                            </button>
                        </div>

                        <button type="submit" id="send-button" class="bg-[var(--accent)] text-white p-3 rounded-full shadow-lg transition-all transform hover:scale-110 hover:bg-[var(--accent-hover)] active:scale-100 disabled:bg-gray-500 disabled:scale-100 disabled:cursor-not-allowed">
                            <i data-lucide="send"></i>
                        </button>
                    </div>
                </footer>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4 transition-opacity duration-300"></div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>
    
    <script>
    // ===================================================================================
    // Project Chimera v2.2 - Asisten AI Canggih
    // Changelog:
    // - [FIX] Perbaikan logika penghapusan obrolan, memilih obrolan terbaru.
    // - [ADD] Fitur menyematkan (pin) obrolan di bagian atas.
    // - [OPT] Proses respons AI terasa lebih cepat dengan streaming simulasi yang dioptimalkan.
    // - [FIX] Mode layar penuh lebih robust, menangani keluar dengan tombol ESC.
    // ===================================================================================
    document.addEventListener('DOMContentLoaded', () => {

        const dom = {};
        const state = {};

        function setupDOM() {
            // Main structure
            dom.appContainer = document.getElementById('app-container');
            dom.sidebar = document.getElementById('sidebar');
            dom.sidebarToggle = document.getElementById('sidebar-toggle');
            dom.sidebarClose = document.getElementById('sidebar-close');
            dom.chatContainer = document.getElementById('chat-container');
            dom.userInput = document.getElementById('user-input');
            dom.sendButton = document.getElementById('send-button');
            dom.micBtn = document.getElementById('mic-btn');
            
            // Sidebar
            dom.newChatBtn = document.getElementById('new-chat-btn');
            dom.conversationHistory = document.getElementById('conversation-history');
            dom.fullscreenBtn = document.getElementById('fullscreen-btn');
            dom.settingsButton = document.getElementById('settings-button');
            dom.themeToggle = document.getElementById('theme-toggle');
            dom.themeText = document.getElementById('theme-text');

            // Input area
            dom.imageUploadInput = document.getElementById('image-upload-input');
            dom.imagePreviewContainer = document.getElementById('image-preview-container');
            dom.stopGenerationContainer = document.getElementById('stop-generation-container');
            dom.stopGenerationBtn = document.getElementById('stop-generation-btn');
            
            // Modals & Toasts
            dom.modalBackdrop = document.getElementById('modal-backdrop');
            dom.toastContainer = document.getElementById('toast-container');
        }

        function initState() {
            state.apiKey = localStorage.getItem('chimera_apiKey') || '';
            state.conversations = JSON.parse(localStorage.getItem('chimera_conversations') || '{}');
            state.activeConversationId = localStorage.getItem('chimera_activeConversationId') || null;
            state.currentTheme = localStorage.getItem('chimera_theme') || 'dark';
            state.isGenerating = false;
            state.abortController = null;
            state.uploadedImage = null; // Base64 string of the uploaded image
            
            state.settings = { persona: 'default', customSystemPrompt: '' };
            const savedSettings = JSON.parse(localStorage.getItem('chimera_settings'));
            if (savedSettings) state.settings = { ...state.settings, ...savedSettings };

            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = window.SpeechRecognition ? new SpeechRecognition() : null;
            if (state.recognition) {
                state.recognition.continuous = false;
                state.recognition.lang = 'id-ID';
                state.recognition.interimResults = false;
            }
        }
        
        const personas = {
            default: "Anda adalah Asisten AI bernama Chimera. Jawab dalam Bahasa Indonesia. Anda canggih, ramah, dan terhubung ke internet. Gunakan format markdown yang kaya (tabel, list, blok kode, dll). Anda bisa menganalisis gambar, membuat diagram (gunakan sintaks mermaid), dan menampilkan rumus matematika (gunakan sintaks LaTeX `$$...$$` untuk block atau `$...$` untuk inline).",
            coder: "Anda adalah programmer ahli. Berikan jawaban yang jelas, efisien, dengan contoh kode. Jelaskan konsep kompleks secara sederhana. Gunakan pencarian untuk dokumentasi terbaru. Format kode dengan benar menggunakan markdown.",
            writer: "Anda adalah penulis kreatif. Gunakan bahasa yang kaya, kiasan, dan imajinatif. Gunakan pencarian untuk inspirasi.",
            scientist: "Anda adalah ilmuwan. Jelaskan topik ilmiah dengan akurat, objektif, dan analogi yang mudah dipahami. Prioritaskan data dari sumber terpercaya melalui pencarian."
        };

        // --- CORE APPLICATION LOGIC ---
        function init() {
            setupDOM();
            initState();
            lucide.createIcons();
            setupEventListeners();
            updateThemeUI();
            loadConversations();
            
            if (!state.activeConversationId || !state.conversations[state.activeConversationId]) {
                createNewConversation();
            } else {
                renderConversation(state.activeConversationId);
            }

            if (!state.apiKey) {
                showSettingsModal();
            }
            
            mermaid.initialize({ startOnLoad: false, theme: state.currentTheme });
        }
        
        // --- CONVERSATION MANAGEMENT ---
        function createNewConversation() {
            const newId = `chat_${Date.now()}`;
            const newTitle = `Percakapan Baru`;
            state.conversations[newId] = { id: newId, title: newTitle, history: [], date: new Date(), pinned: false };
            setActiveConversation(newId);
            saveAllData(); // Save new conversation
        }

        function setActiveConversation(id) {
            state.activeConversationId = id;
            localStorage.setItem('chimera_activeConversationId', id);
            renderConversation(id);
            loadConversations();
            if(window.innerWidth < 768) dom.sidebar.classList.add('-translate-x-full');
        }

        function renderConversation(id) {
            dom.chatContainer.innerHTML = '';
            const conversation = state.conversations[id];
            if (!conversation) return;
            
            if (conversation.history.length === 0) {
                 renderWelcomeScreen();
            } else {
                conversation.history.forEach(msg => {
                    if(msg.role === 'user') addMessage('user', msg.parts, false);
                    else if (msg.role === 'model') addMessage('model', [{ text: msg.parts[0].text }], false);
                });
            }
        }
        
        function loadConversations() {
            dom.conversationHistory.innerHTML = '';
            const sortedConversations = Object.values(state.conversations).sort((a, b) => {
                const pinA = a.pinned || false;
                const pinB = b.pinned || false;
                if (pinA !== pinB) return pinB - pinA; // Pinned chats first
                return new Date(b.date) - new Date(a.date); // Then sort by date
            });
            
            sortedConversations.forEach(conv => {
                const isActive = conv.id === state.activeConversationId;
                const convElement = document.createElement('div');
                convElement.className = `flex items-center justify-between p-2 rounded-lg cursor-pointer group transition-all duration-200 ${isActive ? 'bg-blue-600/30' : 'hover:bg-white/10'}`;
                convElement.dataset.id = conv.id;
                
                const pinIcon = conv.pinned ? `<i data-lucide="pin" class="w-4 h-4 inline-block mr-2 text-blue-400 flex-shrink-0"></i>` : '';
                
                convElement.innerHTML = `
                    <div class="flex items-center truncate flex-1">
                        ${pinIcon}
                        <span class="truncate">${conv.title}</span>
                    </div>
                    <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                        <button class="pin-chat-btn p-1 text-gray-400 hover:text-white" title="${conv.pinned ? 'Lepas Sematan' : 'Sematkan'}">
                            <i data-lucide="${conv.pinned ? 'pin-off' : 'pin'}" class="w-4 h-4"></i>
                        </button>
                        <button class="delete-chat-btn p-1 text-gray-400 hover:text-white" title="Hapus">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                convElement.addEventListener('click', (e) => {
                    const targetPin = e.target.closest('.pin-chat-btn');
                    const targetDelete = e.target.closest('.delete-chat-btn');

                    if (targetPin) {
                        e.stopPropagation();
                        conv.pinned = !conv.pinned;
                        saveAllData();
                        loadConversations();
                        return;
                    }
                    if (targetDelete) {
                        e.stopPropagation();
                        showCustomConfirm('Hapus percakapan?', `Anda yakin ingin menghapus "${conv.title}"? Aksi ini tidak dapat dibatalkan.`, () => {
                            const wasActive = state.activeConversationId === conv.id;
                            delete state.conversations[conv.id];
                            
                            if (wasActive) {
                                const remainingSorted = Object.values(state.conversations)
                                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                                
                                if (remainingSorted.length > 0) {
                                    setActiveConversation(remainingSorted[0].id);
                                } else {
                                    createNewConversation(); // This will save and load
                                    return;
                                }
                            }
                            saveAllData();
                            loadConversations();
                        });
                        return;
                    }
                    setActiveConversation(conv.id);
                });

                dom.conversationHistory.appendChild(convElement);
            });
            lucide.createIcons();
        }
        
        function saveAllData() {
            localStorage.setItem('chimera_conversations', JSON.stringify(state.conversations));
            localStorage.setItem('chimera_activeConversationId', state.activeConversationId);
            localStorage.setItem('chimera_settings', JSON.stringify(state.settings));
        }

        // --- UI & DOM MANIPULATION ---
        function renderWelcomeScreen() {
             const prompts = [
                { icon: 'code', text: 'Buatkan saya fungsi python untuk validasi email' },
                { icon: 'edit-3', text: 'Tulis email untuk bos saya tentang laporan mingguan' },
                { icon: 'brain-circuit', text: 'Jelaskan konsep Neural Network secara sederhana' },
                { icon: 'image', text: 'Berikan saya ide gambar untuk postingan media sosial' },
             ];
             dom.chatContainer.innerHTML = `
                 <div class="flex flex-col items-center justify-center h-full text-center fade-in">
                     <div class="max-w-2xl">
                         <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Project Chimera 2.2</h1>
                         <p class="mt-4 text-gray-400">Asisten AI canggih Anda. Terhubung ke web, mampu menganalisis gambar, membuat diagram, dan banyak lagi. Bagaimana saya bisa membantu Anda hari ini?</p>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-8">
                            ${prompts.map(p => `
                                <button class="prompt-starter-btn text-left p-4 border border-[var(--border-primary)] rounded-lg hover:bg-white/5 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="${p.icon}" class="w-5 h-5 text-gray-400"></i>
                                        <span class="font-medium">${p.text}</span>
                                    </div>
                                </button>
                            `).join('')}
                         </div>
                     </div>
                 </div>`;
            lucide.createIcons();
            document.querySelectorAll('.prompt-starter-btn').forEach(btn => {
                btn.onclick = () => {
                    dom.userInput.value = btn.querySelector('span').textContent;
                    sendMessageToAI();
                };
            });
        }

        function addMessage(sender, parts, animate = true) {
            const isUser = sender === 'user';
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex group ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `border p-4 rounded-xl max-w-3xl ${animate ? 'fade-in' : ''}`;
            bubble.style.borderColor = 'var(--border-primary)';
            
            if (isUser) {
                bubble.className += ' rounded-br-none bg-blue-600/10 text-[var(--text-primary)]';
            } else {
                bubble.className += ' rounded-bl-none bg-[var(--surface-primary)] text-[var(--text-primary)] relative';
            }
            
            const markdownContainer = document.createElement('div');
            markdownContainer.className = 'markdown-content';

            if (isUser) {
                 let contentHTML = '';
                 parts.forEach(part => {
                    if (part.text) contentHTML += `<p>${part.text.replace(/\n/g, '<br>')}</p>`;
                    if (part.inlineData) contentHTML += `<img src="data:${part.inlineData.mimeType};base64,${part.inlineData.data}" class="max-w-xs rounded-lg mt-2" alt="Uploaded content">`;
                 });
                 markdownContainer.innerHTML = contentHTML;
            } else {
                markdownContainer.innerHTML = parts[0].text;
            }

            bubble.appendChild(markdownContainer);
            
            if (!isUser) {
                const controls = document.createElement('div');
                controls.className = 'absolute -bottom-4 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                controls.innerHTML = `
                    <button class="copy-response-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" title="Salin"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    <button class="tts-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20" title="Dengarkan"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
                `;
                bubble.appendChild(controls);
            }

            messageWrapper.appendChild(bubble);
            dom.chatContainer.appendChild(messageWrapper);
            
            if (!isUser && parts[0].text !== '<div class="thinking-indicator"></div>') {
                 postProcessMessage(bubble);
            }
            
            dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
            lucide.createIcons();
            return bubble;
        }

        async function streamMessage(bubble, fullResponse) {
            const contentDiv = bubble.querySelector('.markdown-content');
            let displayedText = '';
            let buffer = '';
            const cursor = `<span class="typing-cursor"></span>`;
            
            const words = fullResponse.split(/(\s+|`|\*|_|=|\n)/);
            for (const word of words) {
                if (state.abortController && state.abortController.signal.aborted) break;
                buffer += word;
                // Update rendering more frequently for a smoother feel
                if (buffer.length > 5 || word.includes('\n')) {
                    displayedText += buffer;
                    contentDiv.innerHTML = marked.parse(displayedText + cursor);
                    buffer = '';
                    dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
                }
                await new Promise(resolve => setTimeout(resolve, 5)); // Faster delay
            }
            
            displayedText += buffer;
            contentDiv.innerHTML = marked.parse(displayedText); // Final render without cursor
            postProcessMessage(bubble);
        }
        
        function postProcessMessage(bubble) {
            renderMathInElement(bubble);
            highlightCodeInElement(bubble);
            renderMermaidDiagrams(bubble);
        }
        
        function updateThemeUI() {
            document.documentElement.className = state.currentTheme;
            const oldIcon = dom.themeToggle.querySelector('i') || dom.themeToggle.querySelector('svg');
            if (oldIcon) oldIcon.remove();

            const newIcon = document.createElement('i');
            if (state.currentTheme === 'dark') {
                dom.themeText.textContent = 'Mode Terang';
                newIcon.setAttribute('data-lucide', 'sun');
            } else {
                dom.themeText.textContent = 'Mode Gelap';
                newIcon.setAttribute('data-lucide', 'moon');
            }
            dom.themeToggle.insertBefore(newIcon, dom.themeText);
            lucide.createIcons();
        }

        function autoResizeTextarea() {
            const textarea = dom.userInput;
            textarea.style.height = 'auto';
            const maxHeight = 200; 
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = `${newHeight}px`;
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-600', error: 'bg-red-600', warning: 'bg-yellow-600'
            };
            toast.className = `flex items-center gap-3 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-4 opacity-0 transition-all duration-300`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i><span>${message}</span>`;
            
            dom.toastContainer.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 10);
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // --- MODAL SYSTEM ---
        function showModal(contentHTML) {
            dom.modalBackdrop.innerHTML = `<div class="bg-[var(--surface-primary)] border border-[var(--border-primary)] w-full max-w-2xl rounded-2xl shadow-2xl fade-in flex flex-col max-h-[90vh]">
                <div class="p-6 overflow-y-auto">${contentHTML}</div>
            </div>`;
            dom.modalBackdrop.classList.remove('hidden');
            dom.modalBackdrop.classList.remove('opacity-0');
        }

        function hideModal() {
            dom.modalBackdrop.classList.add('opacity-0');
            dom.modalBackdrop.addEventListener('transitionend', () => {
                dom.modalBackdrop.classList.add('hidden');
                dom.modalBackdrop.innerHTML = '';
            }, { once: true });
        }
        
        function showSettingsModal() {
            const content = `
                <h2 class="text-2xl font-bold mb-6">Pengaturan</h2>
                <div class="space-y-6">
                    <div>
                        <label for="api-key-settings-input" class="block text-sm font-medium text-gray-400 mb-1">Google AI API Key</label>
                        <input type="password" id="api-key-settings-input" placeholder="Masukkan API Key Anda" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500" value="${state.apiKey}">
                        <p class="text-xs text-gray-500 mt-1">Dapatkan kunci gratis dari <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline hover:text-blue-300">Google AI Studio</a>.</p>
                    </div>
                    <div>
                        <label for="persona-select" class="block text-sm font-medium text-gray-400 mb-1">Persona AI</label>
                        <select id="persona-select" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="default">Asisten Standar</option>
                            <option value="coder">Programmer Ahli</option>
                            <option value="writer">Penulis Kreatif</option>
                            <option value="scientist">Ilmuwan Penjelas</option>
                            <option value="custom">Kustom</option>
                        </select>
                    </div>
                    <div>
                        <label for="system-prompt-input" class="block text-sm font-medium text-gray-400 mb-1">System Prompt (Kustom)</label>
                        <textarea id="system-prompt-input" rows="4" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500" ${state.settings.persona !== 'custom' ? 'disabled' : ''}>${state.settings.customSystemPrompt}</textarea>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Manajemen Data</h3>
                        <div class="flex gap-2">
                           <button id="export-chat-btn" class="w-full py-2 bg-gray-500/20 border border-gray-500 text-gray-300 rounded-lg hover:bg-gray-500/40 transition-colors">Ekspor Chat (JSON)</button>
                           <button id="reset-all-settings-btn" class="w-full py-2 bg-red-600/20 border border-red-500 text-red-300 rounded-lg hover:bg-red-600/40 transition-colors">Reset Semua Pengaturan</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-8 space-x-3 pt-6 border-t border-[var(--border-primary)]">
                     <button id="close-settings-button" class="px-4 py-2 rounded-lg hover:bg-white/10 transition-colors">Tutup</button>
                     <button id="save-settings-button" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors font-semibold">Simpan</button>
                </div>
            `;
            showModal(content);
            document.getElementById('persona-select').value = state.settings.persona;
        }
        
        function showCustomConfirm(title, message, onConfirm) {
            const content = `
                <h2 class="text-xl font-bold mb-4">${title}</h2>
                <p class="text-gray-400 mb-6">${message}</p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel" class="px-4 py-2 rounded-lg hover:bg-white/10">Batal</button>
                    <button id="confirm-ok" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">Konfirmasi</button>
                </div>
            `;
            showModal(content);
            document.getElementById('confirm-ok').onclick = () => { onConfirm(); hideModal(); };
            document.getElementById('confirm-cancel').onclick = hideModal;
        }

        // --- UTILITIES ---
        function highlightCodeInElement(element) {
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                const pre = block.parentElement;
                if (pre.querySelector('.copy-code-btn')) return;
                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i>`;
                copyBtn.title = 'Salin kode';
                copyBtn.className = 'copy-code-btn absolute top-2 right-2 p-1.5 bg-black/30 rounded-md hover:bg-black/50 transition-colors';
                copyBtn.onclick = () => { navigator.clipboard.writeText(block.innerText); showToast('Kode disalin!'); };
                pre.style.position = 'relative';
                pre.appendChild(copyBtn);
            });
            lucide.createIcons();
        }

        function renderMathInElement(element) {
            const mathElements = element.querySelectorAll('p, li, td, th');
            mathElements.forEach(el => {
                let text = el.innerHTML;
                text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
                    try { return katex.renderToString(formula.trim(), { displayMode: true, throwOnError: false }); }
                    catch (e) { return `<span class="text-red-400">LaTeX Error</span>`; }
                });
                text = text.replace(/(?<!\\)\$([^\s][\s\S]*?[^\s])\$/g, (match, formula) => {
                     try { return katex.renderToString(formula.trim(), { throwOnError: false }); }
                     catch (e) { return `<span class="text-red-400">LaTeX Error</span>`; }
                });
                el.innerHTML = text;
            });
        }
        
        async function renderMermaidDiagrams(element) {
            const diagrams = element.querySelectorAll('pre > code.language-mermaid');
            for (const diagram of diagrams) {
                const pre = diagram.parentElement;
                const content = diagram.innerText;
                try {
                    const { svg } = await mermaid.render(`mermaid-${Date.now()}`, content);
                    pre.innerHTML = svg;
                } catch (error) {
                    pre.innerHTML = `<p class="text-red-400">Mermaid Diagram Error: ${error.message}</p>`;
                }
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                dom.appContainer.requestFullscreen().catch(err => {
                    showToast(`Gagal mode layar penuh: ${err.message}`, 'error');
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // --- CORE API LOGIC ---
        async function sendMessageToAI() {
            const userMessage = dom.userInput.value.trim();
            if (!userMessage && !state.uploadedImage) return;
            if (!state.apiKey) {
                showSettingsModal();
                showToast("Harap masukkan API Key Anda terlebih dahulu.", "error");
                return;
            }

            state.isGenerating = true;
            state.abortController = new AbortController();
            updateUIForGeneration(true);
            
            if (state.conversations[state.activeConversationId]?.history.length === 0) {
                 dom.chatContainer.innerHTML = ''; // Clear welcome message
            }

            let userParts = [];
            if (userMessage) userParts.push({ text: userMessage });
            if (state.uploadedImage) userParts.push({ inlineData: { mimeType: 'image/png', data: state.uploadedImage } });
            
            addMessage('user', userParts);
            
            const currentConv = state.conversations[state.activeConversationId];
            currentConv.history.push({ role: 'user', parts: userParts });
            
            if (currentConv.history.length === 1 && userMessage) {
                currentConv.title = userMessage.split(' ').slice(0, 5).join(' ');
                loadConversations();
            }
            saveAllData();
            
            dom.userInput.value = '';
            state.uploadedImage = null;
            dom.imagePreviewContainer.innerHTML = '';
            autoResizeTextarea();

            const modelBubble = addMessage('model', [{ text: '<div class="thinking-indicator"></div>' }]);

            try {
                const systemPromptText = state.settings.persona === 'custom' ? state.settings.customSystemPrompt : personas[state.settings.persona];
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: currentConv.history,
                    systemInstruction: { parts: [{ text: systemPromptText }] },
                    tools: [{ "google_search": {} }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: state.abortController.signal,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const readableError = errorData.error?.message || `API Error: ${response.status}. Periksa konsol untuk detail.`;
                    throw new Error(readableError);
                }
                
                const result = await response.json();
                const fullResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan atau tidak ada respons yang diterima.";

                await streamMessage(modelBubble, fullResponse);
                currentConv.history.push({ role: 'model', parts: [{ text: fullResponse }] });

            } catch (error) {
                let errorMessage;
                if (error.name === 'AbortError') {
                    errorMessage = "*(Generasi dihentikan oleh pengguna)*";
                } else {
                    errorMessage = `**Terjadi Kesalahan:**\n\`\`\`\n${error.message}\n\`\`\`\n\nPastikan API Key Anda benar dan koneksi internet stabil.`;
                    console.error("API Error:", error);
                }
                modelBubble.querySelector('.markdown-content').innerHTML = marked.parse(errorMessage);
            } finally {
                state.isGenerating = false;
                updateUIForGeneration(false);
                saveAllData();
            }
        }

        function updateUIForGeneration(isGenerating) {
            dom.sendButton.disabled = isGenerating;
            dom.stopGenerationContainer.classList.toggle('hidden', !isGenerating);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            dom.newChatBtn.addEventListener('click', createNewConversation);
            dom.sendButton.addEventListener('click', sendMessageToAI);
            dom.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessageToAI();
                }
            });
            dom.userInput.addEventListener('input', autoResizeTextarea);
            dom.sidebarToggle.addEventListener('click', () => dom.sidebar.classList.remove('-translate-x-full'));
            dom.sidebarClose.addEventListener('click', () => dom.sidebar.classList.add('-translate-x-full'));
            dom.themeToggle.addEventListener('click', () => {
                state.currentTheme = state.currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('chimera_theme', state.currentTheme);
                mermaid.initialize({ startOnLoad: false, theme: state.currentTheme });
                updateThemeUI();
            });
            dom.settingsButton.addEventListener('click', showSettingsModal);
            dom.fullscreenBtn.addEventListener('click', toggleFullscreen);

            // Robust fullscreen change handler (e.g., for ESC key)
            document.addEventListener('fullscreenchange', () => {
                if (document.fullscreenElement) {
                    dom.fullscreenBtn.innerHTML = `<i data-lucide="minimize"></i> Keluar Layar Penuh`;
                } else {
                    dom.fullscreenBtn.innerHTML = `<i data-lucide="maximize"></i> Layar Penuh`;
                }
                lucide.createIcons();
            });

            dom.imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    state.uploadedImage = await fileToBase64(file);
                    dom.imagePreviewContainer.innerHTML = `
                        <div class="relative fade-in">
                            <img src="${URL.createObjectURL(file)}" class="h-14 rounded-lg border border-[var(--border-primary)]">
                            <button id="remove-image-btn" class="absolute -top-1 -right-1 bg-red-600 rounded-full text-white p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>`;
                    lucide.createIcons();
                }
            });
            
            dom.stopGenerationBtn.addEventListener('click', () => {
                if (state.abortController) state.abortController.abort();
            });

            if (state.recognition) {
                dom.micBtn.addEventListener('click', () => {
                    try {
                        state.recognition.start();
                        dom.micBtn.classList.add('text-red-500', 'animate-pulse');
                    } catch (e) { showToast('Pengenalan suara sudah aktif.', 'error'); }
                });
                state.recognition.onresult = (event) => { dom.userInput.value += event.results[0][0].transcript; autoResizeTextarea(); };
                state.recognition.onend = () => dom.micBtn.classList.remove('text-red-500', 'animate-pulse');
                state.recognition.onerror = (event) => showToast(`Error pengenalan suara: ${event.error}`, 'error');
            } else {
                dom.micBtn.disabled = true;
                dom.micBtn.title = "Pengenalan suara tidak didukung di browser ini.";
            }

            // Delegated event listeners for dynamic content
            document.body.addEventListener('click', (e) => {
                const modalContent = e.target.closest('.w-full.max-w-2xl');
                if (!modalContent && !e.target.closest('#settings-button')) hideModal();
                if (e.target.id === 'close-settings-button') hideModal();
                if (e.target.id === 'save-settings-button') {
                    state.apiKey = document.getElementById('api-key-settings-input').value.trim();
                    state.settings.persona = document.getElementById('persona-select').value;
                    state.settings.customSystemPrompt = document.getElementById('system-prompt-input').value;
                    localStorage.setItem('chimera_apiKey', state.apiKey);
                    saveAllData();
                    hideModal();
                    showToast('Pengaturan disimpan!');
                }
                 if (e.target.closest('#persona-select')) {
                    const select = e.target.closest('#persona-select');
                    document.getElementById('system-prompt-input').disabled = select.value !== 'custom';
                }
                if (e.target.id === 'reset-all-settings-btn') {
                    showCustomConfirm('Reset Semua Pengaturan?', 'Aksi ini akan menghapus semua riwayat percakapan, API Key, dan pengaturan lainnya. Lanjutkan?', () => {
                        localStorage.clear();
                        initState();
                        hideModal();
                        showSettingsModal();
                        createNewConversation(); // Creates, saves, and loads
                        showToast('Semua data telah direset.', 'warning');
                    });
                }
                if (e.target.id === 'export-chat-btn') {
                    const data = JSON.stringify(state.conversations[state.activeConversationId], null, 2);
                    const blob = new Blob([data], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chimera-chat-${state.activeConversationId}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Percakapan diekspor!');
                }

                if (e.target.closest('#remove-image-btn')) {
                    state.uploadedImage = null;
                    dom.imageUploadInput.value = '';
                    dom.imagePreviewContainer.innerHTML = '';
                }

                const copyBtn = e.target.closest('.copy-response-btn');
                if (copyBtn) {
                    const textToCopy = copyBtn.closest('.fade-in').querySelector('.markdown-content').innerText;
                    navigator.clipboard.writeText(textToCopy);
                    showToast('Respons disalin!');
                }
                const ttsBtn = e.target.closest('.tts-btn');
                if (ttsBtn) {
                    speechSynthesis.cancel();
                    const textToSpeak = ttsBtn.closest('.fade-in').querySelector('.markdown-content').innerText;
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'id-ID';
                    speechSynthesis.speak(utterance);
                }
            });
        }

        // --- Let's Go! ---
        init();
    });
    </script>
</body>
</html>
