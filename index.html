<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Chimera v2.0 - Ultimate AI Assistant</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>

    <style>
        :root {
            --bg-dark: #0a0a0a; --bg-light: #f5f5f5;
            --surface-dark: #1a1a1a; --surface-light: #ffffff;
            --text-dark: #e5e5e5; --text-light: #0a0a0a;
            --border-dark: #2e2e2e; --border-light: #e5e5e5;
            --accent: #2563eb; --accent-hover: #1d4ed8;
            --font-body: 'Inter', sans-serif;
            --font-header: 'Orbitron', sans-serif;
        }
        html.dark {
            color-scheme: dark;
            --bg-primary: var(--bg-dark); --surface-primary: var(--surface-dark);
            --text-primary: var(--text-dark); --border-primary: var(--border-dark);
        }
        html.light {
            color-scheme: light;
            --bg-primary: var(--bg-light); --surface-primary: var(--surface-light);
            --text-primary: var(--text-light); --border-primary: var(--border-light);
        }
        body {
            font-family: var(--font-body); background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color 0.3s, color 0.3s;
        }
        h1, h2, h3 { font-family: var(--font-header); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(128, 128, 128, 0.3); border-radius: 10px; }
        .glass-effect {
            background: rgba(26, 26, 26, 0.6); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-primary);
        }
        html.light .glass-effect { background: rgba(255, 255, 255, 0.6); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .markdown-content table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .markdown-content th, .markdown-content td { border: 1px solid var(--border-primary); padding: 0.5rem; }
        .markdown-content th { background-color: var(--surface-primary); }
        .blinking-cursor { display: inline-block; width: 3px; height: 1.2em; background-color: var(--accent); animation: blink 1s step-end infinite; vertical-align: bottom; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="overflow-hidden">

    <div class="h-screen w-screen flex bg-cover bg-center" style="background-image: url('https://placehold.co/1920x1080/0a0a0a/1a1a1a?text=.');">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-black/20 h-full flex flex-col w-64 p-4 transition-all duration-300 -translate-x-full md:translate-x-0 md:relative absolute z-20">
            <button id="new-chat-btn" class="flex items-center justify-center gap-2 w-full p-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors">
                <i data-lucide="plus"></i> New Chat
            </button>
            <div id="conversation-history" class="mt-4 flex-1 overflow-y-auto pr-2"></div>
            <div class="pt-4 border-t border-[var(--border-primary)]">
                <button id="settings-button" class="flex items-center gap-2 w-full p-2 rounded-lg hover:bg-white/10 transition-colors"><i data-lucide="settings"></i> Pengaturan</button>
                <button id="theme-toggle" class="flex items-center gap-2 w-full p-2 rounded-lg hover:bg-white/10 transition-colors mt-2"><i data-lucide="sun"></i> <span id="theme-text">Mode Terang</span></button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full">
             <button id="sidebar-toggle" class="md:hidden absolute top-4 left-4 z-30 p-2 bg-black/30 rounded-md"><i data-lucide="menu"></i></button>
            <main class="flex-1 flex flex-col glass-effect m-2 md:m-4 rounded-xl overflow-hidden">
                <!-- Chat Area -->
                <div id="chat-container" class="flex-1 p-6 space-y-6 overflow-y-auto">
                    <!-- Welcome Message -->
                     <div class="flex justify-center text-center">
                         <div class="max-w-2xl">
                             <h1 class="text-4xl font-bold">Project Chimera 2.0</h1>
                             <p class="mt-2 text-gray-400">Asisten AI canggih Anda. Kini dengan dukungan gambar, matematika, diagram, dan pencarian web. Mulai dengan mengetik pesan, mengunggah gambar, atau menggunakan suara.</p>
                         </div>
                     </div>
                </div>

                <!-- Input Footer -->
                <footer class="p-4 border-t border-[var(--border-primary)] shrink-0 space-y-2">
                    <div id="stop-generation-container" class="text-center hidden">
                         <button id="stop-generation-btn" class="px-4 py-1 text-sm border border-yellow-500/50 text-yellow-300 rounded-lg hover:bg-yellow-500/20 transition-colors">Hentikan Generasi</button>
                    </div>
                    <div id="image-preview-container" class="flex gap-2 items-center"></div>
                    <div class="flex items-end gap-2">
                        <label for="image-upload-input" class="p-2.5 rounded-full hover:bg-white/10 cursor-pointer transition-colors"><i data-lucide="paperclip"></i></label>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                        
                        <div class="flex-1 relative">
                            <textarea id="user-input" placeholder="Ketik pesan atau unggah gambar..." class="w-full p-3 pl-4 pr-12 border border-[var(--border-primary)] rounded-2xl bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="1"></textarea>
                            <button id="mic-btn" class="absolute right-4 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-white"><i data-lucide="mic"></i></button>
                        </div>

                        <button type="submit" id="send-button" form="chat-form" class="bg-blue-600 text-white p-3 rounded-full shadow-lg transition transform hover:scale-105 active:scale-95 disabled:bg-gray-500 disabled:scale-100">
                            <i data-lucide="send"></i>
                        </button>
                    </div>
                </footer>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4"></div>
    <script>
    // ===================================================================================
    // Project Chimera v2.0 - Ultimate AI Assistant
    // Fitur: Image Vision, LaTeX Math, Mermaid Diagrams, Google Search, Voice Input, TTS
    // ===================================================================================
    document.addEventListener('DOMContentLoaded', () => {

        const dom = { /* All DOM elements will be dynamically selected here */ };
        const state = { /* All application state will be managed here */ };

        function setupDOM() {
            // Main structure
            dom.sidebar = document.getElementById('sidebar');
            dom.sidebarToggle = document.getElementById('sidebar-toggle');
            dom.chatContainer = document.getElementById('chat-container');
            dom.userInput = document.getElementById('user-input');
            dom.sendButton = document.getElementById('send-button');
            dom.micBtn = document.getElementById('mic-btn');
            
            // Sidebar
            dom.newChatBtn = document.getElementById('new-chat-btn');
            dom.conversationHistory = document.getElementById('conversation-history');
            
            // Header buttons (now in sidebar)
            dom.settingsButton = document.getElementById('settings-button');
            dom.themeToggle = document.getElementById('theme-toggle');
            dom.themeText = document.getElementById('theme-text');

            // Input area
            dom.imageUploadInput = document.getElementById('image-upload-input');
            dom.imagePreviewContainer = document.getElementById('image-preview-container');
            dom.stopGenerationContainer = document.getElementById('stop-generation-container');
            dom.stopGenerationBtn = document.getElementById('stop-generation-btn');
            
            // Modals
            dom.modalBackdrop = document.getElementById('modal-backdrop');
        }

        function initState() {
            state.apiKey = localStorage.getItem('chimera_apiKey') || '';
            state.conversations = JSON.parse(localStorage.getItem('chimera_conversations') || '{}');
            state.activeConversationId = localStorage.getItem('chimera_activeConversationId') || null;
            state.currentTheme = localStorage.getItem('chimera_theme') || 'dark';
            state.isGenerating = false;
            state.abortController = null;
            state.uploadedImage = null; // Base64 string of the uploaded image
            
            // AI Settings
            state.settings = {
                persona: 'default',
                customSystemPrompt: ''
            };
            const savedSettings = JSON.parse(localStorage.getItem('chimera_settings'));
            if (savedSettings) {
                state.settings = { ...state.settings, ...savedSettings };
            }

            // Speech Recognition
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = window.SpeechRecognition ? new SpeechRecognition() : null;
            if (state.recognition) {
                state.recognition.continuous = false;
                state.recognition.lang = 'id-ID';
                state.recognition.interimResults = false;
            }
        }
        
        const personas = {
            default: "Anda adalah Asisten AI bernama Chimera. Jawab dalam Bahasa Indonesia. Anda canggih, ramah, dan terhubung ke internet. Gunakan format markdown yang kaya (tabel, list, blok kode, dll). Anda bisa menganalisis gambar, membuat diagram (gunakan sintaks mermaid), dan menampilkan rumus matematika (gunakan sintaks LaTeX `$$...$$` untuk block atau `$...$` untuk inline).",
            coder: "Anda adalah programmer ahli. Berikan jawaban yang jelas, efisien, dengan contoh kode. Jelaskan konsep kompleks secara sederhana. Gunakan pencarian untuk dokumentasi terbaru. Format kode dengan benar menggunakan markdown.",
            writer: "Anda adalah penulis kreatif. Gunakan bahasa yang kaya, kiasan, dan imajinatif. Gunakan pencarian untuk inspirasi.",
            scientist: "Anda adalah ilmuwan. Jelaskan topik ilmiah dengan akurat, objektif, dan analogi yang mudah dipahami. Prioritaskan data dari sumber terpercaya melalui pencarian."
        };

        // --- CORE APPLICATION LOGIC ---
        function init() {
            setupDOM();
            initState();
            lucide.createIcons();
            setupEventListeners();
            updateThemeUI();
            loadConversations();
            
            if (!state.activeConversationId || !state.conversations[state.activeConversationId]) {
                createNewConversation();
            } else {
                renderConversation(state.activeConversationId);
            }

            if (!state.apiKey) {
                showSettingsModal();
            }
            
            mermaid.initialize({ startOnLoad: false, theme: state.currentTheme });
        }
        
        // --- CONVERSATION MANAGEMENT ---
        function createNewConversation() {
            const newId = `chat_${Date.now()}`;
            const newTitle = `Percakapan Baru`;
            state.conversations[newId] = { id: newId, title: newTitle, history: [], date: new Date() };
            setActiveConversation(newId);
        }

        function setActiveConversation(id) {
            state.activeConversationId = id;
            localStorage.setItem('chimera_activeConversationId', id);
            renderConversation(id);
            loadConversations(); // To update active styles
        }

        function renderConversation(id) {
            dom.chatContainer.innerHTML = '';
            const conversation = state.conversations[id];
            if (!conversation) return;
            
            if (conversation.history.length === 0) {
                 dom.chatContainer.innerHTML = `
                     <div class="flex justify-center text-center">
                         <div class="max-w-2xl">
                             <h1 class="text-4xl font-bold">Project Chimera 2.0</h1>
                             <p class="mt-2 text-gray-400">Asisten AI canggih Anda. Kini dengan dukungan gambar, matematika, diagram, dan pencarian web. Mulai dengan mengetik pesan, mengunggah gambar, atau menggunakan suara.</p>
                         </div>
                     </div>`;
                return;
            }
            conversation.history.forEach(msg => {
                if(msg.role === 'user') addMessage('user', msg.parts);
                else if (msg.role === 'model') addMessage('model', [{ text: msg.parts[0].text }]);
            });
        }
        
        function loadConversations() {
            dom.conversationHistory.innerHTML = '';
            const sortedConversations = Object.values(state.conversations).sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedConversations.forEach(conv => {
                const convElement = document.createElement('div');
                convElement.className = `flex items-center justify-between p-2 rounded-lg cursor-pointer group ${conv.id === state.activeConversationId ? 'bg-blue-600/30' : 'hover:bg-white/10'}`;
                convElement.dataset.id = conv.id;
                
                const titleSpan = document.createElement('span');
                titleSpan.textContent = conv.title;
                titleSpan.className = 'truncate flex-1';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                deleteBtn.className = 'opacity-0 group-hover:opacity-100 text-gray-400 hover:text-white';
                
                convElement.appendChild(titleSpan);
                convElement.appendChild(deleteBtn);
                
                convElement.addEventListener('click', (e) => {
                    if (e.target.closest('button') === deleteBtn) return;
                    setActiveConversation(conv.id);
                });
                
                deleteBtn.addEventListener('click', () => {
                    showCustomConfirm('Hapus percakapan ini?', `Anda yakin ingin menghapus "${conv.title}"? Aksi ini tidak dapat dibatalkan.`, () => {
                        delete state.conversations[conv.id];
                        if (state.activeConversationId === conv.id) {
                            const nextConv = Object.keys(state.conversations)[0];
                            if (nextConv) setActiveConversation(nextConv);
                            else createNewConversation();
                        }
                        saveAllData();
                        loadConversations();
                    });
                });

                dom.conversationHistory.appendChild(convElement);
            });
            lucide.createIcons();
        }
        
        function saveAllData() {
            localStorage.setItem('chimera_conversations', JSON.stringify(state.conversations));
            localStorage.setItem('chimera_activeConversationId', state.activeConversationId);
            localStorage.setItem('chimera_settings', JSON.stringify(state.settings));
        }

        // --- UI & DOM MANIPULATION ---
        function addMessage(sender, parts) {
            const isUser = sender === 'user';
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex group ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = 'border p-4 rounded-xl max-w-3xl fade-in';
            bubble.style.borderColor = 'var(--border-primary)';
            
            if (isUser) {
                bubble.className += ' rounded-br-none bg-blue-600/10 text-[var(--text-primary)]';
            } else {
                bubble.className += ' rounded-bl-none bg-[var(--surface-primary)] text-[var(--text-primary)] relative';
            }
            
            const markdownContainer = document.createElement('div');
            markdownContainer.className = 'markdown-content';

            if (isUser) {
                 let contentHTML = '';
                 parts.forEach(part => {
                    if (part.text) contentHTML += `<p>${part.text}</p>`;
                    if (part.inlineData) contentHTML += `<img src="data:${part.inlineData.mimeType};base64,${part.inlineData.data}" class="max-w-xs rounded-lg mt-2" alt="Uploaded content">`;
                 });
                 markdownContainer.innerHTML = contentHTML;
            } else {
                // For model, we start with a placeholder for streaming
                markdownContainer.innerHTML = parts[0].text;
            }

            bubble.appendChild(markdownContainer);
            
            if (!isUser) {
                const controls = document.createElement('div');
                controls.className = 'absolute -bottom-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity';
                controls.innerHTML = `
                    <button class="copy-response-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    <button class="tts-btn p-1.5 bg-[var(--surface-primary)] border border-[var(--border-primary)] rounded-md hover:bg-white/20"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
                `;
                bubble.appendChild(controls);
            }

            messageWrapper.appendChild(bubble);
            dom.chatContainer.appendChild(messageWrapper);
            
            if (!isUser) {
                 renderMathInElement(bubble);
                 highlightCodeInElement(bubble);
                 renderMermaidDiagrams(bubble);
            }
            
            dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
            lucide.createIcons();
            return bubble;
        }

        async function streamMessage(bubble, fullResponse) {
            const contentDiv = bubble.querySelector('.markdown-content');
            let displayedText = '';
            
            // Basic word-by-word streaming
            const words = fullResponse.split(' ');
            for (const word of words) {
                if (state.abortController.signal.aborted) break;
                displayedText += word + ' ';
                contentDiv.innerHTML = marked.parse(displayedText + '<span class="blinking-cursor"></span>');
                dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, 30)); // Adjust for speed
            }
            
            // Final render
            contentDiv.innerHTML = marked.parse(fullResponse);
            renderMathInElement(bubble);
            highlightCodeInElement(bubble);
            await renderMermaidDiagrams(bubble); // Mermaid rendering can be async
        }
        
        function updateThemeUI() {
            document.documentElement.className = state.currentTheme;

            // Remove the old icon (which could be an <i> or <svg>)
            const oldIcon = dom.themeToggle.querySelector('i') || dom.themeToggle.querySelector('svg');
            if (oldIcon) {
                oldIcon.remove();
            }
            
            // Create and add the new icon placeholder
            const newIcon = document.createElement('i');

            if (state.currentTheme === 'dark') {
                dom.themeText.textContent = 'Mode Terang';
                newIcon.setAttribute('data-lucide', 'sun');
            } else {
                dom.themeText.textContent = 'Mode Gelap';
                newIcon.setAttribute('data-lucide', 'moon');
            }

            // Insert the new <i> tag before the <span> text
            dom.themeToggle.insertBefore(newIcon, dom.themeText);
            
            lucide.createIcons();
        }

        function autoResizeTextarea() {
            const textarea = dom.userInput;
            textarea.style.height = 'auto';
            const maxHeight = 200; 
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = `${newHeight}px`;
        }
        
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container') || document.createElement('div');
            if (!toastContainer.id) {
                toastContainer.id = 'toast-container';
                toastContainer.className = 'fixed bottom-5 right-5 z-50';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            toast.className = `fade-in ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        // --- MODAL SYSTEM ---
        function showModal(contentHTML) {
            dom.modalBackdrop.innerHTML = `<div class="bg-[var(--surface-primary)] border border-[var(--border-primary)] w-full max-w-2xl p-6 rounded-xl shadow-2xl fade-in">${contentHTML}</div>`;
            dom.modalBackdrop.classList.remove('hidden');
        }

        function hideModal() {
            dom.modalBackdrop.classList.add('hidden');
            dom.modalBackdrop.innerHTML = '';
        }
        
        function showSettingsModal() {
            const content = `
                <h2 class="text-2xl font-bold mb-6">Pengaturan</h2>
                <div class="space-y-6">
                    <div>
                        <label for="api-key-settings-input" class="block text-sm font-medium text-gray-400 mb-1">Google AI API Key</label>
                        <input type="password" id="api-key-settings-input" placeholder="Masukkan API Key Anda" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500" value="${state.apiKey}">
                        <p class="text-xs text-gray-500 mt-1">Dapatkan kunci gratis dari <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">Google AI Studio</a>.</p>
                    </div>
                    <div>
                        <label for="persona-select" class="block text-sm font-medium text-gray-400 mb-1">Persona AI</label>
                        <select id="persona-select" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="default">Asisten Standar</option>
                            <option value="coder">Programmer Ahli</option>
                            <option value="writer">Penulis Kreatif</option>
                            <option value="scientist">Ilmuwan Penjelas</option>
                            <option value="custom">Kustom</option>
                        </select>
                    </div>
                    <div>
                        <label for="system-prompt-input" class="block text-sm font-medium text-gray-400 mb-1">System Prompt (Kustom)</label>
                        <textarea id="system-prompt-input" rows="4" class="w-full p-2 border border-[var(--border-primary)] rounded-lg bg-[var(--bg-primary)] focus:outline-none focus:ring-1 focus:ring-blue-500" ${state.settings.persona !== 'custom' ? 'disabled' : ''}>${state.settings.customSystemPrompt}</textarea>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Manajemen Data</h3>
                        <div class="flex gap-2">
                           <button id="export-chat-btn" class="w-full py-2 bg-gray-500/20 border border-gray-500 text-gray-300 rounded-lg hover:bg-gray-500/40 transition-colors">Ekspor Chat (JSON)</button>
                           <button id="reset-all-settings-btn" class="w-full py-2 bg-red-600/20 border border-red-500 text-red-300 rounded-lg hover:bg-red-600/40 transition-colors">Reset Semua Pengaturan</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-8 space-x-3">
                     <button id="close-settings-button" class="px-4 py-2 rounded-lg hover:bg-white/10 transition-colors">Tutup</button>
                     <button id="save-settings-button" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors font-semibold">Simpan Pengaturan</button>
                </div>
            `;
            showModal(content);
            document.getElementById('persona-select').value = state.settings.persona;
        }
        
        function showCustomConfirm(title, message, onConfirm) {
            const content = `
                <h2 class="text-xl font-bold mb-4">${title}</h2>
                <p class="text-gray-400 mb-6">${message}</p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel" class="px-4 py-2 rounded-lg hover:bg-white/10">Batal</button>
                    <button id="confirm-ok" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">Konfirmasi</button>
                </div>
            `;
            showModal(content);
            document.getElementById('confirm-ok').onclick = () => {
                onConfirm();
                hideModal();
            };
            document.getElementById('confirm-cancel').onclick = hideModal;
        }

        // --- UTILITIES ---
        function highlightCodeInElement(element) {
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                const pre = block.parentElement;
                if (pre.querySelector('.copy-code-btn')) return;
                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = `<i data-lucide="copy" class="w-4 h-4"></i>`;
                copyBtn.title = 'Salin kode';
                copyBtn.className = 'copy-code-btn absolute top-2 right-2 p-1.5 bg-black/30 rounded-md hover:bg-black/50 transition-colors';
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(block.innerText);
                    showToast('Kode disalin!');
                };
                pre.style.position = 'relative';
                pre.appendChild(copyBtn);
            });
            lucide.createIcons();
        }

        function renderMathInElement(element) {
            const mathElements = element.querySelectorAll('p, li, td, th');
            mathElements.forEach(el => {
                let text = el.innerHTML;
                // Block math $$...$$
                text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
                    try { return katex.renderToString(formula.trim(), { displayMode: true, throwOnError: false }); }
                    catch (e) { return `<span class="text-red-400">LaTeX Error</span>`; }
                });
                // Inline math $...$
                text = text.replace(/\$([^\s][\s\S]*?[^\s])\$/g, (match, formula) => {
                     try { return katex.renderToString(formula.trim(), { throwOnError: false }); }
                     catch (e) { return `<span class="text-red-400">LaTeX Error</span>`; }
                });
                el.innerHTML = text;
            });
        }
        
        async function renderMermaidDiagrams(element) {
            const diagrams = element.querySelectorAll('pre > code.language-mermaid');
            for (const diagram of diagrams) {
                const pre = diagram.parentElement;
                const content = diagram.innerText;
                try {
                    const { svg } = await mermaid.render(`mermaid-${Date.now()}`, content);
                    pre.innerHTML = svg;
                } catch (error) {
                    pre.innerHTML = `<p class="text-red-400">Mermaid Diagram Error: ${error.message}</p>`;
                }
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Get only base64 part
                reader.onerror = error => reject(error);
            });
        }
        
        // --- CORE API LOGIC ---
        async function sendMessageToAI() {
            const userMessage = dom.userInput.value.trim();
            if (!userMessage && !state.uploadedImage) return;

            state.isGenerating = true;
            state.abortController = new AbortController();
            updateUIForGeneration(true);

            let userParts = [];
            if (userMessage) userParts.push({ text: userMessage });
            if (state.uploadedImage) {
                userParts.push({ inlineData: { mimeType: 'image/png', data: state.uploadedImage } });
            }
            
            addMessage('user', userParts);
            
            const currentConv = state.conversations[state.activeConversationId];
            currentConv.history.push({ role: 'user', parts: userParts });
            
            // Auto-generate title for the first message
            if (currentConv.history.length === 1 && userMessage) {
                currentConv.title = userMessage.split(' ').slice(0, 4).join(' ');
                loadConversations();
            }
            
            saveAllData();
            
            // Reset input
            dom.userInput.value = '';
            state.uploadedImage = null;
            dom.imagePreviewContainer.innerHTML = '';
            autoResizeTextarea();

            const modelBubble = addMessage('model', [{ text: '<span class="blinking-cursor"></span>' }]);

            try {
                const systemPromptText = state.settings.persona === 'custom' ? state.settings.customSystemPrompt : personas[state.settings.persona];
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: currentConv.history,
                    systemInstruction: { parts: [{ text: systemPromptText }] },
                    tools: [{ "google_search": {} }],
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: state.abortController.signal,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API Error: ${response.status}`);
                }
                
                const result = await response.json();
                const fullResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan.";

                await streamMessage(modelBubble, fullResponse);
                
                currentConv.history.push({ role: 'model', parts: [{ text: fullResponse }] });

            } catch (error) {
                let errorMessage;
                if (error.name === 'AbortError') {
                    errorMessage = "*(Generasi dihentikan oleh pengguna)*";
                } else {
                    errorMessage = `**Terjadi Kesalahan:**\n\`\`\`\n${error.message}\n\`\`\`\n\nPastikan API Key Anda benar dan coba lagi.`;
                    console.error("API Error:", error);
                }
                modelBubble.querySelector('.markdown-content').innerHTML = marked.parse(errorMessage);
            } finally {
                state.isGenerating = false;
                updateUIForGeneration(false);
                saveAllData();
            }
        }

        function updateUIForGeneration(isGenerating) {
            dom.sendButton.disabled = isGenerating;
            dom.stopGenerationContainer.classList.toggle('hidden', !isGenerating);
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            dom.newChatBtn.addEventListener('click', createNewConversation);
            
            dom.sendButton.addEventListener('click', sendMessageToAI);
            dom.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessageToAI();
                }
            });
            dom.userInput.addEventListener('input', autoResizeTextarea);

            dom.sidebarToggle.addEventListener('click', () => {
                dom.sidebar.classList.toggle('-translate-x-full');
            });
            
            dom.themeToggle.addEventListener('click', () => {
                state.currentTheme = state.currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('chimera_theme', state.currentTheme);
                mermaid.initialize({ startOnLoad: false, theme: state.currentTheme });
                updateThemeUI();
            });
            
            dom.settingsButton.addEventListener('click', showSettingsModal);

            dom.imageUploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    state.uploadedImage = await fileToBase64(file);
                    dom.imagePreviewContainer.innerHTML = `
                        <div class="relative">
                            <img src="${URL.createObjectURL(file)}" class="h-14 rounded-lg">
                            <button id="remove-image-btn" class="absolute -top-1 -right-1 bg-red-600 rounded-full text-white p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>`;
                    lucide.createIcons();
                }
            });
            
            dom.stopGenerationBtn.addEventListener('click', () => {
                if (state.abortController) state.abortController.abort();
            });

            if (state.recognition) {
                dom.micBtn.addEventListener('click', () => {
                    try {
                        state.recognition.start();
                        dom.micBtn.classList.add('text-red-500', 'animate-pulse');
                    } catch (e) {
                        showToast('Pengenalan suara sudah aktif.', 'error');
                    }
                });
                state.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    dom.userInput.value += transcript;
                    autoResizeTextarea();
                };
                state.recognition.onend = () => {
                    dom.micBtn.classList.remove('text-red-500', 'animate-pulse');
                };
                state.recognition.onerror = (event) => {
                    showToast(`Error pengenalan suara: ${event.error}`, 'error');
                };
            } else {
                dom.micBtn.disabled = true;
                dom.micBtn.title = "Pengenalan suara tidak didukung di browser ini.";
            }

            // Delegated event listeners for dynamic content
            document.body.addEventListener('click', async (e) => {
                // Settings Modal
                if (e.target.id === 'close-settings-button') hideModal();
                if (e.target.id === 'save-settings-button') {
                    state.apiKey = document.getElementById('api-key-settings-input').value.trim();
                    state.settings.persona = document.getElementById('persona-select').value;
                    state.settings.customSystemPrompt = document.getElementById('system-prompt-input').value;
                    
                    localStorage.setItem('chimera_apiKey', state.apiKey);
                    saveAllData();
                    hideModal();
                    showToast('Pengaturan disimpan!');
                }
                 if (e.target.closest('#persona-select')) {
                    const select = e.target.closest('#persona-select');
                    document.getElementById('system-prompt-input').disabled = select.value !== 'custom';
                }
                if (e.target.id === 'reset-all-settings-btn') {
                    showCustomConfirm('Reset Semua Pengaturan?', 'Aksi ini akan menghapus semua riwayat percakapan, API Key, dan pengaturan lainnya. Lanjutkan?', () => {
                        localStorage.clear();
                        initState(); // Reset state
                        hideModal();
                        showSettingsModal();
                        loadConversations();
                        createNewConversation();
                        showToast('Semua data telah direset.', 'warning');
                    });
                }
                if (e.target.id === 'export-chat-btn') {
                    const data = JSON.stringify(state.conversations[state.activeConversationId], null, 2);
                    const blob = new Blob([data], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chimera-chat-${state.activeConversationId}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Percakapan diekspor!');
                }

                // Image preview
                if (e.target.closest('#remove-image-btn')) {
                    state.uploadedImage = null;
                    dom.imageUploadInput.value = ''; // Reset file input
                    dom.imagePreviewContainer.innerHTML = '';
                }

                // Message controls
                const copyBtn = e.target.closest('.copy-response-btn');
                if (copyBtn) {
                    const textToCopy = copyBtn.closest('.fade-in').querySelector('.markdown-content').innerText;
                    navigator.clipboard.writeText(textToCopy);
                    showToast('Respons disalin!');
                }
                const ttsBtn = e.target.closest('.tts-btn');
                if (ttsBtn) {
                    const textToSpeak = ttsBtn.closest('.fade-in').querySelector('.markdown-content').innerText;
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'id-ID';
                    speechSynthesis.speak(utterance);
                }
            });
        }

        // --- Let's Go! ---
        init();
    });
    </script>
</body>
</html>
